<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<!-- MOBILE prevent zooming with mobile native gestures and use our own -->
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
	<!-- MOBILE Remove tap highlight on Windows Phone -->
	<meta name="msapplication-tap-highlight" content="no" />

	<script src="/assets/lib/pixi/pixi.js"></script>
	<!-- purely for internet explorer. Though I think this issue is only in EI11,not in edge? -->
	<script src="/assets/lib/polyfills/es6StringPoly/es6StringPoly.js"></script>
	<script src="/assets/lib/hamsterjs/hamster.js"></script>
	<script src="/jspm_packages/system.js"></script>
	<script src="/config.js"></script>
</head>

<body>
  <div id="mapCanvasContainer" height="600" width="1200">
    <canvas id="mapCanvas" height="600" width="1200">
      Canvas not supported!
    </canvas>
  </div>

  <div id="testNotification" style="position:fixed; bottom:100px; left:50px;font-size: 20px;color:red;">
    WAIT FOR THE MODULES TO LOAD!
  </div>
  <div style="position:fixed; bottom:0px; left:0px;">
    <div style="display: inline-block;">
      <button id="testFullscreen">
        fullscreen
      </button>
    </div>
    <div style="display: inline-block;background-color: white;margin:0;">
      mapsize (pixels):
      <input id="hexaTiles" value="15000" type="text">,
      cache:
      <input id="cache" type="checkbox">
      <button id="changeValues" disabled>
        START!
      </button>
    </div>
  </div>

  <div id="dialog_select" style="display:none;">
    MODAL WINDOW
  </div>

  <script>
    (function () {
      /* global System */
      'use strict';

      // align top-left
      window.FPSElement = document.createElement("div");
      window.FPSElement.style.position = 'absolute';
      window.FPSElement.style.left = '0px';
      window.FPSElement.style.top = '0px';
      window.FPSElement.style.backgroundColor = 'white';

      document.body.appendChild( window.FPSElement );

		System.import('/tests/manual/stressTest.es6').then(function() {
			var mapsizeElement = document.getElementById("hexaTiles");
			var cacheElement = document.getElementById("cache");
			var currentMapSize, mapData;
			var cacheMap = true;

	        document.getElementById("testNotification").textContent = "START THE TESTS BY SELECTING VALUES BELOW AND CLICKING START!";
	        document.getElementById("changeValues").disabled = false;

	        document.getElementById("changeValues").addEventListener("click", function() {
				document.getElementById("testNotification").style.display = "none";
				currentMapSize = mapsizeElement.value;
				cacheMap = cacheElement.checked;

				mapData = window.getMapData(currentMapSize);
				window.mapReady = window.initMap(mapData, {
					mapsize: currentMapSize,
					cache: cacheMap,
					canvasContainer: document.getElementById("mapCanvasContainer"),
					trackFPSCB: function (data) {
  					var totalFPS = data.FPS;
  					var totalTime = data.FPStime;
  					var totalRenderTime = data.renderTime;
  					var drawCount = data.drawCount;
  					window.FPSElement.innerHTML = totalFPS + " - " + Math.round( ( totalRenderTime / totalTime * 100 ) ) + "%" + " : " + drawCount;
					}
          		});

                /* These are the actual automatic tests. They move the map to right edge and then back. Repeating it 5 times. Each time calculating the FPS. And you can take profiling during this, to get memory and CPU usages. */
                window.mapReady.promise.then(function (map) {
                    map.whenReady().then(() => {
                        window.setTimeout(perfTestLoop)
                    }).then(null, (e) => {
                        console.log(e);
                    });

                    var perfTestLoop = (function () {
                        var direction = 1;
                        var round = 0;
                        var quantifier = 2;

                        return function() {
                            map.moveMap({
                                x: direction === 1 ? -quantifier : quantifier,
                                y: direction === 1 ? -quantifier : quantifier
                            });

                            if (map.getMovableLayer().x > 500) {
                                round ++;
                                direction = 1;
                            } else if (map.getMovableLayer().x < - 7000) {
                                direction = 2;
                            }

                            if (round < 5) {
                                window.setTimeout(perfTestLoop);
                            }
                        }
                    })();
                })
        	});
  		});
    })();
	</script>
</body>
</html>
