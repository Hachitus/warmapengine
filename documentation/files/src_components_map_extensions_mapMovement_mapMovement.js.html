<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\components\map\extensions\mapMovement\mapMovement.js - FlaTWorld</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="FlaTWorld" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/baseEventlisteners.html">baseEventlisteners</a></li>
                                <li><a href="../classes/eventListeners.html">eventListeners</a></li>
                                <li><a href="../classes/generalUtils.polyfills.html">generalUtils.polyfills</a></li>
                                <li><a href="../classes/hexagonPlugin.ObjectHexaTerrain.html">hexagonPlugin.ObjectHexaTerrain</a></li>
                                <li><a href="../classes/hexagonPlugin.ObjectHexaUnit.html">hexagonPlugin.ObjectHexaUnit</a></li>
                                <li><a href="../classes/hexagonPlugin.setupHexagonClick.html">hexagonPlugin.setupHexagonClick</a></li>
                                <li><a href="../classes/hexagonPlugin.setupObject_select_hexagon.html">hexagonPlugin.setupObject_select_hexagon</a></li>
                                <li><a href="../classes/hexagonPlugin.utils.html">hexagonPlugin.utils</a></li>
                                <li><a href="../classes/log.html">log</a></li>
                                <li><a href="../classes/Map.html">Map</a></li>
                                <li><a href="../classes/MapDataManipulator.html">MapDataManipulator</a></li>
                                <li><a href="../classes/mapDrag.html">mapDrag</a></li>
                                <li><a href="../classes/mapEvents.html">mapEvents</a></li>
                                <li><a href="../classes/MapLayer.html">MapLayer</a></li>
                                <li><a href="../classes/MapLayerParent.html">MapLayerParent</a></li>
                                <li><a href="../classes/mapMovement.html">mapMovement</a></li>
                                <li><a href="../classes/MapSubcontainer.html">MapSubcontainer</a></li>
                                <li><a href="../classes/mapZoom.html">mapZoom</a></li>
                                <li><a href="../classes/Object_sprite.html">Object_sprite</a></li>
                                <li><a href="../classes/ObjectManager.html">ObjectManager</a></li>
                                <li><a href="../classes/ObjectSpriteTerrain.html">ObjectSpriteTerrain</a></li>
                                <li><a href="../classes/ObjectSpriteUnit.html">ObjectSpriteUnit</a></li>
                                <li><a href="../classes/Preload.html">Preload</a></li>
                                <li><a href="../classes/UI.html">UI</a></li>
                                <li><a href="../classes/UI_default.html">UI_default</a></li>
                                <li><a href="../classes/UI_templateBase.html">UI_templateBase</a></li>
                                <li><a href="../classes/utilities.arrays.html">utilities.arrays</a></li>
                                <li><a href="../classes/utilities.environmentDetections.html">utilities.environmentDetections</a></li>
                                <li><a href="../classes/utils.dataManipulation.html">utils.dataManipulation</a></li>
                                <li><a href="../classes/utils.effects.html">utils.effects</a></li>
                                <li><a href="../classes/utils.environment.html">utils.environment</a></li>
                                <li><a href="../classes/utils.general.html">utils.general</a></li>
                                <li><a href="../classes/utils.mouse.html">utils.mouse</a></li>
                                <li><a href="../classes/utils.Quadtree.html">utils.Quadtree</a></li>
                                <li><a href="../classes/utils.resize.html">utils.resize</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\components\map\extensions\mapMovement\mapMovement.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* global console */
&#x27;use strict&#x27;;

/*-----------------------
--------- IMPORT --------
-----------------------*/
import { mapEvents } from &#x27;bundles/coreBundle&#x27;;
import { arrays } from &#x27;components/utilities/general&#x27;;

/*-----------------------
------- VARIABLES -------
-----------------------*/
var viewportWorker = new Worker(&quot;/components/map/extensions/mapMovement/mapMovementWorker.js&quot;);

/*-----------------------
---------- API ----------
-----------------------*/
/* For debugging. This will show up if the plugin fails to load in Map.js */
export const mapMovement = setupMapMovement();

/*-----------------------
-------- PUBLIC ---------
-----------------------*/
/** This module manages visibility of the objects, based on are they visible to the player (on the canvas / webgl) or outside of it. This makes the map a lot faster and reliable resource-wise and lags otherwise. Requires subcontainers atm.
 *
 * @class mapMovement
 **/
function setupMapMovement () {
  const VIEWPORT_OFFSET = 0.15;
  const CHECK_INTERVAL = 20;
  var queue = {};
  var changedCoordinates = {
    width: 0,
    height: 0
  };

  return {
    init,
    pluginName: &quot;mapMovement&quot;,
    addAll,
    check,
    startEventListeners
  };
  /**
   * Ínitialize as a plugin
   *
   * @method init
   * @param  {Map} map     Instance of Map
   */
  function init(map) {
    addAll(map);
    startEventListeners(map);
    map.drawOnNextTick();
    /**
     * For debugging. Shows the amount of currectly active and inactive subcontainers. Console.logs the data. Also extends window object.
     *
     * @method window.FlaTWorld_mapMovement_subCheck
     * @static
     */
    window.FlaTWorld_mapMovement_subCheck = function() {
      map.getPrimaryLayers().forEach( layer =&gt; {
        var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());
        var visibleContainers, invisibleContainers;

        visibleContainers = subcontainers.filter(subcontainer =&gt; {
          return subcontainer.visible;
        });
        invisibleContainers = subcontainers.filter(subcontainer =&gt; {
          return !subcontainer.visible;
        });

        console.log(&quot;visible subcontainers: &quot; + visibleContainers.length + &quot;:&quot; +visibleContainers, &quot;\n\ninvisible: &quot; + invisibleContainers.length + &quot;:&quot; + invisibleContainers);
      });
    }
    /**
     * For debugging. Sets all primaryLayers subcontainers on the map as visible = true.
     *
     * @method window.FlaTWorld_mapMovement_deactivate
     * @static
     */
    window.FlaTWorld_mapMovement_deactivate = function() {
      map.getPrimaryLayers().forEach( layer =&gt; {
        var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());
        var visibleContainers, invisibleContainers;

        visibleContainers = subcontainers.forEach(subcontainer =&gt; {
          subcontainer.visible = false;
        });
      });
    }
  }
  /**
   * Ínitialize as a plugin
   *
   * @method addAll
   * @param  {Map} map     Instance of Map
   */
  function addAll(map) {
    var scale = map.getZoom();
    var viewportArea;

    viewportArea = map.getViewportArea();
    Object.assign( viewportArea, getViewportsRightSideCoordinates(viewportArea) );
    Object.assign( viewportArea , applyScaleToViewport(viewportArea, map.getZoom()) );

    map.getPrimaryLayers().forEach( layer =&gt; {
      var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());

      subcontainers.forEach(subcontainer =&gt; {
        subcontainer.visible = isObjectOutsideViewport(subcontainer, viewportArea, false, scale) ? false : true;
      });
    });
  }
  /**
   * This one checks the that the objects that should currently be visible in the viewport area are visible and outside
   * of the viewport objects are set .visible = false. This affect performance a lot. Basically when the map moves, we
   * set a check in the future based on the given intervalCheck milliseconds. And immediately after it we check if there
   * is another map movement. If there is we set another timeout. This works better with timeouts.
   *
   * This uses webWorkers. They seemed to speed up the check, when timing with performance.now.
   *
   * @method check
   * @param  {Map} map        The current Map instance
   * @return {Boolean}        True
   */
  function check(map) {
    if (queue.processing) {
      return false;
    }
    queue.processing = true;

    let viewportFn = setupHandleViewportArea(queue, map, changedCoordinates);
    window.setTimeout(viewportFn, CHECK_INTERVAL);

    function setupHandleViewportArea(queue, map, changedCoordinates) {
      var viewportArea = map.getViewportArea();

      if (window.Worker) {
        viewportWorker.onmessage = function(e) {
          const scale = map.getZoom();
          const scaledViewport = e.data[0];
          const smallerScaledViewport = e.data[1];
          var containersUnderChangedArea = [];
          var usesCache = map.isCacheActivated();
          var isOutside, scaledAndChangedViewport;

          scaledAndChangedViewport = Object.assign({}, scaledViewport);

          scaledAndChangedViewport.width += Math.round(Math.abs(changedCoordinates.width));
          scaledAndChangedViewport.height += Math.round(Math.abs(changedCoordinates.height));

          /* RESET */
          changedCoordinates.width = 0;
          changedCoordinates.height = 0;

          containersUnderChangedArea = map.getPrimaryLayers().map(layer =&gt; {
            return layer.getSubcontainersByCoordinates(scaledAndChangedViewport);
          });
          containersUnderChangedArea = arrays.flatten2Levels(containersUnderChangedArea);

          containersUnderChangedArea.forEach((thisContainer) =&gt; {
            isOutside = isObjectOutsideViewport(thisContainer, smallerScaledViewport, true, scale);

            if (isOutside) {
              thisContainer.visible = false;
            } else {
              thisContainer.visible = true;
            }

          });

          queue.processing = false;

          map.drawOnNextTick();

        };
        viewportWorker.postMessage([
          1,
          viewportArea,
          map.getZoom(),
          changedCoordinates
        ]);
      } else {
        queue.processing = false;
        throw new Error(&quot;ERROR WITH WEB WORKER&quot;);
      }
    }

    return;
  }
  /**
   * @method startEventListeners
   * @param  {Map} map     Instance of Map
   */
  function startEventListeners(map) {
    mapEvents.subscribe(&quot;mapMoved&quot;, moveCb);
    mapEvents.subscribe(&quot;mapResized&quot;, resizeCb);

    function moveCb(type) {
      var movedCoordinates = type.customData[0];

      changedCoordinates.width += movedCoordinates.x;
      changedCoordinates.height += movedCoordinates.y;
      mapMovement.check(map);
    }
    function resizeCb() {
      mapMovement.check(map);
    }
  }
  /*-----------------------
  -------- PRIVATE --------
  -----------------------*/
  /**
   * @private
   * @static
   * @method isObjectOutsideViewport
   * @param  {Object}  object                 Object / layer we are testing
   * @param  {Object} viewportArea            ViewportArea location and size
   * @param  {Integer} viewportArea.x         X coordinate
   * @param  {Integer} viewportArea.y         Y coordinate
   * @param  {Integer} viewportArea.width     Viewports width (in pixels)
   * @param  {Integer} viewportArea.height    Viewports height (in pixels)
   * @param  {Boolean} hasParent              default = true
   * @param  {Number}  scale                  default = 1 (equals to no defaul scale / no scale)
   * @return {Boolean}
   */
  function isObjectOutsideViewport(object, viewportArea, hasParent = true, scale = 1) {
    var isIt, globalCoords;

    globalCoords = object.getSubcontainerArea(scale, { toGlobal: hasParent });

    isIt = !testRectangleIntersect(globalCoords, viewportArea);

    return isIt;
  }
  /**
   * @private
   * @static
   * @method getViewportsRightSideCoordinates
   * @private
   * @param  {Object} viewportArea            ViewportArea location and size
   * @param  {Integer} viewportArea.x         X coordinate
   * @param  {Integer} viewportArea.y         Y coordinate
   * @param  {Integer} viewportArea.width     Viewports width (in pixels)
   * @param  {Integer} viewportArea.height    Viewports height (in pixels)
   */
  function getViewportsRightSideCoordinates(viewportArea) {
    const offsetSize = Math.abs( viewportArea.width * VIEWPORT_OFFSET * 2 );

    return {
      x2: Math.round( viewportArea.x + Math.abs( viewportArea.width ) + offsetSize ),
      y2: Math.round( viewportArea.y + Math.abs( viewportArea.height ) + offsetSize ),
      width: Math.round( viewportArea.width + offsetSize ),
      height: Math.round( viewportArea.height + offsetSize )
    };
  }
  /**
   * Calculates and modifies coordinates and size according to current scale / zoom on the map.
   *
   * @private
   * @static
   * @method applyScaleToViewport
   * @private
   * @param  {Object} viewportArea            ViewportArea location and size
   * @param  {Integer} viewportArea.x         X coordinate
   * @param  {Integer} viewportArea.y         Y coordinate
   * @param  {Integer} viewportArea.width     Viewports width (in pixels)
   * @param  {Integer} viewportArea.height    Viewports height (in pixels)
   * @param {Number} scale
   */
  function applyScaleToViewport(viewportArea, scale) {
    return {
      x: Math.round( viewportArea.x / scale ),
      y: Math.round( viewportArea.y / scale ),
      x2: Math.round( viewportArea.x2 / scale ),
      y2: Math.round( viewportArea.y2 / scale ),
      width: Math.round( viewportArea.width / scale ),
      height: Math.round( viewportArea.height / scale )
    };
  }
}
/*-----------------------
-------- PRIVATE --------
-----------------------*/
/**
 * @private
 * @static
 * @method testRectangleIntersect
 */
function testRectangleIntersect(a, b) {
  return (a.x &lt;= b.x + b.width &amp;&amp;
          b.x &lt;= a.x + a.width &amp;&amp;
          a.y &lt;= b.y + b.height &amp;&amp;
          b.y &lt;= a.y + a.height);
}
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
