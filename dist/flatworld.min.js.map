{"version":3,"sources":["init.js","polyfills.js","general.js","environment.js","log.js","Preload.js","dataManipulation.js","effects.js","utils.js","mapEvents.js","eventListeners.js","MapLayers.js","MapDataManipulator.js","UI.js","ObjectManager.js","Objects.js","Sound.js","UITemplateBase.js","baseEventlisteners.js","mapDrag.js","mapZoom.js","hexagonMath.js","createHexagon.js","select.js","selectHexagonPlugin.js","mapMovement.js","arrows.js","templates.js","default.js","Flatworld.js","horizontalHexaFactory.js"],"names":["window","flatworld_libararies","PIXI","Q","Hammer","hamster","Handlebars","loglevel","log","Howler","Howl","flatworld","generalUtils","objects","extensions","mapLayers","utils","factories","UIs","setupPolyfills","arrayFind","Array","prototype","find","predicate","this","TypeError","value","list","Object","length","thisArg","arguments","i","call","objectAssign","assign","target","undefined","output","index","source","nextKey","hasOwnProperty","es6String","String","repeat","defineProperty","object","$defineProperty","result","error","count","string","n","Number","Infinity","RangeError","configurable","writable","polyfills","setupArrays","flatten2Levels","arr","concat","apply","arrays","setupEnvironmentDetection","isMobile","screenSize","screen","width","matchMedia","matches","features","navigator","maxTouchPoints","msMaxTouchPoints","environmentDetection","enableAll","debug","e","errorText","_classCallCheck","instance","Constructor","_createClass","defineProperties","props","descriptor","enumerable","key","protoProps","staticProps","Preload","baseUrl","options","concurrency","crossOrigin","preloaderClass","loaders","Loader","promise","defer","load","once","loader","resources","resolve","resource","add","errorCB","on","progressCB","installPlugin","setupDataManipulation","mapObjectsToArray","keys","map","objGroup","flattenArrayBy1Level","merged","dataManipulation","setupEffects","dropShadow","color","distance","alpha","amg√∂e","blur","shadow","filters","DropShadowFilter","angle","effects","setupMouseUtils","isRightClick","event","rightclick","buttons","which","button","getPointerCoords","x","offsetX","y","offsetY","getHAMMERPointerCoords","center","eventMouseCoords","pos","pageX","pageY","clientX","clientY","document","body","scrollLeft","documentElement","scrollTop","eventData","setupResizeUtils","toggleFullScreen","cancelFullScreen","el","requestMethod","webkitCancelFullScreen","mozCancelFullScreen","exitFullscreen","ActiveXObject","wscript","SendKeys","requestFullScreen","webkitRequestFullScreen","mozRequestFullScreen","msRequestFullScreen","elem","isInFullScreen","fullScreenElement","mozFullScreen","webkitIsFullScreen","setToFullSize","context","size","getWindowSize","canvas","height","innerWidth","innerHeight","getPixelRatio","canvasElement","DPR","devicePixelRatio","ctx","getContext","createElement","bsr","webkitBackingStorePixelRatio","mozBackingStorePixelRatio","msBackingStorePixelRatio","oBackingStorePixelRatio","backingStorePixelRatio","setupGeneral","epsilonEquality","Math","abs","PIXEL_EPSILON","pixelEpsilonEquality","mouse","resize","general","setupMapEvents","subscribe","type","cb","addEventListener","lastTimePublished","publish","timestamp","Date","getTime","TIMER_FOR_SAME_TYPE","eventToDispatch","Event","_len","data","_key","customData","dispatchEvent","mapEvents","eventListenersModule","detectors","Error","_createEventListenerWrapper","activeEventListeners","Set","off","isOn","answer","has","setActivityState","newState","stateOfEvents","getActivityState","setDetector","cbOn","cbOff","clearDetector","forEach","eventListeners","_possibleConstructorReturn","self","ReferenceError","_inherits","subClass","superClass","create","constructor","setPrototypeOf","__proto__","_get","get","property","receiver","Function","desc","getOwnPropertyDescriptor","parent","getPrototypeOf","getter","setCorrectSubcontainer","displayObject","parentLayer","thisSubcontainer","subcontainersConfig","subcontainerList","xIndex","floor","yIndex","MapSubcontainer","visible","isHiddenByDefault","addChild","getClosestSubcontainers","layer","givenCoordinates","filter","coordinates","_layer$getSubcontaine","getSubcontainerConfigs","allFoundSubcontainers","x2","y2","widthIndex","heightIndex","thisXIndex","thisYIndex","filterSubcontainers","push","_UIObjects","MapLayer","_PIXI$Container","name","coord","specialLayer","selectable","_this","cacheAsBitmap","drawThisChild","amount","scale","toFixed","_this2","obj","getUILayer","removeChild","children","thisChild","allObjects","hasSubcontainers","subcontainer","status","toCacheStatus","UILayer","createUILayer","Container","MapLayerParent","_MapLayer","subcontainers","_this3","oldAddChild","bind","correctContainer","foundSubcontainers","tempCoordinates","toLocal","Point","_PIXI$Container2","_this4","toGlobal","round","MapDataManipulator","rules","isArray","layerClasses","_runRules","foundObjects","rule","_getContainer","_getObject","UI","UITheme","givenMap","scope","showSelections","getDatas","filterObjectsForHighlighting","highlightSelectedObject","showUnitMovement","from","to","newObjects","highlightable","ObjectManager","hitDetector","allCoords","globalCoords","foundObjs","localCoords","container","isHit","hitTest","ObjectSprite","_PIXI$Sprite","currentFrame","exactCoords","position","set","id","areaWidth","areaHeight","fromFrame","newFrame","innerDraw","targetLocalCoords","renderer","anchor","newSprite","Sprite","texture","generateTexture","ObjectSpriteTerrain","_ObjectSprite","coords","ObjectSpriteUnit","_ObjectSprite2","actions","move","attack","action","_utils$effects","Sound","_allSounds","url","loop","volume","urls","autoplay","_onend","play","stop","duration","fade","styleSheetElement","allCSSClasses","UITemplateBase","CSSClasses","addStyleElement","createdCSS","select","addCSSRulesToScriptTag","sheet","insertRule","_styleElement","appendChild","createTextNode","head","modalElem","cssClasses","classList","baseEventlistenersModule","init","hammer","Manager","Hamster","toggleFullSize","toggleFullscreen","toggleZoom","toggleDrag","toggleSelect","setPrototype","boundResizer","_resizeCanvas","_setFullScreen","removeEventListener","pinch","Pinch","wheel","unwheel","pan","Pan","pointers","threshold","direction","DIRECTION_ALL","tap","Tap","pluginName","baseEventlisteners","setupMap_drag","eventListenerCB","_startDragListener","initialized","mapMoved","isFinal","_mapMovement","offsetCoords","setOffset","offset","moved","getOffset","moveMap","preventDefault","_offsetCoords","mapDrag","setupMap_zoom","thisMap","zoomIn","zoomOut","setZoomLimits","setZoomModifier","unifiedEventCB","zoomModifier","farther","closer","zoomLimit","presentScale","getZoom","IS_ZOOM_IN","_zoom","delta","deltaX","deltaY","handleZoomEventDesktop","mobileInitialized","handleZoomEventMobile","mouseWheelDelta","oldScale","_calculateCenterMoveCoordinates","changeX","changeY","difference","eventType","setTimeout","TIMEOUT_AFTER_ZOOM","ev","console","_isOverZoomLimit","isZoomIn","windowSize","halfWindowSize","realMovement","newScale","setZoom","mapZoom","hexagons","eventlisteners","calcShortDiagonal","precision","sqrt","calcLongDiagonal","hexaHitTest","points","realPolygonPoints","hitCoords","point","pointInPolygon","vs","xi","xj","yi","yj","intersect","inside","j","createHexagon","radius","isFlatTop","coordsToPixiPoints","Polygon","createVisibleHexagon","graphics","Graphics","beginFill","drawPolygon","endFill","getHexagonPoints","OFFSET","CENTER","PI","cos","sin","_setupHexagonClick","tapListener","getData","allData","typeData","getObjectsUnderArea","ui","drawOnNextTick","setupHexagonClick","calculateHexa","HEIGHT","WIDTH","SIDE","ROW_HEIGHT","hitArea","setAndGetShape","updateTransform","processInteractive","shape","_window$flatworld$obj","_window$flatworld$ext","ObjectHexaTerrain","_ObjectSpriteTerrain","ObjectHexaUnit","_ObjectSpriteUnit","setupObject_select_hexagon","startClickListener","selectHexagonObject","setupMapMovement","currentScale","addAll","startEventListeners","FlaTWorld_mapMovement_subCheck","getPrimaryLayers","visibleContainers","invisibleContainers","getSubcontainers","FlaTWorld_mapMovement_deactivate","viewportArea","getViewportArea","getViewportsRightSideCoordinates","applyScaleToViewport","isObjectOutsideViewport","check","setupHandleViewportArea","queue","changedCoordinates","smallerViewportArea","scaledViewport","smallerScaledViewportArea","getViewportCoordinates","viewportWorkerOnMessage","processing","viewportFn","CHECK_INTERVAL","moveCb","movedCoordinates","resizeCb","zoomCb","isIt","hasParent","getSubcontainerArea","testRectangleIntersect","offsetSize","VIEWPORT_OFFSET","smallerScaledViewport","scaledAndChangedViewport","containersUnderChangedArea","getSubcontainersByCoordinates","thisContainer","offsetQuantifier","a","b","Worker","mapMovement","layout","drawShapes","drawArrow","x1","y1","style","d","drawHead","x0","y0","backdist","beginStroke","moveTo","lineTo","arcTo","fill","cpx","cpy","quadraticCurveTo","cp1x","cp1y","cp2x","cp2y","shiftamt","xback","yback","xmid","ymid","m","dx","dy","bezierCurveTo","angle1","topx","topy","angle2","botx","boty","parseInt","tox","toy","fromx","fromy","toDrawHead","dist","ratio","lineangle","atan2","h","drawArcedArrow","r","startangle","endangle","anticlockwise","sx","sy","destx","desty","beginPath","arc","stroke","strokeStyle","normal","arced","templates","multiSelection","compile","singleSelection","_get$Element","$elements","$element","$","FADE_ANIMATION","UIDefault","_UITemplateBase","modal","styles","getElementById","updateCB","getMovableLayer","innerHTML","title","showModal","fadeIn","emptyUIObjects","fadeOut","highlightableObject","objectDatas","_highlightSelectedObject","getRenderer","clonedObject","movableLayer","clone","createHighlight","highlighterObject","createSpecialLayer","toLayer","objCoords","removeUIObject","layerTypes","movableType","addUIObjects","_typeof","Symbol","iterator","cacheLayers","cacheOrNot","_movableLayer","child","isCached","setCache","_staticLayer","_renderer","ParentLayerConstructor","Objects","LAYER_TYPE_STATIC","LAYER_TYPE_MOVABLE","VERSION","_drawMapOnNextTick","isMapReadyPromises","Flatworld","canvasContainer","bounds","rendererOptions","refreshEventListeners","cache","trackFPSCB","querySelector","autoDetectRenderer","plugins","interaction","destroy","view","display","left","top","getElementsByTagName","overflow","roundPixels","objectManager","InteractionManager","staticType","tickCB","fullsize","allPromises","toggleFullsize","activatePlugins","_defaultTick","customTickOn","cacheMap","Promise","all","layerType","getStaticLayer","addUIObject","layerOptions","newLayer","isLocal","informCoordinates","realCoordinates","usesSubcontainers","pluginsArray","plugin","activatePlugin","JSON","stringify","thisPrototype","selectableContainerfilter","addRule","allMatchingSubcontainers","_getSubcontainersUnderArea","_retrieveObjects","previousScale","getZoomLayer","retrieve","attribute","thisLayersSubcontainers","primaryLayers","autoResize","renderStart","totalRenderTime","ONE_SECOND","FPSCount","fpsTimer","ticker","shared","render","FPS","FPStime","renderTime","drawCount","hexaFactory","canvasContainerElement","datas","dialog_selection","defaultUI","pixelRatio","DATA_MAP","parse","DATA_TYPE","DATA_GAME","game","WINDOW_SIZE","mapOptions","mapSize","functionsInObj","ObjectTerrain","hexagonPlugin","ObjectUnit","mapProperties","resolution","transparent","antialias","maxDetectionOffset","layers","layerData","thisLayer","group","drawOutsideViewport","addLayer","objectGroups","objectGroup","spritesheetType","typeImageData","objTypeData","objData","objectOptions","newObject","objectData","objType","activeData","Texture","image","hexagonRadius","stack","startPoint"],"mappings":"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","file":"flatworld.min.js","sourcesContent":["window.flatworld.UIs = window.flatworld.UIs || {};\r\nwindow.flatworld.UIs.default = {};\r\nwindow.flatworld.UIs.default.utils = {};\r\nwindow.flatworld.UIs.default.layout = {};","(function () {\r\n  /* jshint ignore:start */\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.generalUtils.polyfills = setupPolyfills();\r\n\r\n  /*-----------------------\r\n  -------- PUBLIC ---------\r\n  -----------------------*/\r\n  /**\r\n   * Add polyfills for the map, as necessary. Easy to drop out.\r\n   *\r\n   * @class generalUtils.polyfills\r\n   * @return {Object} arrayFind, objectAssign\r\n   */\r\n  function setupPolyfills() {\r\n    return {\r\n      arrayFind,\r\n      objectAssign,\r\n      es6String\r\n    };\r\n\r\n    /**\r\n     * @static\r\n     * @method arrayFind\r\n     */\r\n    function arrayFind() {\r\n      if (!Array.prototype.find) {\r\n        Array.prototype.find = function(predicate) {\r\n          if (this === null) {\r\n            throw new TypeError('Array.prototype.find called on null or undefined');\r\n          }\r\n          if (typeof predicate !== 'function') {\r\n            throw new TypeError('predicate must be a function');\r\n          }\r\n          var list = Object(this);\r\n          var length = list.length >>> 0;\r\n          var thisArg = arguments[1];\r\n          var value;\r\n\r\n          for (var i = 0; i < length; i++) {\r\n            value = list[i];\r\n            if (predicate.call(thisArg, value, i, list)) {\r\n              return value;\r\n            }\r\n          }\r\n          return undefined;\r\n        };\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Object.assign IE11 polyfill. Credits to Mozillas folk:\r\n     * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\r\n     *\r\n     * @method objectAssign\r\n     * @static\r\n     */\r\n    function objectAssign() {\r\n      if (typeof Object.assign != 'function') {\r\n        (function () {\r\n          Object.assign = function (target) {\r\n            if (target === undefined || target === null) {\r\n              throw new TypeError('Cannot convert undefined or null to object');\r\n            }\r\n\r\n            var output = Object(target);\r\n            for (var index = 1; index < arguments.length; index++) {\r\n              var source = arguments[index];\r\n              if (source !== undefined && source !== null) {\r\n                for (var nextKey in source) {\r\n                  if (source.hasOwnProperty(nextKey)) {\r\n                    output[nextKey] = source[nextKey];\r\n                  }\r\n                }\r\n              }\r\n            }\r\n            return output;\r\n          };\r\n        })();\r\n      }\r\n    }\r\n    // purely for internet explorer. Though I think this issue is only in EI11,not in edge?\r\n    function es6String() {\r\n      /*! https://mths.be/repeat v0.2.0 by @mathias */\r\n      if (!String.prototype.repeat) {\r\n        (function() {\r\n          'use strict'; // needed to support `apply`/`call` with `undefined`/`null`\r\n          var defineProperty = (function() {\r\n            // IE 8 only supports `Object.defineProperty` on DOM elements\r\n            try {\r\n              var object = {};\r\n              var $defineProperty = Object.defineProperty;\r\n              var result = $defineProperty(object, object, object) && $defineProperty;\r\n            } catch (error) {}\r\n            return result;\r\n          }());\r\n          var repeat = function(count) {\r\n            if (this == null) {\r\n              throw TypeError();\r\n            }\r\n            var string = String(this);\r\n            // `ToInteger`\r\n            var n = count ? Number(count) : 0;\r\n            if (n != n) { // better `isNaN`\r\n              n = 0;\r\n            }\r\n            // Account for out-of-bounds indices\r\n            if (n < 0 || n == Infinity) {\r\n              throw RangeError();\r\n            }\r\n            var result = '';\r\n            while (n) {\r\n              if (n % 2 == 1) {\r\n                result += string;\r\n              }\r\n              if (n > 1) {\r\n                string += string;\r\n              }\r\n              n >>= 1;\r\n            }\r\n            return result;\r\n          };\r\n          if (defineProperty) {\r\n            defineProperty(String.prototype, 'repeat', {\r\n              value: repeat,\r\n              configurable: true,\r\n              writable: true\r\n            });\r\n          } else {\r\n            String.prototype.repeat = repeat;\r\n          }\r\n        }());\r\n      }\r\n    }\r\n  }\r\n  /* jshint ignore:end */\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.generalUtils.arrays = setupArrays();\r\n\r\n  /*-----------------------\r\n  --------- PUBLIC --------\r\n  -----------------------*/\r\n  /**\r\n   * Array manipulation\r\n   *\r\n   * @class utilities.arrays\r\n   */\r\n  function setupArrays() {\r\n    return {\r\n      flatten2Levels\r\n    };\r\n\r\n    /**\r\n     * Flattern 2 levels deep, 2-dimensional arrays. Credits: http://stackoverflow.com/a/15030117/1523545\r\n     *\r\n     * @method flatten2Levels\r\n     * @param  {Array} arr        Array to flatten\r\n     * @return {Array}            Flattened array\r\n     */\r\n    function flatten2Levels(arr) {\r\n      return [].concat.apply([], arr);\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.generalUtils.environmentDetection = setupEnvironmentDetection();\r\n\r\n  /*-----------------------\r\n  --------- PUBLIC --------\r\n  -----------------------*/\r\n  /**\r\n   * @class utilities.environmentDetections\r\n   * @return {Object}                         Holds methods in this class\r\n   */\r\n  function setupEnvironmentDetection() {\r\n    return {\r\n      isMobile\r\n    };\r\n\r\n    /**\r\n     * Detect mobile environment\r\n     *\r\n     * @method isMobile\r\n     * @return {Boolean}\r\n     */\r\n    function isMobile() {\r\n      var screenSize = (screen.width <= 640) || (window.matchMedia && window.matchMedia('only screen and (max-width: 640px)').matches );\r\n      var features = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);\r\n\r\n      return features && screenSize;\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  var loglevel = window.flatworld_libararies.loglevel;\r\n\r\n  loglevel.enableAll();\r\n  /**\r\n   * @class log\r\n   * @requires loglevel.js for frontend logging, or something similar\r\n   **/\r\n  window.flatworld.log = {\r\n    debug: function(e, errorText) {\r\n      loglevel.debug(errorText, e);\r\n    }\r\n  };\r\n})();","(function () {\r\n  \"use strict\";\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var Q = window.flatworld_libararies.Q;\r\n  var PIXI = window.flatworld_libararies.PIXI;\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  class Preload {\r\n    /**\r\n     * Preloads assets before initializing map.\r\n     *\r\n     * @class Preload\r\n     * @constructor\r\n     * @requires Q for promises\r\n     * @todo should you use PIXI here or just https://github.com/englercj/resource-loader straight?\r\n     */\r\n    constructor (baseUrl, options = { concurrency: 15, crossOrigin: false }) {\r\n      var { concurrency } = options;\r\n\r\n      this.preloaderClass = new PIXI.loaders.Loader(baseUrl, concurrency);\r\n    }\r\n    /**\r\n     * @method resolveOnComplete\r\n     * @return {Promise} Return promise object, that will be resolved when the preloading is finished\r\n     **/\r\n    resolveOnComplete () {\r\n      var promise = Q.defer();\r\n\r\n      this.preloaderClass.load();\r\n\r\n      this.preloaderClass.once('complete', function(loader, resources) {\r\n        promise.resolve(loader, resources);\r\n      });\r\n\r\n      return promise.promise;\r\n    }\r\n    /**\r\n     * @method addResource\r\n     **/\r\n    addResource (resource) {\r\n      this.preloaderClass.add(resource);\r\n    }\r\n    /**\r\n     * Preload assets\r\n     *\r\n     * @method loadManifest\r\n     **/\r\n    loadManifest () {\r\n      return this;\r\n    }\r\n    /**\r\n     * Error handler if something goes wrong when preloading\r\n     *\r\n     * @method setErrorHandler\r\n     **/\r\n    setErrorHandler (errorCB) {\r\n      this.preloaderClass.on(\"error\", errorCB);\r\n\r\n      return this;\r\n    }\r\n    /**\r\n     * Progress handler for loading. You should look easeljs docs for more information\r\n     *\r\n     * @method setProgressHandler\r\n     **/\r\n    setProgressHandler (progressCB) {\r\n      this.preloaderClass.on(\"error\", progressCB);\r\n\r\n      return this;\r\n    }\r\n    /**\r\n     * Activate sound preloading also\r\n     *\r\n     * @method activateSound\r\n     **/\r\n    activateSound () {\r\n      this.preloaderClass.installPlugin();\r\n    }\r\n  }\r\n\r\n  window.flatworld.Preload = Preload;\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.utils.dataManipulation = setupDataManipulation();\r\n\r\n  /*---------------------\r\n  -------- PUBLIC -------\r\n  ----------------------*/\r\n  /**\r\n   * These are utils for manipulating the data, that our classes and functions use.\r\n   *\r\n   * @class utils.dataManipulation\r\n   * @return {Object}      mapObjectsToArray, flattenArrayBy1Level\r\n   */\r\n  function setupDataManipulation() {\r\n    /*---------------------\r\n    ------- API ----------\r\n    --------------------*/\r\n    return {\r\n      mapObjectsToArray,\r\n      flattenArrayBy1Level\r\n    };\r\n\r\n    /*----------------------\r\n    ------- PUBLIC ---------\r\n    ----------------------*/\r\n    /**\r\n     * Changes the data from e.g. getting objects from the map based on coordinate. The data is like this normally:\r\n     * {\r\n     *   units: [{\r\n     *     {... the objects datas ...}\r\n     *   }]\r\n     * }\r\n     * We change it to this:\r\n     * [\r\n     *   [{\r\n     *     {... the objects datas ...}\r\n     *   }]\r\n     * ]\r\n     *\r\n     * @method mapObjectsToArray\r\n     * @param  {Object} objects       Object that holds objects\r\n     * @return {Array}                Returns the transformed array\r\n     */\r\n    function mapObjectsToArray(objects) {\r\n      return Object.keys(objects).map(objGroup => {\r\n        return objects[objGroup];\r\n      });\r\n    }\r\n    /**\r\n     * @method flattenArrayBy1Level\r\n     * @param  {Array} objects\r\n     */\r\n    function flattenArrayBy1Level(objects) {\r\n      let merged = [];\r\n\r\n      return merged.concat.apply(merged, objects);\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.utils.effects = setupEffects();\r\n\r\n  /*---------------------\r\n  -------- PUBLIC -------\r\n  ----------------------*/\r\n  /**\r\n   * This module will hold the most common graphical effects used in the map. It is still very stub as the development\r\n   * hasn't proceeded to this stage yet.\r\n   *\r\n   * @class utils.effects\r\n   * @return {Object}      init, _startDragListener\r\n   */\r\n  function setupEffects() {\r\n    /*---------------------\r\n    ------- API ----------\r\n    --------------------*/\r\n    return {\r\n      dropShadow\r\n    };\r\n\r\n    /*----------------------\r\n    ------- PUBLIC ---------\r\n    ----------------------*/\r\n    /**\r\n     * @method dropShadow\r\n     * @param  {Object} options\r\n     */\r\n    function dropShadow(options = { color: \"#000000\", distance: 5, alpha: 0.5, amg√∂e: 45, blur: 5 } ) {\r\n        var shadow  = new PIXI.filters.DropShadowFilter();\r\n\r\n        shadow.color  = options.color;\r\n        shadow.distance = options.distance;\r\n        shadow.alpha  = options.alpha;\r\n        shadow.angle  = options.angle;\r\n        shadow.blur   = options.blur;\r\n\r\n        this.filters = [shadow];\r\n      }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.utils.mouse = setupMouseUtils();\r\n  window.flatworld.utils.resize = setupResizeUtils();\r\n  window.flatworld.utils.environmentDetection = setupEnvironmentDetection();\r\n  window.flatworld.utils.general = setupGeneral();\r\n\r\n  /**\r\n   * @class utils.mouse\r\n   * @return {Object}      isRightClick, eventData.getPointerCoords, eventData.getHAMMERPointerCoords, eventMouseCoords\r\n   */\r\n  function setupMouseUtils() {\r\n    return {\r\n      isRightClick,\r\n      eventData: {\r\n        getPointerCoords,\r\n        getHAMMERPointerCoords\r\n      },\r\n      eventMouseCoords\r\n    };\r\n\r\n    /**\r\n     * Detects if the mouse click has been the right mouse button\r\n     *\r\n     * @method isRightClick\r\n     * @param {Event} event The event where the click occured\r\n     */\r\n    function isRightClick( event ) {\r\n      var rightclick;\r\n\r\n      event = event ? event : window.event; /* For IE. */\r\n      if ( event.buttons ) {\r\n        rightclick = ( +event.buttons === 2 );\r\n      } else if ( event.which ) {\r\n        rightclick = ( +event.which === 3 );\r\n      } else if ( event.button ) {\r\n        rightclick = ( +event.button === 2 );\r\n      }\r\n\r\n      if ( rightclick ) {\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n    /**\r\n     * @method getPointerCoords\r\n     * @param  {Event} e    Event object\r\n     * @return {Object}\r\n     */\r\n    function getPointerCoords(e) {\r\n      return {\r\n        x: e.offsetX,\r\n        y: e.offsetY\r\n      };\r\n    }\r\n    /**\r\n     * @method getHAMMERPointerCoords\r\n     * @param  {Event} e    Event object\r\n     * @return {Object}\r\n     */\r\n    function getHAMMERPointerCoords(e) {\r\n      return e.center;\r\n    }\r\n    /**\r\n     * @method eventMouseCoords\r\n     * @param  {Event} e    Event object\r\n     * @return {Object}\r\n     */\r\n    function eventMouseCoords(e) {\r\n      var pos = {\r\n        x:0,\r\n        y:0\r\n      };\r\n\r\n      if (!e) {\r\n        e = window.event;\r\n      }\r\n      if (e.pageX || e.pageY)   {\r\n        pos.x = e.pageX;\r\n        pos.y = e.pageY;\r\n      } else if (e.clientX || e.clientY)  {\r\n        pos.x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;\r\n        pos.y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;\r\n      }\r\n      // posx and posy contain the mouse position relative to the document\r\n      // Do something with this information\r\n      return pos;\r\n    }\r\n  }\r\n  /**\r\n   * @class utils.resize\r\n   * @return {Object}      toggleFullScreen, setToFullSize, getWindowSize\r\n   */\r\n  function setupResizeUtils() {\r\n    return {\r\n      toggleFullScreen,\r\n      setToFullSize,\r\n      getWindowSize\r\n    };\r\n\r\n    /**\r\n     * @method toggleFullScreen\r\n     */\r\n    function toggleFullScreen() {\r\n      var elem = document.body; // Make the body go full screen.\r\n      var isInFullScreen = ( document.fullScreenElement && document.fullScreenElement !== null ) ||\r\n         (\r\n         document.mozFullScreen || document.webkitIsFullScreen );\r\n\r\n      /* jshint expr: true */\r\n      isInFullScreen ? cancelFullScreen( document ) : requestFullScreen( elem );\r\n\r\n      return false;\r\n\r\n      /*-------------------------\r\n      --------- PRIVATE ---------\r\n      -------------------------*/\r\n      /* global ActiveXObject */\r\n      function cancelFullScreen( el ) {\r\n        var requestMethod = el.cancelFullScreen ||\r\n           el.webkitCancelFullScreen ||\r\n           el.mozCancelFullScreen ||\r\n           el.exitFullscreen;\r\n        if ( requestMethod ) { // cancel full screen.\r\n          requestMethod.call( el );\r\n        } else if ( typeof window.ActiveXObject !== \"undefined\" ) { // Older IE.\r\n          var wscript = new ActiveXObject( \"WScript.Shell\" );\r\n          wscript !== null && wscript.SendKeys( \"{F11}\" );\r\n        }\r\n      }\r\n      function requestFullScreen( el ) {\r\n        // Supports most browsers and their versions.\r\n        var requestMethod = el.requestFullScreen ||\r\n           el.webkitRequestFullScreen ||\r\n           el.mozRequestFullScreen ||\r\n           el.msRequestFullScreen;\r\n\r\n        if ( requestMethod ) { // Native full screen.\r\n          requestMethod.call( el );\r\n        } else if ( typeof window.ActiveXObject !== \"undefined\" ) { // Older IE.\r\n          var wscript = new ActiveXObject( \"WScript.Shell\" );\r\n          wscript !== null && wscript.SendKeys( \"{F11}\" );\r\n        }\r\n        return false;\r\n      }\r\n    }\r\n    /**\r\n     * Sets canvas size to maximum width and height on the browser, not using fullscreen\r\n     *\r\n     * @method setToFullSize\r\n     * @param {HTMLElement} context        DOMElement Canvas context\r\n     */\r\n    function setToFullSize(context) {\r\n      return function fullSize() {\r\n        const size = getWindowSize();\r\n\r\n        context.canvas.width = size.x;\r\n        context.canvas.height = size.y;\r\n      };\r\n    }\r\n    /**\r\n     * Get browser windows size\r\n     *\r\n     * @method getWindowSize\r\n     * @param {HTMLElement} context        DOMElement Canvas context\r\n     */\r\n    function getWindowSize() {\r\n      return {\r\n        x: window.innerWidth,\r\n        y: window.innerHeight\r\n      };\r\n    }\r\n  }\r\n  /**\r\n   * @class utils.environment\r\n   * @return {Object}      getPixelRatio\r\n   */\r\n  function setupEnvironmentDetection() {\r\n    return {\r\n      getPixelRatio//,\r\n      // isMobile,\r\n      // isMobile_detectUserAgent\r\n    };\r\n\r\n    /**\r\n     * @method getPixelRatio\r\n     * @requires Canvas element in the DOM. This needs to be found\r\n     * @param  {HTMLElement} canvasElement       HTML canvas element\r\n     * @return {Number}\r\n     */\r\n    function getPixelRatio(canvasElement) {\r\n      const DPR = window.devicePixelRatio || 1;\r\n      var ctx = ( canvasElement && canvasElement.getContext(\"2d\") ) || document.createElement('canvas').getContext(\"2d\");\r\n      var bsr = ctx.webkitBackingStorePixelRatio || ctx.mozBackingStorePixelRatio ||\r\n                ctx.msBackingStorePixelRatio || ctx.oBackingStorePixelRatio ||\r\n                ctx.backingStorePixelRatio || 1;\r\n\r\n      return DPR / bsr;\r\n    }\r\n  }\r\n  /**\r\n   * @class utils.general\r\n   * @return {Object}      pixelEpsilonEquality\r\n   */\r\n  function setupGeneral() {\r\n    const PIXEL_EPSILON = 0.01;\r\n\r\n    return {\r\n      pixelEpsilonEquality: epsilonEquality\r\n    };\r\n\r\n    /**\r\n     * @method epsilonEquality\r\n     * @param  {Number} x\r\n     * @param  {Number} y\r\n     */\r\n    function epsilonEquality(x, y) {\r\n      return ( Math.abs(x) - Math.abs(y) ) < PIXEL_EPSILON;\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  -------- PUBLIC -------\r\n  ----------------------*/\r\n  /**\r\n   * This module handles map events. Like informing map movement, object selection and other changes. Not that ALL the eventlisteners and their callbacks will throw one event! But that event will have no extra parameters, so when you do special things, like selecting objects on the map, you should throw another event when that happens and you can pass on the objects that were selected from the map.\r\n   * Events atm:\r\n   * - mapfullscreen - NO ARGUMENTS\r\n   * - mapfullSize - NO ARGUMENTS\r\n   * - mapdrag - NO ARGUMENTS\r\n   * - mapzoomed - event.customData[0].previousScale , .newScale\r\n   * - Mapselect - NO ARGUMENTS\r\n   * - mapMoved\r\n   * - mapResize\r\n   * - mapFullscreeActivated\r\n   *\r\n   * @class mapEvents\r\n   * @return {Object}     subsribe and publish\r\n   * @todo I want the pubsub module to go the ES6 way, not the only global exception!\r\n   */\r\n  function setupMapEvents () {\r\n    const TIMER_FOR_SAME_TYPE = 50;\r\n    var lastTimePublished = {};\r\n\r\n    /*---------------------------\r\n    ------------ API ------------\r\n    ---------------------------*/\r\n    return {\r\n      subscribe,\r\n      publish\r\n    };\r\n\r\n    function subscribe(type, cb) {\r\n      document.addEventListener(type, cb);\r\n      lastTimePublished[type] = 0;\r\n    }\r\n    function publish(type, ...data) {\r\n      var timestamp;\r\n\r\n      timestamp = new Date().getTime();\r\n\r\n      if ( (lastTimePublished[type] + TIMER_FOR_SAME_TYPE ) < timestamp) {\r\n        let eventToDispatch = new Event(type);\r\n\r\n        eventToDispatch.customData = data;\r\n\r\n        document.dispatchEvent(eventToDispatch);\r\n        lastTimePublished[type] = timestamp;\r\n      }\r\n    }\r\n  }\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.mapEvents = setupMapEvents();\r\n})();","(function () {\r\n  /* global Hammer, Hamster */\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  ------- VARIABLES -------\r\n  -----------------------*/\r\n  var stateOfEvents = {};\r\n  var activeEventListeners = {};\r\n  var detectors = {};\r\n\r\n  /*-----------------------\r\n  --------- IMPORT --------\r\n  -----------------------*/\r\n  var mapEvents = window.flatworld.mapEvents;\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.eventListeners = eventListenersModule();\r\n\r\n  /*-----------------------\r\n  -------- PUBLIC ---------\r\n  -----------------------*/\r\n  /**\r\n   * This keeps all the event listeners and detectors in one class. You add detectors / event listener types with addDetector and you add event listeners with on.\r\n   *\r\n   * @class eventListeners\r\n   */\r\n  function eventListenersModule() {\r\n    /*---------------------------\r\n    ------------ API ------------\r\n    ---------------------------*/\r\n    return {\r\n      on,\r\n      off,\r\n      isOn,\r\n      setActivityState,\r\n      getActivityState,\r\n      setDetector,\r\n      clearDetector\r\n    };\r\n\r\n    /*---------------------------\r\n    ----------- PUBLIC ----------\r\n    ---------------------------*/\r\n    /**\r\n     * Activates the eventListener.\r\n     *\r\n     * @method on\r\n     * @event Event that consists of \"Map\" + the given event type, like such: \"MapDrag\"\r\n     * @throws {Error} General error, if detector for this event type has not been set.\r\n     * @param  {String}  type REQUIRED. The type of event. This type has been created with setDetector.\r\n     * @param  {Boolean} cb   REQUIRED. Callback to do it's eventlistener magic.\r\n     */\r\n    function on(type = \"\", cb = false) {\r\n      if (!detectors[type] && !detectors[type].size) {\r\n        throw new Error(\"eventlisteners.on needs to have detector set with this event type!\")\r\n      }\r\n      detectors[type].on(_createEventListenerWrapper(\"Map\" + type, cb));\r\n      activeEventListeners[type] = activeEventListeners[type] || new Set();\r\n      activeEventListeners[type].add(cb);\r\n    }\r\n    /**\r\n     * Deactivates the eventListener. Callback is optional. If is not provided will remove all this types eventListeners\r\n     *\r\n     * @method off\r\n     * @param  {String}  type REQUIRED. The type of event. This type has been created with setDetector.\r\n     * @param  {Boolean} cb   Callback to do it's eventlistener magic.\r\n     */\r\n    function off(type = \"\", cb = false) {\r\n      detectors[type].off(cb);\r\n      cb ? activeEventListeners[type].delete(cb) : delete activeEventListeners[type];\r\n    }\r\n    /**\r\n     * Activates the eventListener. Callback is optional. If is not provided will check if the eventlistener type has any listeners active.\r\n     *\r\n     * @method isOn\r\n     * @param  {String}  type REQUIRED. The type of event. This type has been created with setDetector.\r\n     * @param  {Boolean} cb   Callback to do it's eventlistener magic.\r\n     */\r\n    function isOn(type = \"\", cb = false) {\r\n      var answer;\r\n\r\n      answer = cb ? activeEventListeners[type].has(cb) : !!activeEventListeners[type].size;\r\n\r\n      return answer;\r\n    }\r\n    /**\r\n     * Sets the state of the event. State is very important e.g. for fluent dragging and selecting. When we start to drag, we avoid selecting units and vice versa, when we keep an event state tracking through this.\r\n     *\r\n     * @method setActivityState\r\n     * @param {String} type     EventType\r\n     * @param {[type]} newState [description]\r\n     */\r\n    function setActivityState(type = \"\", newState) {\r\n      stateOfEvents[type] = newState;\r\n    }\r\n    /**\r\n     * get activity state of the event\r\n     *\r\n     * @method getActivityState\r\n     * @param  {String} type EventType\r\n     * @return {Boolean}\r\n     */\r\n    function getActivityState(type = \"\") {\r\n      return stateOfEvents[type];\r\n    }\r\n    /**\r\n     * Set event detector. If there is already detector of this type, we overwrite it.\r\n     *\r\n     * @method setDetector\r\n     * @param {String}   type  Event type\r\n     * @param {Function} cbOn  Callback which sets activates the detector\r\n     * @param {Function} cbOff Callback which sets deactivates the detector\r\n     */\r\n    function setDetector(type = \"\", cbOn = () => {}, cbOff = () => {}) {\r\n      detectors[type] = {};\r\n      detectors[type] = {\r\n        on: cbOn,\r\n        off: cbOff\r\n      };\r\n    }\r\n    /**\r\n     * Clear event detector. We also remove all possible eventlisteners set on this event type.\r\n     *\r\n     * @method clearDetector\r\n     * @param {String}   type  Event type\r\n     */\r\n    function clearDetector(type = \"\") {\r\n      /* remove all event listeners before we empty the data */\r\n      activeEventListeners[type].forEach(cb => {\r\n        detectors[type].cbOff(cb);\r\n      });\r\n\r\n      /* remove all data / references to event listeners and detector */\r\n      delete activeEventListeners[type];\r\n      delete detectors[type];\r\n    }\r\n\r\n    /*-----------------------------\r\n    ----------- PRIVATE -----------\r\n    ------------------------------*/\r\n    /**\r\n     * This creates a wrapper for callback. The idea is to send map events from this wrapper for all events.\r\n     *\r\n     * @method _createEventListenerWrapper\r\n     * @private\r\n     * @static\r\n     * @param  {String}   type Event type\r\n     * @param  {Function} cb   Event callback\r\n     */\r\n    function _createEventListenerWrapper(type, cb) {\r\n      /* NOTE! There can be more than one arguments in an event. E.g. Hamster.js */\r\n      return (...args) => {\r\n        mapEvents.publish(type);\r\n        cb(...args);\r\n      }\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------ VARIABLES ------\r\n  ---------------------*/\r\n  var _UIObjects = [];\r\n\r\n  /*---------------------\r\n  -------- EXPORT -------\r\n  ---------------------*/\r\n  class MapLayer extends PIXI.Container {\r\n    /**\r\n     * Creates a basic layer for the Map. This type of layer can not hold subcontainers. Note that different devices and graphic cards can only have specific size of bitmap drawn, and PIXI cache always draws a bitmap thus the default is: 4096, based on this site: http://webglstats.com/ and MAX_TEXTURE_SIZE. This is important also when caching.\r\n     *\r\n     * @class MapLayer\r\n     * @constructor\r\n     * @param {Object} options                            optional options\r\n     * @param {String} options.name                       Layers name, used for identifying the layer. Useful in debugging, but can be used for finding correct layers too\r\n     * @param  {Object} options.coord                   coord starting coords of layer. Relative to parent map layer.\r\n     * @param  {Integer} options.coord.x         X coordinate\r\n     * @param  {Integer} options.coord.y         Y coordinate\r\n     * @param  {Object} options.specialLayer            Is this layer special (e.g. UILayer not included in normal operations)\r\n     * @param  {Integer} options.specialLayer.x         X coordinate\r\n     * @param  {Integer} options.specialLayer.y         Y coordinate\r\n     **/\r\n    constructor(options = {\r\n        name: \"\",\r\n        coord: { x: 0, y: 0 },\r\n        specialLayer: false,\r\n        selectable: false } ) {\r\n      var { name, coord, specialLayer, selectable } = options;\r\n\r\n      super();\r\n      Object.assign(this, coord);\r\n\r\n      /**\r\n       * Layers name, used for identifying the layer. Useful in debugging, but can be used for finding correct layers too\r\n       *\r\n       * @attribute name\r\n       * @type {String}\r\n       */\r\n      this.name = \"\" + name;\r\n      /**\r\n       * Is this layer special (e.g. UILayer not included in normal operations)\r\n       *\r\n       * @attribute specialLayer\r\n       * @type {Boolean}\r\n       */\r\n      this.specialLayer = !!specialLayer;\r\n      /**\r\n       * Can you select objects from this layer. For example with Map.getObjectsUnderArea\r\n       *\r\n       * @attribute selectable\r\n       * @type {Boolean}\r\n       */\r\n      this.selectable = selectable;\r\n    }\r\n    /**\r\n     * Does this layer use subcontainers.\r\n     *\r\n     * @method hasSubcontainers\r\n     * @return {Boolean} true = uses subcontainers.\r\n     */\r\n    hasSubcontainers() {\r\n      return this.subcontainersConfig ? true : false;\r\n    }\r\n    /**\r\n     * Is this layer cached at the moment or not.\r\n     *\r\n     * @method isCached\r\n     * @return {Boolean} true = is cached\r\n     */\r\n    isCached() {\r\n      return this.cacheAsBitmap;\r\n    }\r\n    /**\r\n     * Move layer based on given amounts\r\n     *\r\n     * @method move\r\n     * @param  {Object} coord            The amount of x and y coordinates we want the layer to move. I.e. { x: 5, y: 0 }. This would move the map 5 pixels horizontally and 0 pixels vertically\r\n     * @param  {Integer} coord.x         X coordinate\r\n     * @param  {Integer} coord.y         Y coordinate\r\n     **/\r\n    move(coord) {\r\n      this.x += coord.x;\r\n      this.y += coord.y;\r\n      this.drawThisChild = true;\r\n    }\r\n    /**\r\n     * set layer zoom\r\n     *\r\n     * @method setZoom\r\n     * @param {Number} amount The amount that you want the layer to zoom.\r\n     * @return {Number} The same amount that was given, except after transform to 2 decimals and type cast to Number\r\n     * */\r\n    setZoom(amount) {\r\n      this.scale.x = this.scale.y = +amount.toFixed(2);\r\n\r\n      return this.scale.x;\r\n    }\r\n    /**\r\n     * get layer zoom\r\n     *\r\n     * @method getZoom\r\n     * @return {Boolean} current amount of zoom\r\n     * */\r\n    getZoom() {\r\n      return this.scale.x;\r\n    }\r\n      /**\r\n     * get UIObjects on this layer, if there are any, or defaulty empty array if no UIObjects are active\r\n     *\r\n     * @method getUIObjects\r\n     * @return {Array} current UIObjects\r\n     * */\r\n    getUIObjects() {\r\n      return _UIObjects;\r\n    }\r\n    /**\r\n     * Remove all the UIObjects from this layer\r\n     *\r\n     * @method emptyUIObjects\r\n     * @return {Array} empty UIObjects array\r\n     * */\r\n    emptyUIObjects() {\r\n      _UIObjects.map(obj => {\r\n        this.getUILayer().removeChild(obj);\r\n        obj = null;\r\n      });\r\n\r\n      return _UIObjects;\r\n    }\r\n    /**\r\n     * Get primary layers, that this layer holds as children. So basically all children that are not special layers (such as UI layers etc.)\r\n     *\r\n     * @method getPrimaryLayers\r\n     * @return {Array}                            Primary children layers under this layer\r\n     * */\r\n    getPrimaryLayers() {\r\n      return this.children.filter(thisChild => {\r\n        return !thisChild.specialLayer;\r\n      });\r\n    }\r\n    /**\r\n     * Get all objects that are this layers children or subcontainers children. Does not return layers, but the objects.\r\n     *\r\n     * @method getObjects\r\n     * @return {Array}                            All the objects (not layers) found under this layer\r\n     * */\r\n    getObjects() {\r\n      var allObjects = [];\r\n\r\n      if (this.hasSubcontainers()) {\r\n        this.subcontainerList.forEach(subcontainer => {\r\n          allObjects.concat(subcontainer.children);\r\n        });\r\n      }\r\n\r\n      return allObjects;\r\n    }\r\n    /**\r\n     * @todo IMPLEMENT CACHE PROPERLY! TAKE SUBCONTAINERS INTO ACCOUNT!\r\n     *\r\n     * Sets layer cache on or off.\r\n     *\r\n     * @method setCache\r\n     * @param {Boolean} status      true = activate cache, false = disable cache\r\n     */\r\n    setCache(status) {\r\n      var toCacheStatus = status ? true : false;\r\n\r\n      this.cacheAsBitmap = toCacheStatus;\r\n\r\n      return toCacheStatus;\r\n    }\r\n    /**\r\n     * Create and add special layer, that holds UI effects in it.\r\n     *\r\n     * @method createUILayer\r\n     * @param  {String} name          name of the layer\r\n     * @param  {Object} coord         Coordinates of the layer\r\n     * @param  {Integer} coord.x      X coordinate\r\n     * @param  {Integer} coord.y      Y coordinate\r\n     * @return {MapLayer}            The created UI layer\r\n     **/\r\n    createUILayer(name = \"default UI layer\", coord = { x: 0, y: 0 }) {\r\n      var layer = new MapLayer(name, coord);\r\n\r\n      layer.specialLayer = true;\r\n      this.addChild(layer);\r\n\r\n      this.UILayer = layer;\r\n\r\n      return layer;\r\n    }\r\n    /**\r\n     * Adds and object to this layers UILayer child.\r\n     *\r\n     * @method addUIObject\r\n     * @param {Object} object   The UI object to be added under this layer\r\n     * @return {Array}          All the UIObjects currently on this layer\r\n     */\r\n    addUIObject(object) {\r\n      var UILayer;\r\n      _UIObjects = _UIObjects || [];\r\n\r\n      if (!this.getUILayer()) {\r\n        UILayer = this.createUILayer();\r\n      } else {\r\n        UILayer = this.getUILayer;\r\n      }\r\n\r\n      this.UILayer.addChild(object);\r\n      _UIObjects.push( object );\r\n\r\n      return _UIObjects;\r\n    }\r\n    /**\r\n     * Return the UILayer. If no UILayer is yet created, will return undefined\r\n     *\r\n     * @method getUILayer\r\n     * @return {MapLayer | undefined}\r\n     */\r\n    getUILayer() {\r\n      return this.UILayer;\r\n    }\r\n  }\r\n\r\n  class MapLayerParent extends MapLayer {\r\n    /**\r\n     * Layer designed to hold subcontainers. But can handle objects too. Different devices graphic cards can only have specific size of bitmap drawn, and PIXI cache always draws a bitmap. Thus the default is: 4096, based on this site: http://webglstats.com/ and MAX_TEXTURE_SIZE\r\n     *\r\n     * @class MapLayerParent\r\n     * @constructor\r\n     * @param {Object} options\r\n     * @param {String} options.name                    name layer property name, used for identifiying the layer, usefull in debugging, but used also otherwise too\r\n     * @param  {Object} options.coord                  starting coords of layer. Relative to parent map layer.\r\n     * @param  {Integer} options.coord.x               X coordinate\r\n     * @param  {Integer} options.coord.y               Y coordinate\r\n     * @param  {Object} options.subcontainers          Subontainer size. If given activated subcontainers, otherwise not.\r\n     * @param  {Integer} options.subcontainers.width   width (in pixels)\r\n     * @param  {Integer} options.subcontainers.height  height (in pixels)\r\n     * @param {Boolean} options.specialLayer           Is this special layer or not.\r\n     */\r\n    constructor(options = { name: \"\", coord: { x: 0, y: 0 }, subcontainers: false, specialLayer: false, selectable: false } ) {\r\n      var { subcontainers, selectable, specialLayer } = options;\r\n\r\n      super(options);\r\n\r\n      this.oldAddChild = super.addChild.bind(this);\r\n      this.subcontainersConfig = subcontainers;\r\n      this.subcontainerList = [];\r\n      this.selectable = selectable;\r\n      this.specialLayer = specialLayer;\r\n    }\r\n    /**\r\n     * We override the PIXIs own addchild functionality. Since we need to support subcontainers in addChild. We check subcontainers and then we call the original (PIXIs) addChild\r\n     *\r\n     * @method addChild\r\n     * @param {PIXI.DisplayObject} displayObject      PIXI.DisplayObject\r\n     */\r\n    addChild(displayObject) {\r\n      if (this.hasSubcontainers()) {\r\n        let correctContainer;\r\n        correctContainer = setCorrectSubcontainer(displayObject, this);\r\n        this.oldAddChild(correctContainer);\r\n      } else {\r\n        this.oldAddChild(displayObject);\r\n      }\r\n\r\n      return displayObject;\r\n    }\r\n    /**\r\n     * Returns the configurations set for subcontainers.\r\n     *\r\n     * @method getSubcontainerConfigs\r\n     */\r\n    getSubcontainerConfigs () {\r\n      return this.subcontainersConfig;\r\n    }\r\n    /**\r\n     * Returns subcontainers based on the given coordinates. Can be applied through a MapDataManipulator filter also.\r\n     *\r\n     * @method getSubcontainersByCoordinates\r\n     * @param  {Object} coordinates\r\n     * @param  {Integer} coordinates.x                  X coordinate\r\n     * @param  {Integer} coordinates.y                  Y coordinate\r\n     * @param  {Object} options                         Optional options.\r\n     * @param  {MapDataManipulator} options.filter      Filter for selecting only certain subcontainers\r\n     */\r\n    getSubcontainersByCoordinates(coordinates, options = { filter: undefined }) {\r\n      if (!this.hasSubcontainers()) {\r\n        throw new Error(\"tried to retrieve subcontainers, when they are not present\");\r\n      }\r\n\r\n      var foundSubcontainers, tempCoordinates;\r\n      var { filter } = options;\r\n\r\n      tempCoordinates = this.toLocal(new PIXI.Point(coordinates.x, coordinates.y));\r\n      tempCoordinates.width = coordinates.width;\r\n      tempCoordinates.height = coordinates.height;\r\n\r\n      foundSubcontainers = getClosestSubcontainers(this, tempCoordinates, { filter });\r\n\r\n      return foundSubcontainers;\r\n    }\r\n    /**\r\n     * @method getSubcontainers\r\n     */\r\n    getSubcontainers() {\r\n      return this.subcontainerList;\r\n    }\r\n  }\r\n\r\n  class MapSubcontainer extends PIXI.Container {\r\n    /**\r\n     * Subcontainers are containers that hold objects like units and terrain etc. under them. They have some restrictions atm. since they are PIXI.ParticleContainers. But when needed we can extend MapLayers with another class which is subcontainer, but not ParticleContainer at the present there is no need, so we won't extend yet. Subcontainers help the layers to make better movement of the map, by making subcontainers visible or invisible and even helping with selecting objects on the map. Thus we don't need to use our inefficient Quadtree. The intention was to use PIXI.ParticleContainer for this, but it seems it doesn't clean up the memory afterwards the same way as normal Container.\r\n     *\r\n     * @private\r\n     * @class MapSubcontainer\r\n     * @constructor\r\n     * @param  {Object} size              Subontainer size. If given activated subcontainers, otherwise not.\r\n     * @param  {Integer} size.width       width (in pixels)\r\n     * @param  {Integer} size.height      height (in pixels)\r\n     */\r\n    constructor(size) {\r\n      super();\r\n\r\n      this.specialLayer = true;\r\n      this.size = size;\r\n      this.selectable = false;\r\n    }\r\n    /**\r\n     * Gets this subcontainers coordinates and size\r\n     *\r\n     * @method getSubcontainerArea\r\n     * @param {Number} scale                              The size of scale the map currently has\r\n     * @param {Boolean} options.toGlobal                  Do we get the global coordinates or local\r\n     */\r\n    getSubcontainerArea (scale, options = { toGlobal: true } ) {\r\n      var coordinates;\r\n\r\n      coordinates = options.toGlobal ? this.toGlobal(new PIXI.Point(0, 0)) : this;\r\n      if (scale) {\r\n        coordinates.x /= scale;\r\n        coordinates.y /= scale;\r\n      }\r\n\r\n      return {\r\n        x: Math.round( coordinates.x ),\r\n        y: Math.round( coordinates.y ),\r\n        width: Math.round( this.size.width ),\r\n        height: Math.round( this.size.height )\r\n      };\r\n    }\r\n    /**\r\n     * Set cache on or off for this layer\r\n     *\r\n     * @method setCache\r\n     * @param {Boolean} status      true = activate cache, false = disable cache\r\n     */\r\n    setCache(status) {\r\n      var toCacheStatus = status ? true : false;\r\n\r\n      this.cacheAsBitmap = toCacheStatus;\r\n\r\n      return toCacheStatus;\r\n    }\r\n  }\r\n  /*---------------------\r\n  ------- PRIVATE -------\r\n  ----------------------*/\r\n  /**\r\n   * Helper function for setting subcontainers to parent containers\r\n   *\r\n   * @method setCorrectSubcontainer\r\n   * @private\r\n   * @static\r\n   * @method setCorrectSubcontainer\r\n   * @param {PIXI.DisplayObject} displayObject\r\n   * @param {Object} parentLayer\r\n   */\r\n  function setCorrectSubcontainer(displayObject, parentLayer) {\r\n    var { subcontainersConfig, subcontainerList } = parentLayer;\r\n    var xIndex = Math.floor( displayObject.x / subcontainersConfig.width );\r\n    var yIndex = Math.floor( displayObject.y / subcontainersConfig.height );\r\n    var thisSubcontainer;\r\n\r\n    subcontainerList[xIndex] = subcontainerList[xIndex] || [];\r\n    thisSubcontainer = subcontainerList[xIndex][yIndex] = subcontainerList[xIndex][yIndex] || [];\r\n\r\n    if (subcontainerList[xIndex][yIndex].length <= 0) {\r\n      thisSubcontainer = new MapSubcontainer({\r\n        x: xIndex * subcontainersConfig.width,\r\n        y: yIndex * subcontainersConfig.height,\r\n        width: subcontainersConfig.width,\r\n        height: subcontainersConfig.height\r\n      });\r\n\r\n      subcontainerList[xIndex][yIndex] = thisSubcontainer;\r\n      thisSubcontainer.x = xIndex * subcontainersConfig.width;\r\n      thisSubcontainer.y = yIndex * subcontainersConfig.height;\r\n      thisSubcontainer.visible = subcontainersConfig.isHiddenByDefault ? false : true;\r\n    }\r\n\r\n    displayObject.x -= thisSubcontainer.x;\r\n    displayObject.y -= thisSubcontainer.y;\r\n    subcontainerList[xIndex][yIndex].addChild(displayObject);\r\n\r\n    return subcontainerList[xIndex][yIndex];\r\n  }\r\n  /**\r\n   * Get the closest subcontainers of the given area.\r\n   *\r\n   * @method setCorrectSubcontainer\r\n   * @private\r\n   * @static\r\n   * @method getClosestSubcontainers\r\n   * @param  {Object} layer                         Instance of PIXI.Container - The layer being used\r\n   * @param  {Number} xIndex                        x / horizontal index.\r\n   * @param  {Number} yIndex                        y / vertical index.\r\n   * @param  {Object} options                       Optional options.\r\n   * @param  {MapDataManipulator} options.filter    Filter for selecting only wanted subcontainers\r\n   * @return {Array}                                Array of found subcontainers.\r\n   */\r\n  function getClosestSubcontainers(layer, givenCoordinates, options = { filter: undefined }) {\r\n    var { filter } = options;\r\n    var coordinates = {\r\n      x: givenCoordinates.x >= 0 ? givenCoordinates.x : 0,\r\n      y: givenCoordinates.y >= 0 ? givenCoordinates.y : 0,\r\n      width: givenCoordinates.width,\r\n      height: givenCoordinates.height\r\n    };\r\n    var { width, height } = layer.getSubcontainerConfigs ();\r\n    var allFoundSubcontainers = [];\r\n    var xIndex = Math.floor( coordinates.x / width );\r\n    var yIndex = Math.floor( coordinates.y / height );\r\n    var x2 = coordinates.width ? coordinates.x + coordinates.width :  + coordinates.x;\r\n    var y2 = coordinates.height ? coordinates.y + coordinates.height :  + coordinates.y;\r\n    var widthIndex = Math.floor( x2 / width );\r\n    var heightIndex = Math.floor( y2 / height );\r\n    var subcontainerList = layer.subcontainerList;\r\n\r\n    for (let thisXIndex = xIndex; thisXIndex <= widthIndex; thisXIndex++) {\r\n      if (thisXIndex >= 0 && subcontainerList && subcontainerList[thisXIndex]) {\r\n        for (let thisYIndex = yIndex; thisYIndex <= heightIndex; thisYIndex++) {\r\n          if (thisYIndex >= 0 && subcontainerList[thisXIndex][thisYIndex]) {\r\n            if (filter && !filter.filterSubcontainers(subcontainerList[thisXIndex][thisYIndex])) {\r\n              continue;\r\n            }\r\n            allFoundSubcontainers.push(subcontainerList[thisXIndex][thisYIndex]);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return allFoundSubcontainers;\r\n  }\r\n\r\n  window.flatworld.mapLayers = window.flatworld.mapLayers || {};\r\n  window.flatworld.mapLayers.MapLayer = MapLayer;\r\n  window.flatworld.mapLayers.MapLayerParent = MapLayerParent;\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  var mapLayers = window.flatworld.mapLayers;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  class MapDataManipulator {\r\n    /**\r\n     * Class to get a consistent standard for the engine to be able to filter objects, when retrieving or sorting them.\r\n     *\r\n     * @class MapDataManipulator\r\n     * @constructor\r\n     * @param {Array|Object} rules        REQUIRED. The rules that apply for this instance. Multiple rules in Array or one as Object.\r\n     **/\r\n    constructor(rules) {\r\n      this.rules = Array.isArray(rules) ?  rules : [rules];\r\n      this.layerClasses = [mapLayers.MapLayer, mapLayers.MapLayerParent];\r\n    }\r\n    filterSubcontainers(subcontainers) {\r\n      if (!Array.isArray(subcontainers)) {\r\n        return this._runRules(subcontainers);\r\n      }\r\n    }\r\n    addRule(rules) {\r\n      this.rules.concat(rules);\r\n    }\r\n    /**\r\n     * This is the actual method that runs through the rules and arranges the data\r\n     *\r\n     * @method _runRules\r\n     * @private\r\n     * @return {[type]} [description]\r\n     **/\r\n    _runRules(object) {\r\n      var foundObjects;\r\n\r\n      this.rules.forEach((rule) => {\r\n        if (rule.type === \"filter\") {\r\n          switch (rule.object) {\r\n            case \"container\":\r\n              foundObjects = this._getContainer(object, rule);\r\n              break;\r\n            case \"object\":\r\n              foundObjects = this._getObject(object, rule);\r\n              break;\r\n          }\r\n        }\r\n      });\r\n\r\n      return foundObjects;\r\n    }\r\n    /**\r\n     * This is the actual method that runs through the rules and arranges the data\r\n     *\r\n     * @todo Refactor\r\n     *\r\n     * @method _getContainer\r\n     * @private\r\n     * @return {[type]} [description]\r\n     **/\r\n    _getContainer(object, rule) {\r\n      if (object && ( object.parent instanceof this.layerClasses[0] || object && object.parent instanceof this.layerClasses[1] )) {\r\n        return object.parent[rule.property] === rule.value;\r\n      } else if ( object && object.parent && ( object.parent.parent instanceof this.layerClasses[0] || object.parent.parent instanceof this.layerClasses[0] )) {\r\n        return object.parent.parent[rule.property] === rule.value;\r\n      }\r\n    }\r\n    /**\r\n     * This is the actual method that runs through the rules and arranges the data\r\n     *\r\n     * @todo Refactor\r\n     *\r\n     * @method _getContainer\r\n     * @private\r\n     * @return {[type]} [description]\r\n     **/\r\n    _getContainer(object, rule) {\r\n      if (object && ( object.parent instanceof this.layerClasses[0] || object && object.parent instanceof this.layerClasses[1] )) {\r\n        return object.parent[rule.property] === rule.value;\r\n      } else if ( object && object.parent && ( object.parent.parent instanceof this.layerClasses[0] || object.parent.parent instanceof this.layerClasses[0] )) {\r\n        return object.parent.parent[rule.property] === rule.value;\r\n      }\r\n    }\r\n  }\r\n\r\n  window.flatworld.MapDataManipulator = MapDataManipulator;\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------ VARIABLES ------\r\n  ----------------------*/\r\n  var scope;\r\n\r\n  /*---------------------\r\n  -------- PUBLIC -------\r\n  ----------------------*/\r\n  /**\r\n   * Main class for showing UI on the map. Like unit selections and such. Has nothing to do with showing off-map data.\r\n   * Good examples for what this shows are: selected units-list, selection highlight (like a circle on the selected unit) and bringing the unit on top in the map. UI themes must implement this core UI module\r\n   *\r\n   * @todo Not implemented fully yet and probably need refactoring\r\n   *\r\n   * @class UI\r\n   * @constructor\r\n   * @param {Object} UITheme        Module that will be used for the UI theme\r\n   * @param {Map} givenMap          Map instance that is used\r\n   * @return {Object}               UI module\r\n  */\r\n  function UI (UITheme, givenMap) {\r\n    var map;\r\n\r\n    /* SINGLETON MODULE */\r\n    if (scope) {\r\n      return scope;\r\n    }\r\n\r\n    if (!UITheme || !givenMap) {\r\n      throw new Error(\"UI-module requires UITheme and map object\");\r\n    }\r\n\r\n    map = givenMap;\r\n    scope = {};\r\n\r\n    /**\r\n     * Responsible for showing selection element, where the player select the wanted object out of array of objects.\r\n     * For example if there are several objects in one tile on the map and the player needs to be able to select one\r\n     * specific unit on the stack. This is always defined in the UI theme-module\r\n     *\r\n     * @method showSelections\r\n     * @static\r\n     * @param  {Array} objects     Objects that have been selected.\r\n     * @param {Object} getDatas       This is an object made of functions, that get wanted data from the object. For example if you have objects name in object.data.specialData.name, then you have an object getDatas.name(), which retrieves this.\r\n     * @param {Object} getDatas.name  Retrieves object name\r\n     * @param {Object} options        Extra options\r\n     * @return {Boolean}\r\n     * */\r\n    scope.showSelections = function (objects, getDatas, options) {\r\n      objects = filterObjectsForHighlighting(objects);\r\n\r\n      if (objects.length === 1) {\r\n        return UITheme.highlightSelectedObject(objects[0], getDatas);\r\n      } else if (objects.length > 1) {\r\n        return UITheme.showSelections(objects, getDatas);\r\n      }\r\n\r\n      return \"No objects found\";\r\n    };\r\n    /**\r\n     * Resonsible for hignlighting the selected object. For example the unit that is being commanded. The hightlight\r\n     * can mean e.g. bringing the unit on top on the map and showing selection circle around it.\r\n     *\r\n     * @method highlightSelectedObject\r\n     * @static\r\n     * @param  {Object} object        Object that has been selected.\r\n     * @param {Object} getDatas       This is an object made of functions, that get wanted data from the object. For example if you have objects name in object.data.specialData.name, then you have an object getDatas.name(), which retrieves this.\r\n     * @param {Object} getDatas.name  Retrieves object name\r\n     * @param {Object} options        Extra options. Like dropping a shadow etc.\r\n     * */\r\n    scope.highlightSelectedObject = function (object, getDatas, options) {\r\n      UITheme.highlightSelectedObject(object);\r\n    }\r\n    /**\r\n     * Shows arrow or movement or what ever to indicate the selected unit is moving to the given location\r\n     *\r\n     * @method showUnitMovement\r\n     * @static\r\n     * */\r\n    scope.showUnitMovement = function (object, from, to, options) {\r\n      UITheme.showUnitMovement(object, from, to, options);\r\n    }\r\n\r\n    return scope;\r\n  }\r\n  /*--------------------------------\r\n  ------------ PRIVATE -------------\r\n  --------------------------------*/\r\n  /**\r\n   * This is a general function which filters only highlightable object for use in UI operations\r\n   *\r\n   * @static\r\n   * @method filterObjectsForHighlighting\r\n   * @param  {Array} objects\r\n   */\r\n  function filterObjectsForHighlighting (objects) {\r\n    var newObjects = objects.filter(obj => {\r\n      return obj.highlightable === true ? true : false;\r\n    });\r\n\r\n    return newObjects;\r\n  }\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.UI = UI;\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var utils = window.flatworld.utils;\r\n  var arrays = window.flatworld.generalUtils.arrays;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  class ObjectManager {\r\n    /**\r\n     * this module is responsible for doing hitTesting, like returning the units on certain clicked coordinates or when objects or areas collide with each other.\r\n     *\r\n     * @class ObjectManager\r\n     * @constructor\r\n     * @param {object} hitDetector Object or function that handles hit detection. This can be omitted in many cases\r\n     * @todo It might be a good idea to make the hitDetection more extensive. Now it just uses point or rectangle / bounds to detect hits. It could use sprites or forms.\r\n     */\r\n    constructor(hitDetector) {\r\n      this.hitDetector = hitDetector || {};\r\n    }\r\n    /**\r\n     * Retrieve objects under certain coordinates or area, if size is given. Uses subcontainers when used, no other options yet.\r\n     *\r\n     * @method retrieve\r\n     * @param {Object} allCoords                                The coordinates which we want to hitTest\r\n     * @param {x:Integer, y:Integer} allCoords.globalCoords     Global coordinates on static layer / canvas\r\n     * @param {x:Integer, y:Integer} allCoords.globalCoords.x\r\n     * @param {x:Integer, y:Integer} allCoords.globalCoords.y\r\n     * @param {Object} allCoords.localCoords                    Local coordiantes on movable layer\r\n     * @param {x:Integer, y:Integer} allCoords.localCoords.x\r\n     * @param {x:Integer, y:Integer} allCoords.localCoords.y\r\n     * @param {string} type                                     type of the object / layer that we want to retrieve\r\n     * @param {Object} options                                  optional options\r\n     * @param {Array} options.subcontainers                     The subcontainers we match against\r\n     * @param {Object} options.size                             Size of the rectangle area to match against, if we want to match rectangle instead of one point\r\n     * @param {Integer} options.size.width\r\n     * @param {Integer} options.size.height\r\n     * @return {Array}                                          matched objects\r\n     */\r\n    retrieve(allCoords, options = { type: false, subcontainers: [], size: { width: 0, height: 0 } }) {\r\n      var { subcontainers, size, type } = options;\r\n      var { globalCoords, localCoords } = allCoords;\r\n      var foundObjs = [];\r\n\r\n      if (subcontainers.length > 0) {\r\n        subcontainers.forEach(container => {\r\n          foundObjs = foundObjs.concat(container.children);\r\n        });\r\n\r\n        if (!size.width || !size.height) {\r\n          foundObjs = foundObjs.filter(obj => {\r\n            if (type && type !== obj.type) {\r\n              return false;\r\n            }\r\n\r\n            let isHit = obj.hitTest ? obj.hitTest(globalCoords, { hitDetector: this.hitDetector }) : true;\r\n\r\n            return isHit;\r\n          });\r\n        }\r\n      }\r\n\r\n      return foundObjs;\r\n    }\r\n  }\r\n\r\n  window.flatworld.ObjectManager = ObjectManager;\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  --------- IMPORT --------\r\n  -----------------------*/\r\n  var { ObjectSpriteTerrain, ObjectSpriteUnit } = window.flatworld.objects;\r\n  var { calcLongDiagonal, calcShortDiagonal, createHexagon } = window.flatworld.extensions.hexagons.utils;\r\n\r\n  /*-----------------------\r\n  -------- VARIABLES ------\r\n  -----------------------*/\r\n  var shape;\r\n\r\n  class ObjectHexaTerrain extends ObjectSpriteTerrain {\r\n    /**\r\n     * Terrain tile like desert or mountain, non-movable and cacheable. Normally, but not necessarily, these are inherited, depending on the map type. For example you might want to add some click area for these\r\n     *\r\n     * @class hexagonPlugin.ObjectHexaTerrain\r\n     * @constructor\r\n     * @param  {Object} coords\r\n     * @param  {Integer} coords.x         X coordinate\r\n     * @param  {Integer} coords.y         Y coordinate\r\n     * @param {object} data               This units custom data\r\n     * @param {Object} options            options.radius REQUIRED.\r\n     * @param {Number} options.radius     REQUIRED. This is the radius of the game maps hexagon.\r\n     */\r\n    constructor(coords, data, options) {\r\n      const { radius } = options;\r\n\r\n      super(coords, data, options);\r\n\r\n      this.name = \"DefaultTerrainObject_hexa\";\r\n      calculateHexa.call(this, radius);\r\n    }\r\n  }\r\n\r\n  class ObjectHexaUnit extends ObjectSpriteUnit {\r\n    /**\r\n     * Map unit like infantry or worker, usually something with actions or movable. Usually these are extended, depending on the map type. For example you might want to add some click area for these (e.g. hexagon)\r\n     *\r\n     * @class hexagonPlugin.ObjectHexaUnit\r\n     * @constructor\r\n     * @param {Object} coords            This units coordinates, relative to it's parent container\r\n     * @param {Integer} coords.x         X coordinate\r\n     * @param {Integer} coords.y         Y coordinate\r\n     * @param {object} data               This units custom data\r\n     * @param {Object} options            options.radius REQUIRED\r\n     * @param {Object} options.radius     REQUIRED. This is the radius of the game maps hexagon\r\n     */\r\n    constructor(coords, data, options) {\r\n      const { radius } = options;\r\n\r\n      super(coords, data, options);\r\n\r\n      this.name = \"DefaultUnitObjects_hexa\";\r\n\r\n      calculateHexa.call(this, radius);\r\n    }\r\n  }\r\n  /*-----------------------\r\n  --------- PRIVATE -------\r\n  -----------------------*/\r\n  /**\r\n   * @private\r\n   * @static\r\n   * @method calculateHexa\r\n   * @param {Number} radius       Hexagon radius\r\n   */\r\n  function calculateHexa(radius) {\r\n    if (!radius) {\r\n      throw new Error(\"Need radius!\");\r\n    }\r\n\r\n    const HEIGHT = Math.round(calcLongDiagonal(radius));\r\n    const WIDTH = Math.round(calcShortDiagonal(radius));\r\n    const SIDE = Math.round(radius.toFixed(3));\r\n\r\n    this.anchor.set(0.5, 0.5);\r\n    this.areaHeight = this.HEIGHT = HEIGHT;\r\n    this.areaWidth = this.WIDTH = WIDTH;\r\n    this.SIDE = SIDE;\r\n    this.ROW_HEIGHT = Math.round(HEIGHT * 0.75);\r\n\r\n    /* Draw hexagon to test the hits with hitArea */\r\n    this.hitArea = setAndGetShape(radius);\r\n    this.hitTest = function (coords, options) {\r\n      this.updateTransform();\r\n      //map.getMovableLayer().updateTransform();\r\n      //coords = map.getMovableLayer().toLocal(coords);\r\n      var isHit = options.hitDetector.processInteractive(\r\n        new PIXI.Point(coords.x, coords.y),\r\n        this,\r\n        function (/*parent, hits*/) {\r\n          console.log(\"Shouldn't get here, the object should be non-interactive\");\r\n        },\r\n        true,\r\n        true);\r\n\r\n      return isHit;\r\n    };\r\n  }\r\n  /**\r\n   * @private\r\n   * @static\r\n   * @method setAndGetShape\r\n   * @param {Number} radius       Hexagon radius\r\n   */\r\n  function setAndGetShape(radius) {\r\n    if (!shape) {\r\n      shape = createHexagon(radius);\r\n    }\r\n\r\n    return shape;\r\n  }\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.extensions.hexagons.objects = {\r\n    ObjectHexaTerrain,\r\n    ObjectHexaUnit\r\n  };\r\n})();","(function () {\r\n  /* global System, Q */\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var Q = window.flatworld_libararies.Q;\r\n  var Howl = window.flatworld_libararies.Howler;\r\n  var utils = window.flatworld.utils;\r\n  var log = window.flatworld.mapLayers;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  class Sound {\r\n    constructor() {\r\n      this._allSounds = {};\r\n    }\r\n    /**\r\n     * Add a sound to be used.\r\n     *\r\n     * @method add\r\n     * @param {String} name               Name / identifier\r\n     * @param {String} urls               An array of urls or one url\r\n     * @param {Object} options            *OPTIONAL*\r\n     * @param {Booleam} options.loop      Wether the sound will be looped or not\r\n     * @param {Object} options.volume     The volume of the sound (0 - 1)\r\n     * @return {Object}                   Created instance of sound\r\n     */\r\n    add(name, url, options = { loop: false, volume: 1 }) {\r\n      const ERROR_STRING = \"The sound '\" + name + \"' was unable to load!\";\r\n      var { loop, volume } = options;\r\n\r\n      this._allSounds[name] = {};\r\n      this._allSounds[name] = new Howl({\r\n        urls: [url],\r\n        autoplay: false,\r\n        loop: loop,\r\n        volume: volume\r\n      });\r\n\r\n      return this._allSounds[name];\r\n    }\r\n    /**\r\n     * Remove the sound from usage and memory\r\n     *\r\n     * @method remove\r\n     * @param {String} name     Name / identifier of the sound to be removed\r\n     */\r\n    remove(name) {\r\n      delete this._allSounds[name];\r\n    }\r\n    /**\r\n     * Start the sounds playback\r\n     *\r\n     * @method play\r\n     * @param  {String} name      Name of the sound to play\r\n     */\r\n    play(name) {\r\n      var promise = Q.defer();\r\n\r\n      this._allSounds[name]._onend = () => {\r\n        promise.resolve(true);\r\n      }\r\n      this._allSounds[name].play();\r\n    }\r\n    /**\r\n     * stop sound playback\r\n     *\r\n     * @method stop\r\n     * @param  {String} name      Name of the sound to stop playing\r\n     */\r\n    stop(name) {\r\n      this._allSounds[name].stop();\r\n    }\r\n    /**\r\n     * Fade the sound in or out\r\n     *\r\n     * @method  fade\r\n     * @param  {String} name            Name / identifier of the sound\r\n     * @param  {Object} from            Volume to fade from\r\n     * @param  {Object} to              Volume to fade to\r\n     * @param  {Object} duration        Time in milliseconds to fade\r\n     * @return {Promise}                Promise that resolves after fade is complete\r\n     */\r\n    fade(name, from, to, duration) {\r\n      var promise = Q.defer();\r\n      var cb;\r\n      cb = () => {\r\n        promise.resolve(true);\r\n      };\r\n\r\n      this._allSounds[name].fade(from, to, duration, cb);\r\n\r\n      return promise.promise;\r\n    }\r\n  }\r\n\r\n  window.flatworld.Sound = Sound;\r\n})();","(function () {\r\n  'use strict';\r\n  /*---------------------\r\n  ------ VARIABLES ------\r\n  ----------------------*/\r\n  var styleSheetElement, allCSSClasses;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  class UITemplateBase {\r\n    /**\r\n     * The template base class for UI templates\r\n     *\r\n     * @todo This needs a bit of redesign.\r\n     *\r\n     * @class UITemplateBase\r\n     * @constructor\r\n     * @param  {*} CSSClasses\r\n     */\r\n    constructor(CSSClasses) {\r\n      allCSSClasses = CSSClasses;\r\n      styleSheetElement = this.addStyleElement();\r\n      /* For testing. This is deeefinitely supposed to not be here, but it has stayed there for testing. */\r\n      let createdCSS = `\r\n        ${allCSSClasses.select} {\r\n          z-index: 9999;\r\n          opacity: 0.9;\r\n          position: fixed;\r\n          left: 0px;\r\n          bottom: 0px;\r\n          background-color: brown;\r\n          border: 1px solid rgb(255, 186, 148);;\r\n          border-bottom: 0px;\r\n          padding:15px;\r\n          margin-left:10px;\r\n        }`;\r\n      this.addCSSRulesToScriptTag(styleSheetElement, createdCSS);\r\n    }\r\n    /**\r\n     * Get the stylesheet element. Where are the defined CSS is\r\n     *\r\n     * @method getStyleSheetElement\r\n     * @return {HTMLElement}\r\n     */\r\n    getStyleSheetElement() {\r\n      return styleSheetElement;\r\n    }\r\n    /**\r\n     * @method getCSSClasses\r\n     */\r\n    getCSSClasses() {\r\n      return allCSSClasses;\r\n    }\r\n    /**\r\n     * @method addCSSRulesToScriptTag\r\n     *\r\n     * @param {Object} sheet\r\n     * @param {Object} rules\r\n     */\r\n    addCSSRulesToScriptTag(sheet, rules) {\r\n      sheet.insertRule(rules, 0);\r\n    }\r\n    /**\r\n     * @method addStyleElement\r\n     */\r\n    addStyleElement() {\r\n      var _styleElement = document.createElement(\"style\");\r\n      // WebKit hack :(\r\n      _styleElement.appendChild(document.createTextNode(\"\"));\r\n      document.head.appendChild(_styleElement);\r\n\r\n      return _styleElement.sheet;\r\n    }\r\n    /**\r\n     * @method showModal\r\n     *\r\n     * @param {HTMLElement} modalElem\r\n     * @param {Object} cssClasses\r\n     * @todo make sure / check, that modalElem.classList.add gets added only once\r\n     */\r\n    showModal(modalElem, cssClasses) {\r\n      modalElem.classList.add(cssClasses.select);\r\n      /* Would be HTML 5.1 standard, but that might be a long way\r\n        this.modal.show();*/\r\n    }\r\n  }\r\n\r\n  window.flatworld.UITemplateBase = UITemplateBase;\r\n})();","(function () {\r\n  /* global Hammer, Hamster */\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  --------- IMPORT --------\r\n  -----------------------*/\r\n  var eventListeners = window.flatworld.eventListeners;\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.extensions.baseEventlisteners = baseEventlistenersModule();\r\n\r\n  /*-----------------------\r\n  -------- PUBLIC ---------\r\n  -----------------------*/\r\n  /**\r\n   * Core plugin. Houses the default eventlisteners used in the map. When plugins are added to the map this class can be used for the eventlistener management.\r\n   *\r\n   * @class baseEventlisteners\r\n   * @requires Hammer.js (for touch events)\r\n   * @requires Hamster.js (for good cross-browser mousewheel events)\r\n   * @param {HTMLElement} canvasElement   The canvas element we listen events from. Will try to search the first canvas in the DOM, if none is provided\r\n   */\r\n  function baseEventlistenersModule() {\r\n    var CBs = {};\r\n    var hammer, hamster, fullSize, fullscreen, zoom, drag, select, boundResizer;\r\n\r\n    /*---------------------------\r\n    ----------- API -------------\r\n    ---------------------------*/\r\n    return {\r\n      init,\r\n      pluginName: \"baseEventlisteners\"\r\n    };\r\n\r\n    function init(map) {\r\n      hammer = new Hammer.Manager(map.canvas);\r\n      hamster = new Hamster(map.canvas);\r\n\r\n      eventListeners.setDetector(\"fullSize\", toggleFullSize().on, toggleFullSize().off);\r\n      eventListeners.setDetector(\"fullscreen\", toggleFullscreen().on, toggleFullscreen().off);\r\n      eventListeners.setDetector(\"zoom\", toggleZoom().on, toggleZoom().off);\r\n      eventListeners.setDetector(\"drag\", toggleDrag().on, toggleDrag().off);\r\n      eventListeners.setDetector(\"select\", toggleSelect().on, toggleSelect().off);\r\n\r\n      map.setPrototype(\"setFullsize\", () => {\r\n        /* We set this only once */\r\n        boundResizer = boundResizer || map._resizeCanvas.bind(map);\r\n\r\n        eventListeners.on(\"fullSize\", boundResizer);\r\n      })\r\n      map.setPrototype(\"setFullScreen\", () => {\r\n        eventListeners.on(\"fullscreen\", map._setFullScreen.bind(map));\r\n      })\r\n    }\r\n\r\n    /**\r\n     * Sets the canvas to fullsize as in the same size of the window / content area. But not fullscreen. Note that\r\n     *\r\n     * @method toggleFullSize\r\n     * @private\r\n     * @static\r\n     */\r\n    function toggleFullSize() {\r\n      return {\r\n        on: (cb) => {\r\n          window.addEventListener(\"resize\", cb);\r\n        },\r\n        off: (cb) => {\r\n          window.removeEventListener(\"resize\", cb);\r\n        }\r\n      }\r\n    }\r\n    /**\r\n     * Sets the browser in fullscreen mode.\r\n     *\r\n     * @method toggleFullscreen\r\n     * @static\r\n     * @param {Function} cb     Callback that fires when this event activates\r\n     * @return {Boolean}        Return the state of this event\r\n     */\r\n    function toggleFullscreen() {\r\n      return {\r\n        on: (cb) => {\r\n          window.addEventListener(\"fullscreen\", cb);\r\n        },\r\n        off: (cb) => {\r\n          window.removeEventListener(\"fullscreen\", cb);\r\n        }\r\n      }\r\n    };\r\n    /**\r\n     * Zoom the map. Mousewheel (desktop) and pinch (mobile)\r\n     *\r\n     * @method toggleZoomListener\r\n     * @static\r\n     * @param {Function} cb     Callback that fires when this event activates\r\n     * @return {Boolean}        Return the state of this event\r\n     */\r\n    function toggleZoom() {\r\n      return {\r\n        on: (cb) => {\r\n          var pinch = new Hammer.Pinch();\r\n\r\n          hammer.add(pinch);\r\n          hammer.on(\"pinch\", cb);\r\n          /* Hamster handles wheel events really nicely */\r\n          hamster.wheel(cb);\r\n        },\r\n        off: (cb) => {\r\n          hammer.on(\"pinch\", cb);\r\n          hamster.unwheel(cb);\r\n        }\r\n      }\r\n    };\r\n    /**\r\n     * DragListener (normally used for moving the map)\r\n     *\r\n     * @method toggleDragListener\r\n     * @static\r\n     * @param {Function} cb     Callback that fires when this event activates\r\n     * @return {Boolean}        Return the state of this event\r\n     */\r\n    function toggleDrag() {\r\n      return {\r\n        on: (cb) => {\r\n          var pan = new Hammer.Pan({\r\n            pointers: 1,\r\n            threshold: 5,\r\n            direction:  Hammer.DIRECTION_ALL });\r\n          hammer.add(pan);\r\n          hammer.on(\"pan\", cb);\r\n        },\r\n        off: (cb) => {\r\n          hammer.off(\"pan\", cb);\r\n        }\r\n      }\r\n    };\r\n    /**\r\n     * Selecting something from the map\r\n     *\r\n     * @method toggleSelectListener\r\n     * @static\r\n     * @param {Function} cb     Callback that fires when this event activates\r\n     * @return {Boolean}        Return the state of this event\r\n     */\r\n    function toggleSelect() {\r\n      return {\r\n        on: (cb) => {\r\n          var tap = new Hammer.Tap();\r\n          hammer.add(tap);\r\n          hammer.on(\"tap\", cb);\r\n        },\r\n        off: (cb) => {\r\n          hammer.off(\"tap\", cb);\r\n        }\r\n      };\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var eventListeners = window.flatworld.eventListeners;\r\n  var utils = window.flatworld.utils;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.extensions.mapDrag = setupMap_drag();\r\n\r\n  /*---------------------\r\n  -------- PUBLIC -------\r\n  ----------------------*/\r\n  /**\r\n   * Core plugin for the engine. Handles moving the map by dragging the map with mouse or touch event. Core plugins can always be overwrote if needed.\r\n   *\r\n   * @class mapDrag\r\n   * @requires Hammer.js - Mobile part requires\r\n   * @return {Object}      init, _startDragListener\r\n   */\r\n  function setupMap_drag() {\r\n    /* Function for setting and getting the mouse offset. Private functions declared bottom */\r\n    var offsetCoords = _offsetCoords();\r\n    var mapMoved = false;\r\n    var eventListenerCB;\r\n\r\n    /*--------------------\r\n    ------- API ----------\r\n    --------------------*/\r\n    return {\r\n      init,\r\n      pluginName: \"mapDrag\",\r\n      _startDragListener /* Function revealed for testing */\r\n    };\r\n\r\n    /*---------------------\r\n    -------- PUBLIC -------\r\n    ----------------------*/\r\n    /**\r\n     * Required init functions for the plugin\r\n     *\r\n     * @method init\r\n     * @param {Map} mapObj        The current instance of Map class\r\n     * */\r\n    function init(map) {\r\n      eventListenerCB = _startDragListener(map);\r\n\r\n      /* Singleton should have been instantiated before, we only retrieve it with 0 params */\r\n      eventListeners.on(\"drag\", eventListenerCB);\r\n    }\r\n\r\n    /*---------------------\r\n    -------- PRIVATE ------\r\n    ----------------------*/\r\n    /**\r\n     * Mobile version. Starts the functionality, uses Hammer.js heavily for doing the drag. More simple and better than\r\n     * desktop version, since we don't need to calculate the drag with several event listener, one is enough with Hammer\r\n     *\r\n     * @private\r\n     * @static\r\n     * @method _startDragListener\r\n     * @param {Map} map           The current instance of Map class\r\n     */\r\n    function _startDragListener( map ) {\r\n      var initialized = false;\r\n\r\n      return function startDrag(e) {\r\n        var coords;\r\n\r\n        if (eventListeners.getActivityState(\"zoom\")) {\r\n          return false;\r\n        }\r\n        coords = utils.mouse.eventData.getHAMMERPointerCoords(e);\r\n\r\n        mapMoved = true;\r\n\r\n        coords.x = Math.round( coords.x );\r\n        coords.y = Math.round( coords.y );\r\n\r\n        if (!initialized) {\r\n          offsetCoords.setOffset({\r\n            x: coords.x,\r\n            y: coords.y\r\n          });\r\n          initialized = true;\r\n\r\n          return;\r\n        } else if (e.isFinal === true) {\r\n          initialized = false;\r\n          mapMoved = false;\r\n        }\r\n\r\n        _mapMovement(e, map, coords);\r\n      };\r\n    }\r\n\r\n    /**\r\n     * This handles offset Changes and setting data has map been moved based on it. Also\r\n     * sets basic settings like preventDefault etc.\r\n     *\r\n     * @private\r\n     * @static\r\n     * @method _mapMovement\r\n     * @param  {Event} e                        The event being dealt with\r\n     * @param  {Map} map                        The current instance of Map class\r\n     * @param  {Coordinates} coords             Current pointer coordinates\r\n     */\r\n    function _mapMovement(e, map, coords) {\r\n      var offset, moved;\r\n\r\n      offset = offsetCoords.getOffset();\r\n      moved = {\r\n        x: coords.x - offset.x,\r\n        y: coords.y - offset.y\r\n      };\r\n\r\n      if (moved.x > 0 || moved.y > 0 || moved.x < 0 || moved.y < 0) {\r\n        map.moveMap(moved);\r\n      } else {\r\n        mapMoved = false;\r\n      }\r\n\r\n      offsetCoords.setOffset({\r\n        x: coords.x,\r\n        y: coords.y\r\n      });\r\n\r\n      e.preventDefault();\r\n    }\r\n    /**\r\n     * Function for setting and getting the mouse offset.\r\n     * Offset is the distance from the left upper coordinates (global 0, 0 coordinates) on the canvas, to the current /\r\n     * last known mouse coordinates\r\n     *\r\n     * @private\r\n     * @static\r\n     * @method _offsetCoords\r\n     */\r\n    function _offsetCoords() {\r\n      var offsetCoords;\r\n\r\n      return {\r\n        setOffset,\r\n        getOffset\r\n      };\r\n\r\n      function setOffset(coords) {\r\n        return ( offsetCoords = coords );\r\n      }\r\n      function getOffset() {\r\n        return offsetCoords;\r\n      }\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var eventListeners = window.flatworld.eventListeners;\r\n  var utils = window.flatworld.utils;\r\n  var mapEvents = window.flatworld.mapEvents;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.extensions.mapZoom = setupMap_zoom();\r\n\r\n  /*---------------------\r\n  -------- PUBLIC -------\r\n  ----------------------*/\r\n  /**\r\n   * Core plugin for the engine. Handles zooming for the map. Core plugins can always be overwrote if needed. Zooming happens when the user scrolls the mousewheel or in mobile, pinches the screen.\r\n   *\r\n   * @class mapZoom\r\n   * @return {Object}      init\r\n   */\r\n  function setupMap_zoom() {\r\n    /*---------------------\r\n    ------ VARIABLES ------\r\n    ----------------------*/\r\n    const TIMEOUT_AFTER_ZOOM = 40;\r\n    var initialized = false;\r\n    var mobileInitialized = false;\r\n    var difference = {};\r\n    var map;\r\n    /**\r\n     * Maximum and minimum amount, the player can zoom the map\r\n     *\r\n     * @attribute zoomLimit\r\n     * @type {{ farther: Number, closer: Number }}\r\n     */\r\n    var zoomLimit = {\r\n      farther: 0.4,\r\n      closer : 2.5\r\n    };\r\n    /**\r\n     * How much one step of zooming affects\r\n     *\r\n     * @attribute zoomModifier\r\n     * @type {Number}\r\n     */\r\n    var zoomModifier = 0.1;\r\n\r\n    /*---------------------\r\n    --------- API ---------\r\n    ---------------------*/\r\n    return {\r\n      init,\r\n      pluginName: \"mapZoom\",\r\n    };\r\n\r\n    /*---------------------\r\n    ------- PUBLIC --------\r\n    ----------------------*/\r\n    /**\r\n     * Required init functions for the plugin\r\n     *\r\n     * @method init\r\n     * @param {Map} mapObj       instantiated Map class object\r\n     *\r\n     * @todo think through should setZoomLimits and setZoomModifier be in map.prototype?\r\n     * But zoomLimit and modifier need to be setable in creation, init or later with setters\r\n     **/\r\n    function init(thisMap) {\r\n      map = thisMap;\r\n      map.setPrototype(\"zoomIn\", zoomIn);\r\n      map.setPrototype(\"zoomOut\", zoomOut);\r\n      map.setPrototype(\"setZoomLimits\", setZoomLimits);\r\n      map.setPrototype(\"setZoomModifier\", setZoomModifier);\r\n\r\n      /* Singleton should have been instantiated before, we only retrieve it with 0 params */\r\n      eventListeners.on(\"zoom\", unifiedEventCB);\r\n    }\r\n\r\n    /*----------------------------------------\r\n    ------ PROTOTYPE extensions for map ------\r\n    ----------------------------------------*/\r\n    /**\r\n     * How much one mouse wheel step zooms\r\n     *\r\n     * @method setZoomModifier\r\n     * @param {Number} amount           How much one mouse wheel step zooms. Needs to be in between 0 - 0.5\r\n     **/\r\n    function setZoomModifier (amount) {\r\n      if (! (amount > 0 || amount <= 0.5) ) {\r\n        throw new Error(\"Wrong zoom modifier! (needs to be >0 and <=0.5, given:\" + amount);\r\n      }\r\n      zoomModifier = amount;\r\n\r\n      return this;\r\n    }\r\n    /**\r\n     * How much can be zoomed in maximum and minimum\r\n     *\r\n     * @method setZoomLimits\r\n     * @param {Number} farther          (>1) How much one mouse wheel step zooms out\r\n     * @param {Number} closer           (0 - 1) How much one mouse wheel step zooms in\r\n     **/\r\n    function setZoomLimits (farther, closer) {\r\n      zoomLimit.farther = farther;\r\n      zoomLimit.closer = closer;\r\n\r\n      return this;\r\n    }\r\n    /**\r\n     * Zoom in to the map\r\n     *\r\n     * @method zoomIn\r\n     * @param {Number} amount how much map is zoomed in\r\n     * */\r\n    function zoomIn (amount) {\r\n      var presentScale = this.getZoom();\r\n      const IS_ZOOM_IN = true;\r\n\r\n      return _zoom(this, presentScale, Math.abs(amount) || zoomModifier, IS_ZOOM_IN);\r\n    }\r\n    /**\r\n     * Zoom out of the map\r\n     *\r\n     * @method zoomOut\r\n     * @param {Number} amount how much map is zoomed out\r\n     * */\r\n    function zoomOut (amount) {\r\n      var presentScale = this.getZoom();\r\n      const IS_ZOOM_IN = false;\r\n\r\n      amount = amount < 0 ? amount : -amount;\r\n\r\n      return _zoom(this, presentScale, amount || -zoomModifier, IS_ZOOM_IN);\r\n    }\r\n\r\n    /*---------------------------\r\n    ------ EVENT FUNCTIONS ------\r\n    ---------------------------*/\r\n    /**\r\n     * This starts the correct eventListener for the current environment. Mousewheel and pinch differ quite dramatically\r\n     * so we keep them as separate functions.\r\n     *\r\n     * @method unifiedEventCB\r\n     * @param  {Event} e             Event object\r\n     * @param  {Integer} delta       Hamster.js provided delta\r\n     * @param  {Integer} deltaX      Hamster.js provided delta\r\n     * @param  {Integer} deltaY      Hamster.js provided delta\r\n     */\r\n    function unifiedEventCB(e, delta, deltaX, deltaY) {\r\n      if (delta) {\r\n        handleZoomEventDesktop(e, delta, deltaX, deltaY);\r\n      } else if (e.pointers) {\r\n        if (!mobileInitialized) {\r\n          mobileInitialized = true;\r\n          setZoomModifier(zoomModifier * 0.5);\r\n        }\r\n        handleZoomEventMobile(e);\r\n      }\r\n    }\r\n    /**\r\n     * Setup desktop zoomEvent by currying. Internally: Sets up correct scale + moves map accordingly to zoom to the\r\n     * current center coordinates\r\n     *\r\n     * @method handleZoomEventDesktop\r\n     * @param  {Map} map             Map instance\r\n     */\r\n    function handleZoomEventDesktop(e, delta, deltaX, deltaY) {\r\n      var mouseWheelDelta = deltaY;\r\n      /* Scale changes when the map is drawn. We make calculations with the old scale before draw */\r\n      var oldScale = map.getZoom();\r\n\r\n      /* No nasty scrolling side-effects */\r\n      e.preventDefault();\r\n\r\n      if (mouseWheelDelta > 0) {\r\n        if (map.zoomIn()) {\r\n          map.moveMap(_calculateCenterMoveCoordinates(oldScale, true), _calculateCenterMoveCoordinates(map.getZoom(), true));\r\n        }\r\n      } else if (mouseWheelDelta < 0) {\r\n        if (map.zoomOut()) {\r\n          map.moveMap(_calculateCenterMoveCoordinates(oldScale), _calculateCenterMoveCoordinates(map.getZoom()));\r\n        }\r\n      }\r\n    }\r\n    /**\r\n     * handleZoomEventMobile\r\n     *\r\n     * @method handleZoomEventMobile\r\n     * @param  {Event} e\r\n     */\r\n    function handleZoomEventMobile(e) {\r\n      var pointers = e.pointers;\r\n      var coords = [{\r\n          x: pointers[0].pageX,\r\n          y: pointers[0].pageY\r\n        },{\r\n          x: pointers[1].pageX,\r\n          y: pointers[1].pageY\r\n        }];\r\n      var changeX = Math.abs( coords[0].x - coords[1].x );\r\n      var changeY = Math.abs( coords[0].y - coords[1].y );\r\n\r\n      e.preventDefault();\r\n\r\n      try {\r\n        if (!initialized) {\r\n          difference = {\r\n            x: changeX,\r\n            y: changeY\r\n          };\r\n          eventListeners.setActivityState(\"zoom\", true);\r\n          initialized = true;\r\n\r\n          return;\r\n        } else if (e.eventType === 4 || e.eventType === 8) { /* e.eventType 4 = event canceled, e.eventType 8 = event finished */\r\n          /* We don't want another event to be fired right after a pinch event. It makes the zoomign experience rather\r\n           * bad if after zoom there is immediately an unexplainable drag and the map moves a bit\r\n           * */\r\n          window.setTimeout(function () {\r\n            eventListeners.setActivityState(\"zoom\", false);\r\n          }, TIMEOUT_AFTER_ZOOM);\r\n          initialized = false;\r\n        }\r\n\r\n        if (difference.x + difference.y < changeX + changeY) {\r\n          if (map.zoomIn()) {\r\n            map.moveMap(_calculateCenterMoveCoordinates(map.getZoom(), true));\r\n          }\r\n        } else {\r\n          if (map.zoomOut()) {\r\n            map.moveMap(_calculateCenterMoveCoordinates(map.getZoom()));\r\n          }\r\n        }\r\n\r\n        difference = {\r\n          x: changeX,\r\n          y: changeY\r\n        };\r\n\r\n      } catch (ev) {\r\n        console.log(\"Error! \", ev);\r\n      }\r\n    }\r\n\r\n    /*---------------------\r\n    ------- PRIVATE -------\r\n    ---------------------*/\r\n    /**\r\n     * _isOverZoomLimit\r\n     *\r\n     * @private\r\n     * @static\r\n     * @method _isOverZoomLimit\r\n     **/\r\n    function _isOverZoomLimit(amount, isZoomIn) {\r\n      if ( (isZoomIn && amount > zoomLimit.closer ) || (!isZoomIn && amount < zoomLimit.farther) ) {\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n    /**\r\n     * @private\r\n     * @static\r\n     * @method _calculateCenterMoveCoordinates\r\n     **/\r\n    function _calculateCenterMoveCoordinates(scale, isZoomIn) {\r\n      var windowSize = utils.resize.getWindowSize();\r\n      var halfWindowSize = {\r\n        x: ( windowSize.x / 2 ) / scale,\r\n        y: ( windowSize.y / 2 ) / scale\r\n      };\r\n      var realMovement = {\r\n        x: ( halfWindowSize.x ) * ( ( isZoomIn ? -zoomModifier : zoomModifier) ),\r\n        y: ( halfWindowSize.y ) * ( ( isZoomIn ? -zoomModifier : zoomModifier) )\r\n      };\r\n\r\n      return realMovement;\r\n    }\r\n    /**\r\n     * @private\r\n     * @static\r\n     * @method _zoom\r\n     **/\r\n    function _zoom(map, presentScale, amount, isZoomIn) {\r\n      var newScale;\r\n\r\n      if ( !_isOverZoomLimit(presentScale, isZoomIn) ) {\r\n        newScale = map.setZoom( amount ? presentScale + amount : presentScale + zoomModifier );\r\n      }\r\n\r\n      return newScale;\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.extensions.hexagons.utils.calcShortDiagonal = calcShortDiagonal;\r\n  window.flatworld.extensions.hexagons.utils.calcLongDiagonal = calcLongDiagonal;\r\n  window.flatworld.extensions.hexagons.utils.hexaHitTest = hexaHitTest;\r\n\r\n  /**\r\n   * Utility module, for making different calculations and tests when hexagon based grid map in use\r\n   *\r\n   * @class hexagonPlugin.utils\r\n   */\r\n  /*-----------------------\r\n  --------- PUBLIC --------\r\n  -----------------------*/\r\n  /**\r\n   * Calculates the hexagons:\r\n   * innerDiameter\r\n   * - Vertical / Flat hexagons height\r\n   * - Horizontal / pointy hexagons width\r\n   *\r\n   * @method calcLongDiagonal\r\n   * @static\r\n   * @param {float} value - Usually the radius of the hexagon\r\n   * @param {string} type - If you provide something else than radius, where the calculation is based from\r\n   * @param {integer} precision - How many decimals to round\r\n   */\r\n  function calcShortDiagonal(value, type = \"radius\", precision = 3) {\r\n    var answer;\r\n\r\n    precision = Math.round(precision);\r\n\r\n    if (type === \"radius\") {\r\n      answer = value * Math.sqrt(3);\r\n    }\r\n\r\n    return Number( answer.toFixed(precision) );\r\n  }\r\n  /** Calculates the hexagons:\r\n   * outerDiameter\r\n   * - Vertical / Flat hexagons width\r\n   * - Horizontal / pointy hexagons height\r\n   *\r\n   * @method calcLongDiagonal\r\n   * @static\r\n   * @param {float} value\t\t\t\t\tUsually the radius of the hexagon\r\n   * @param {string} type\t\t\t\t\tIf you provide something else than radius, where the calculation is based from\r\n   * @param {integer} precision \tHow many decimals to round\r\n   */\r\n  function calcLongDiagonal(value, type = \"radius\", precision = 3) {\r\n    var answer;\r\n\r\n    if (type === \"radius\") {\r\n      answer = value * 2;\r\n    }\r\n\r\n    return Number( answer.toFixed(precision) );\r\n  }\r\n  /**\r\n   * Test do the given coordinates hit the hexagon, given by the points container / array\r\n   *\r\n   * @static\r\n   * @method hexaHitTest\r\n   * @param  {PIXI.Point[]} points             Array of PIXI.points\r\n   * @param  {Object} hitCoords         The coordinates to test against\r\n   * @param  {Integer} hitCoords.x      X coordinate\r\n   * @param  {Integer} hitCoords.y      Y coordinate\r\n   * @param  {Object} offsetCoords      offsetCoordinates that are added to the hitCoordinates. Separate because these are outside the given array.\r\n   * @param  {Integer} offsetCoords.x   X coordinate\r\n   * @param  {Integer} offsetCoords.y   Y coordinate\r\n   * @return {Boolean}                  Is the coordinate inside the hexagon or not\r\n   */\r\n\r\n  function hexaHitTest(points, hitCoords = {x:0, y:0}, offsetCoords = {x:0, y:0}) {\r\n    var realPolygonPoints;\r\n\r\n    realPolygonPoints = points.map(point => {\r\n      return {\r\n        x: point.x + offsetCoords.x,\r\n        y: point.y + offsetCoords.y\r\n      };\r\n    });\r\n\r\n    return pointInPolygon(hitCoords, realPolygonPoints);\r\n  }\r\n\r\n  /*-----------------------\r\n  --------- PRIVATE -------\r\n  -----------------------*/\r\n  /**\r\n   * credits to: https://github.com/substack/point-in-polygon\r\n   * Tests whether the given point / coordinate is inside the given points. Assuming the points form a polygon\r\n   *\r\n   * @static\r\n   * @private\r\n   * @method pointInPolygon\r\n   * @param  {Object} point             The coordinates to test against\r\n   * @param  {Integer} hitCoords.x      X coordinate\r\n   * @param  {Integer} hitCoords.y      Y coordinate\r\n   * @param  {Integer[]} vs             The points of the polygon to test [0] === x-point, [1] === y-point\r\n   * @return {Boolean}                  Is the coordinate inside the hexagon or not\r\n   */\r\n  function pointInPolygon(point, vs) {\r\n    var x = point.x;\r\n    var y = point.y;\r\n    var inside = false;\r\n    var xi, xj, yi, yj, intersect;\r\n\r\n    for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {\r\n      xi = vs[i].x;\r\n      yi = vs[i].y;\r\n      xj = vs[j].x;\r\n      yj = vs[j].y;\r\n      intersect = ((yi > y) !== (yj > y)) &&\r\n          (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\r\n\r\n      if (intersect) {\r\n        inside = !inside;\r\n      }\r\n    }\r\n\r\n    return inside;\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  window.flatworld.extensions.hexagons.utils.createHexagon = createHexagon;\r\n  window.flatworld.extensions.hexagons.utils.createVisibleHexagon = createVisibleHexagon;\r\n\r\n  /*-----------------------\r\n  --------- PUBLIC --------\r\n  -----------------------*/\r\n  /**\r\n   * This manages some utility functionalities for creating hexagons\r\n   *\r\n   * @class hexagonPlugin.utils\r\n   */\r\n  /**\r\n   * Credits belong to: https://github.com/alforno-productions/HexPixiJs/blob/master/lib/hexPixi.js\r\n   * Creates a hex shaped polygon that is used for the hex's hit area.\r\n   *\r\n   * @private\r\n   * @static\r\n   * @method createHexagon\r\n   * @param {Number} radius       Radius of the hexagon\r\n   * @param {Object} options      Options, such as: isFlatTop (Boolean), is the heaxgon flat-topped\r\n   * @return {PIXI.Polygon}       Hexagon shaped PIXI.Polygon object. That houses the hexagons corner points.\r\n   */\r\n  function createHexagon(radius, options = { isFlatTop: false }) {\r\n    var points = [];\r\n\r\n    points = coordsToPixiPoints(radius);\r\n\r\n    return new PIXI.Polygon(points);\r\n  }\r\n  /**\r\n   * @private\r\n   * @static\r\n   * @method createVisibleHexagon\r\n   * @param {Number} radius       Radius of the hexagon\r\n   * @param {Object} options      Options, such as:\r\n   *                              color: The fill color of the hexagon\r\n   *                              isFlatTop (Boolean), is the heaxgon flat-topped\r\n   * @return {PIXI.Graphics}      Graphics object that is shaped as hexagon, based on given radius and options.\r\n   */\r\n  function createVisibleHexagon(radius, options = { color: \"#000000\", isFlatTop: false }) {\r\n    var graphics = new PIXI.Graphics();\r\n    var points = coordsToPixiPoints(radius);\r\n\r\n    graphics.beginFill(options.color, 1);\r\n    graphics.drawPolygon(points);\r\n    graphics.endFill();\r\n\r\n    return graphics;\r\n  }\r\n\r\n  /*-----------------------\r\n  --------- PRIVATE -------\r\n  -----------------------*/\r\n  /**\r\n   * Converts Array of x- and y-coordinates to new PIXI.Point coordinates\r\n   *\r\n   * @method coordsToPixiPoints\r\n   * @private\r\n   * @static\r\n   * @method coordsToPixiPoints\r\n   * @param  {Number} radius        Hexagons radius\r\n   * @return {Array}                Array of PIXI.Point coordinates\r\n   */\r\n  function coordsToPixiPoints(radius) {\r\n    return getHexagonPoints(radius).map(function(point) {\r\n      return new PIXI.Point(point.x, point.y);\r\n    });\r\n  }\r\n  /**\r\n   * @method getHexagonPoints\r\n   * @private\r\n   * @static\r\n   * @param {Float} radius      radius of the hexagon\r\n   * @param {object} options    extra options, like generating horizontal hexagon points and\r\n   * how many decimals to round\r\n  */\r\n  function getHexagonPoints(radius, options = { isFlatTop: false, precision: 3 }) {\r\n    const OFFSET = options.isFlatTop ? 0 : 0.5;\r\n    const CENTER = {\r\n      x: radius,\r\n      y: radius\r\n    };\r\n    var angle = 2 * Math.PI / 6 * OFFSET;\r\n    var x = CENTER.x * Math.cos(angle);\r\n    var y = CENTER.y * Math.sin(angle);\r\n    var points = [];\r\n\r\n    points.push({x, y});\r\n\r\n    for (let i = 1; i < 7; i++) {\r\n      angle = 2 * Math.PI / 6 * (i + OFFSET);\r\n      x = CENTER.x * Math.cos(angle);\r\n      y = CENTER.y * Math.sin(angle);\r\n\r\n      points.push({x, y});\r\n    }\r\n\r\n    return points;\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var utils = window.flatworld.utils;\r\n  var mapEvents = window.flatworld.mapEvents;\r\n  var UI = window.flatworld.UI;\r\n  var MapDataManipulator = window.flatworld.MapDataManipulator;\r\n  var eventListeners = window.flatworld.eventListeners;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.extensions.hexagons.setupHexagonClick = _setupHexagonClick;\r\n\r\n  /*---------------------\r\n  ------- PUBLIC --------\r\n  ----------------------*/\r\n  /**\r\n   * Handles the eventlistner for selecting objects on the map. THe actual logic for detecting the objects under mouse\r\n   * etc. are in selectHexagonPlugin\r\n   *\r\n   * @class hexagonPlugin.setupHexagonClick\r\n   * @requires Hammer.js. Some events are done with Hammer.js, so we need it to handle those events correctly\r\n   * @event                 Mapselect and objectsSelected (objectsSelected will have parameter for the objects that were selected)\r\n   * @param  {Map} map      The currently use Map instance\r\n   * @return {Boolean}      True\r\n   */\r\n  function _setupHexagonClick(map) {\r\n    var ui;\r\n\r\n    if (!map) {\r\n      throw new Error(\"eventlisteners initialization require map arguments\");\r\n    }\r\n\r\n    ui = UI();\r\n\r\n    eventListeners.on(\"select\", tapListener);\r\n\r\n    return true;\r\n\r\n    /*----------------------\r\n    ------- PUBLIC ---------\r\n    ----------------------*/\r\n    /**\r\n     * the listener that received the event object\r\n     *\r\n     * @method tapListener\r\n     * @param  {Event} e      Event object\r\n     */\r\n    function tapListener(e) {\r\n      var globalCoords = utils.mouse.eventData.getHAMMERPointerCoords(e);\r\n      var getData = {\r\n        allData: function (object) {\r\n          return object.data.typeData;\r\n        }\r\n      };\r\n      var objects, filter;\r\n\r\n      filter = new MapDataManipulator({\r\n        type: \"filter\",\r\n        object: \"container\",\r\n        property: \"name\",\r\n        value: \"unitLayer\"\r\n      });\r\n\r\n      objects = map.getObjectsUnderArea(globalCoords, { filter });\r\n      objects = utils.dataManipulation.mapObjectsToArray(objects);\r\n      objects = utils.dataManipulation.flattenArrayBy1Level(objects);\r\n\r\n      /* Throw a mapEvent if there are objects found. It might be required to throw this event later on, not yet here. */\r\n      if (objects.length) {\r\n        mapEvents.publish(\"objectsSelected\", objects);\r\n      }\r\n\r\n      ui.showSelections(objects, getData);\r\n      map.drawOnNextTick();\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  --------- IMPORT --------\r\n  -----------------------*/\r\n  var setupHexagonClick = window.flatworld.extensions.hexagons.setupHexagonClick;\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  debugger;\r\n  window.flatworld.extensions.hexagons.selectHexagonObject = setupObject_select_hexagon();\r\n\r\n  /*-----------------------\r\n  -------- PUBLIC ---------\r\n  -----------------------*/\r\n  /**\r\n   * Handles the selection of hexagons on the map\r\n   *\r\n   * @class hexagonPlugin.setupObject_select_hexagon\r\n   * @return {Object}       Return methods inside object\r\n   */\r\n  function setupObject_select_hexagon() {\r\n    var map = {};\r\n\r\n    return {\r\n      init,\r\n      pluginName: \"selectHexagonObject\"\r\n    };\r\n\r\n    /**\r\n     * @method  init\r\n     * @param {Map} givenMap         Instantiated Map class object\r\n     */\r\n    function init(givenMap) {\r\n      map = givenMap;\r\n\r\n      startClickListener(map);\r\n    }\r\n\r\n    /*-----------------------\r\n    -------- PRIVATE --------\r\n    -----------------------*/\r\n    /**\r\n     * @method startClickListener\r\n     * @param {Map} map              Instantiated Map class object\r\n     */\r\n    function startClickListener(map) {\r\n      return setupHexagonClick(map);\r\n    }\r\n  }\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*-----------------------\r\n  --------- IMPORT --------\r\n  -----------------------*/\r\n  var mapEvents = window.flatworld.mapEvents;\r\n  var arrays = window.flatworld.generalUtils.arrays;\r\n\r\n  /*-----------------------\r\n  ------- VARIABLES -------\r\n  -----------------------*/\r\n  var viewportWorker = new Worker(\"/components/map/extensions/mapMovement/mapMovementWorker.js\");\r\n\r\n  /*-----------------------\r\n  ---------- API ----------\r\n  -----------------------*/\r\n  /* For debugging. This will show up if the plugin fails to load in Map.js */\r\n  window.flatworld.extensions.mapMovement = setupMapMovement();\r\n\r\n  /*-----------------------\r\n  -------- PUBLIC ---------\r\n  -----------------------*/\r\n  /** This module manages visibility of the objects, based on are they visible to the player (on the canvas / webgl) or outside of it. This makes the map a lot faster and reliable resource-wise and lags otherwise. Requires subcontainers atm.\r\n   *\r\n   * @class mapMovement\r\n   **/\r\n  function setupMapMovement () {\r\n    const VIEWPORT_OFFSET = 0.8;\r\n    const CHECK_INTERVAL = 20;\r\n    var queue = {};\r\n    var changedCoordinates = {\r\n      width: 0,\r\n      height: 0\r\n    };\r\n    var map, currentScale;\r\n\r\n    return {\r\n      init,\r\n      pluginName: \"mapMovement\",\r\n      addAll,\r\n      check,\r\n      startEventListeners\r\n    };\r\n    /**\r\n     * √çnitialize as a plugin\r\n     *\r\n     * @method init\r\n     * @param  {Map} map     Instance of Map\r\n     */\r\n    function init(givenMap) {\r\n      map = givenMap;\r\n      currentScale = map.getZoom();\r\n\r\n      addAll();\r\n      startEventListeners();\r\n      map.drawOnNextTick();\r\n\r\n      /**\r\n       * For debugging. Shows the amount of currectly active and inactive subcontainers. Console.logs the data. Also extends window object.\r\n       *\r\n       * @method window.FlaTWorld_mapMovement_subCheck\r\n       * @static\r\n       */\r\n      window.FlaTWorld_mapMovement_subCheck = function() {\r\n        map.getPrimaryLayers().forEach( layer => {\r\n          var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());\r\n          var visibleContainers, invisibleContainers;\r\n\r\n          visibleContainers = subcontainers.filter(subcontainer => {\r\n            return subcontainer.visible;\r\n          });\r\n          invisibleContainers = subcontainers.filter(subcontainer => {\r\n            return !subcontainer.visible;\r\n          });\r\n\r\n          console.log(\"visible subcontainers: \" + visibleContainers.length + \":\" +visibleContainers, \"\\n\\ninvisible: \" + invisibleContainers.length + \":\" + invisibleContainers);\r\n        });\r\n      }\r\n      /**\r\n       * For debugging. Sets all primaryLayers subcontainers on the map as visible = true.\r\n       *\r\n       * @method window.FlaTWorld_mapMovement_deactivate\r\n       * @static\r\n       */\r\n      window.FlaTWorld_mapMovement_deactivate = function() {\r\n        map.getPrimaryLayers().forEach( layer => {\r\n          var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());\r\n          var visibleContainers, invisibleContainers;\r\n\r\n          visibleContainers = subcontainers.forEach(subcontainer => {\r\n            subcontainer.visible = false;\r\n          });\r\n        });\r\n      }\r\n    }\r\n    /**\r\n     * √çnitialize as a plugin\r\n     *\r\n     * @method addAll\r\n     * @param  {Map} map     Instance of Map\r\n     */\r\n    function addAll() {\r\n      var viewportArea;\r\n\r\n      viewportArea = map.getViewportArea();\r\n      Object.assign( viewportArea, getViewportsRightSideCoordinates(viewportArea) );\r\n      Object.assign( viewportArea , applyScaleToViewport(viewportArea, currentScale) );\r\n\r\n      map.getPrimaryLayers().forEach( layer => {\r\n        var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());\r\n\r\n        subcontainers.forEach(subcontainer => {\r\n          subcontainer.visible = isObjectOutsideViewport(subcontainer, viewportArea, false) ? false : true;\r\n        });\r\n      });\r\n    }\r\n    /**\r\n     * This one checks the that the objects that should currently be visible in the viewport area are visible and outside\r\n     * of the viewport objects are set .visible = false. This affect performance a lot. Basically when the map moves, we\r\n     * set a check in the future based on the given intervalCheck milliseconds. And immediately after it we check if there\r\n     * is another map movement. If there is we set another timeout. This works better with timeouts.\r\n     *\r\n     * This uses webWorkers. They seemed to speed up the check, when timing with performance.now.\r\n     *\r\n     * @method check\r\n     * @param  {Map} map        The current Map instance\r\n     * @return {Boolean}        True\r\n     */\r\n    function check() {\r\n      if (queue.processing) {\r\n        return false;\r\n      }\r\n      queue.processing = true;\r\n\r\n      let viewportFn = setupHandleViewportArea(queue, changedCoordinates);\r\n      window.setTimeout(viewportFn, CHECK_INTERVAL);\r\n\r\n      function setupHandleViewportArea(queue, changedCoordinates) {\r\n        var methodType = 1;\r\n        var viewportArea, smallerViewportArea, scaledViewport, smallerScaledViewportArea;\r\n\r\n        viewportArea = map.getViewportArea();\r\n\r\n        smallerViewportArea = getViewportCoordinates(viewportArea, 0.5);\r\n        Object.assign( viewportArea, getViewportCoordinates(viewportArea));\r\n\r\n        scaledViewport = applyScaleToViewport(viewportArea);\r\n        smallerScaledViewportArea = applyScaleToViewport(smallerViewportArea);\r\n\r\n        viewportWorkerOnMessage(scaledViewport, smallerScaledViewportArea);\r\n      }\r\n\r\n      return;\r\n    }\r\n    /**\r\n     * @method startEventListeners\r\n     * @param  {Map} map     Instance of Map\r\n     */\r\n    function startEventListeners() {\r\n      mapEvents.subscribe(\"mapMoved\", moveCb);\r\n      mapEvents.subscribe(\"mapResized\", resizeCb);\r\n      /* We change the scale factor ONLY if the map is zoomed. We reserve resources */\r\n      mapEvents.subscribe(\"mapZoomed\", zoomCb);\r\n\r\n      function moveCb(type) {\r\n        var movedCoordinates = type.customData[0];\r\n\r\n        changedCoordinates.width += movedCoordinates.x;\r\n        changedCoordinates.height += movedCoordinates.y;\r\n        check(map);\r\n      }\r\n      function resizeCb() {\r\n        check(map);\r\n      }\r\n      function zoomCb(ev) {\r\n        currentScale = ev.customData[0].newScale;\r\n      }\r\n    }\r\n    /*-----------------------\r\n    -------- PRIVATE --------\r\n    -----------------------*/\r\n    /**\r\n     * @private\r\n     * @static\r\n     * @method isObjectOutsideViewport\r\n     * @param  {Object}  object                 Object / layer we are testing\r\n     * @param  {Object} viewportArea            ViewportArea location and size\r\n     * @param  {Integer} viewportArea.x         X coordinate\r\n     * @param  {Integer} viewportArea.y         Y coordinate\r\n     * @param  {Integer} viewportArea.width     Viewports width (in pixels)\r\n     * @param  {Integer} viewportArea.height    Viewports height (in pixels)\r\n     * @param  {Boolean} hasParent              default = true\r\n     * @return {Boolean}\r\n     */\r\n    function isObjectOutsideViewport(object, viewportArea, hasParent = true) {\r\n      var isIt, globalCoords;\r\n\r\n      globalCoords = object.getSubcontainerArea(currentScale, { toGlobal: hasParent });\r\n\r\n      isIt = !testRectangleIntersect(globalCoords, viewportArea);\r\n\r\n      return isIt;\r\n    }\r\n    /**\r\n     * @private\r\n     * @static\r\n     * @method getViewportsRightSideCoordinates\r\n     * @private\r\n     * @param  {Object} viewportArea            ViewportArea location and size\r\n     * @param  {Integer} viewportArea.x         X coordinate\r\n     * @param  {Integer} viewportArea.y         Y coordinate\r\n     * @param  {Integer} viewportArea.width     Viewports width (in pixels)\r\n     * @param  {Integer} viewportArea.height    Viewports height (in pixels)\r\n     */\r\n    function getViewportsRightSideCoordinates(viewportArea) {\r\n      const offsetSize = Math.abs( viewportArea.width * VIEWPORT_OFFSET * 2 );\r\n\r\n      return {\r\n        x2: Math.round( viewportArea.x + Math.abs( viewportArea.width ) + offsetSize ),\r\n        y2: Math.round( viewportArea.y + Math.abs( viewportArea.height ) + offsetSize ),\r\n        width: Math.round( viewportArea.width + offsetSize ),\r\n        height: Math.round( viewportArea.height + offsetSize )\r\n      };\r\n    }\r\n    /**\r\n     * Calculates and modifies coordinates and size according to current scale / zoom on the map.\r\n     *\r\n     * @private\r\n     * @static\r\n     * @method applyScaleToViewport\r\n     * @private\r\n     * @param  {Object} viewportArea            ViewportArea location and size\r\n     * @param  {Integer} viewportArea.x         X coordinate\r\n     * @param  {Integer} viewportArea.y         Y coordinate\r\n     * @param  {Integer} viewportArea.width     Viewports width (in pixels)\r\n     * @param  {Integer} viewportArea.height    Viewports height (in pixels)\r\n     */\r\n    function applyScaleToViewport(viewportArea) {\r\n      return {\r\n        x: Math.round( viewportArea.x / currentScale ),\r\n        y: Math.round( viewportArea.y / currentScale ),\r\n        x2: Math.round( viewportArea.x2 / currentScale ),\r\n        y2: Math.round( viewportArea.y2 / currentScale ),\r\n        width: Math.round( viewportArea.width / currentScale ),\r\n        height: Math.round( viewportArea.height / currentScale )\r\n      };\r\n    }\r\n    /**\r\n     * The onmessage callback that handles things after we get reply from the worker\r\n     *\r\n     * @param  {Object} e   Event object from worker\r\n     */\r\n    function viewportWorkerOnMessage(scaledViewport, smallerScaledViewport) {\r\n      var containersUnderChangedArea = [];\r\n      var scaledAndChangedViewport;\r\n\r\n      scaledAndChangedViewport = Object.assign({}, scaledViewport);\r\n\r\n      scaledAndChangedViewport.width += Math.round(Math.abs(changedCoordinates.width));\r\n      scaledAndChangedViewport.height += Math.round(Math.abs(changedCoordinates.height));\r\n\r\n      /* RESET */\r\n      changedCoordinates.width = 0;\r\n      changedCoordinates.height = 0;\r\n\r\n      containersUnderChangedArea = map.getPrimaryLayers().map(layer => {\r\n        return layer.getSubcontainersByCoordinates(scaledAndChangedViewport);\r\n      });\r\n      containersUnderChangedArea = arrays.flatten2Levels(containersUnderChangedArea);\r\n\r\n      containersUnderChangedArea.forEach((thisContainer) => {\r\n        if (isObjectOutsideViewport(thisContainer, smallerScaledViewport, true)) {\r\n          thisContainer.visible = false;\r\n        } else {\r\n          thisContainer.visible = true;\r\n        }\r\n\r\n      });\r\n\r\n      queue.processing = false;\r\n\r\n      map.drawOnNextTick();\r\n\r\n    }\r\n    /**\r\n     * forms the total viewport parameters based on the given ones.\r\n     *\r\n     * @private\r\n     * @static\r\n     * @method getViewportCoordinates\r\n     * @param  {AreaSize} viewportArea          Given viewport area\r\n     * @param  {Number} offsetQuantifier        How big offset we match against\r\n     * @return {totalViewportArea}              The total viewportArea\r\n     */\r\n    function getViewportCoordinates(viewportArea, offsetQuantifier) {\r\n      var offsetSize = Math.abs( viewportArea.width * VIEWPORT_OFFSET  );\r\n      offsetQuantifier = offsetQuantifier || 1;\r\n\r\n      return {\r\n        x: Math.round( viewportArea.x - offsetSize * offsetQuantifier ),\r\n        y: Math.round( viewportArea.y - offsetSize * offsetQuantifier ),\r\n        x2: Math.round( viewportArea.x + Math.abs( viewportArea.width ) + offsetSize * offsetQuantifier ),\r\n        y2: Math.round( viewportArea.y + Math.abs( viewportArea.height ) + offsetSize * offsetQuantifier ),\r\n        width: Math.round( viewportArea.width + offsetSize * 2 * offsetQuantifier ),\r\n        height: Math.round( viewportArea.height + offsetSize * 2 * offsetQuantifier )\r\n      };\r\n    }\r\n    /**\r\n     * @private\r\n     * @static\r\n     * @method applyScaleToViewport\r\n     * @param  {AreaSize} viewportArea\r\n     * @return {totalViewportArea}        The total viewportArea\r\n     */\r\n    function applyScaleToViewport(viewportArea) {\r\n      return {\r\n        x: Math.round( viewportArea.x / currentScale ),\r\n        y: Math.round( viewportArea.y / currentScale ),\r\n        x2: Math.round( viewportArea.x2 / currentScale ),\r\n        y2: Math.round( viewportArea.y2 / currentScale ),\r\n        width: Math.round( viewportArea.width / currentScale ),\r\n        height: Math.round( viewportArea.height / currentScale )\r\n      };\r\n    }\r\n  }\r\n  /*-----------------------\r\n  -------- PRIVATE --------\r\n  -----------------------*/\r\n  /**\r\n   * @private\r\n   * @static\r\n   * @method testRectangleIntersect\r\n   */\r\n  function testRectangleIntersect(a, b) {\r\n    return (a.x <= b.x + b.width &&\r\n            b.x <= a.x + a.width &&\r\n            a.y <= b.y + b.height &&\r\n            b.y <= a.y + a.height);\r\n  }\r\n})();","(function () {\r\n  \"use strict\";\r\n\r\n  window.flatworld.UIs.default.utils = window.flatworld.UIs.default.utils || {};\r\n  window.flatworld.UIs.default.utils.drawShapes = (function() {\r\n    return {\r\n      normal: drawArrow,\r\n      arced: drawArcedArrow\r\n    };\r\n\r\n    /* =============== Functions for drawing arrows ================ */\r\n\r\n    // From the website: http://www.dbp-consulting.com/tutorials/canvas/CanvasArrow.html\r\n    /*\r\n      @param {int} x1,y1 - the line of the shaft starts here\r\n      @param {int} x2,y2 - the line of the shaft ends here\r\n      @param {int or function} style - type of head to draw\r\n          0 - filled head with back a curve drawn with arcTo\r\n              n.b. some browsers have an arcTo bug that make this look bizarre\r\n          1 - filled head with back a straight line\r\n          2 - unfilled but stroked head\r\n          3 - filled head with back a curve drawn with quadraticCurveTo\r\n          4 - filled head with back a curve drawn with bezierCurveTo\r\n              function(ctx,x0,y0,x1,y1,x2,y2,style) - a function provided by the user to draw the head. Point (x1,y1) is the same as the end of the line, and (x0,y0) and (x2,y2) are the two back corners. The style argument is the this for the function. An example that just draws little circles at each corner of the arrow head is shown later in this document.\r\n          default 3 (filled head with quadratic back)\r\n      @param {int} which - which end(s) get the arrow\r\n          0 - neither\r\n          1 - x2,y2 end\r\n          2 - x1,y1 end\r\n          3 - (that's 1+2) both ends\r\n          default 1 (destination end gets the arrow)\r\n      @param {float} angle - the angle Œ∏ from shaft to one side of arrow head - default œÄ/8 radians (22 1/2¬∞, half of a 45¬∞)\r\n      @param {int} length - the distance d in pixels from arrow point back along the shaft to the back of the arrow head - default 10px\r\n\r\n      Passing in a custom head drawing routine, ie:\r\n      var headDrawer=function(ctx,x0,y0,x1,y1,x2,y2,style)\r\n      {\r\n          var radius=3;\r\n          var twoPI=2*Math.PI;\r\n          ctx.save();\r\n          ctx.beginPath();\r\n          ctx.arc(x0,y0,radius,0,twoPI,false);\r\n          ctx.stroke();\r\n          ctx.beginPath();\r\n          ctx.arc(x1,y1,radius,0,twoPI,false);\r\n          ctx.stroke();\r\n          ctx.beginPath();\r\n          ctx.arc(x2,y2,radius,0,twoPI,false);\r\n          ctx.stroke();\r\n          ctx.restore();\r\n      }\r\n\r\n      Modified to support easelJS (no context editing, instead graphics-object)\r\n\r\n      */\r\n    function drawArrow( shape, x1, y1, x2, y2, style, which, angle, d ) {\r\n      var graphics = shape.graphics,\r\n         color = \"#000\",\r\n         angle1, topx, topy, angle2, botx, boty;\r\n\r\n      /* Ceason pointed to a problem when x1 or y1 were a string, and\r\n          concatenation would happen instead of addition */\r\n      if ( typeof ( x1 ) === 'string' ) x1 = parseInt( x1, 10 );\r\n      if ( typeof ( y1 ) == 'string' ) y1 = parseInt( y1, 10 );\r\n      if ( typeof ( x2 ) == 'string' ) x2 = parseInt( x2, 10 );\r\n      if ( typeof ( y2 ) == 'string' ) y2 = parseInt( y2, 10 );\r\n      style = typeof ( style ) != 'undefined' ? style : 3;\r\n      which = typeof ( which ) != 'undefined' ? which : 1; // end point gets arrow\r\n      angle = typeof ( angle ) != 'undefined' ? angle : Math.PI / 8;\r\n      d = typeof ( d ) != 'undefined' ? d : 10;\r\n      // default to using drawHead to draw the head, but if the style\r\n      // argument is a function, use it instead\r\n      var toDrawHead = typeof ( style ) != 'function' ? drawHead : style;\r\n\r\n      /* For ends with arrow we actually want to stop before we get to the arrow\r\n          so that wide lines won't put a flat end on the arrow. */\r\n      var dist = Math.sqrt( ( x2 - x1 ) * ( x2 - x1 ) + ( y2 - y1 ) * ( y2 - y1 ) );\r\n      var ratio = ( dist - d / 3 ) / dist;\r\n      var tox, toy, fromx, fromy;\r\n      if ( which & 1 ) {\r\n        tox = Math.round( x1 + ( x2 - x1 ) * ratio );\r\n        toy = Math.round( y1 + ( y2 - y1 ) * ratio );\r\n      } else {\r\n        tox = x2;\r\n        toy = y2;\r\n      }\r\n      if ( which & 2 ) {\r\n        fromx = x1 + ( x2 - x1 ) * ( 1 - ratio );\r\n        fromy = y1 + ( y2 - y1 ) * ( 1 - ratio );\r\n      } else {\r\n        fromx = x1;\r\n        fromy = y1;\r\n      }\r\n\r\n      /* Original: Draw the shaft of the arrow\r\n         ctx.beginPath();\r\n         ctx.moveTo(fromx,fromy);\r\n         ctx.lineTo(tox,toy);\r\n         ctx.stroke(); */\r\n\r\n      // Modified easelJS-version:\r\n      graphics.beginStroke( color )\r\n         .moveTo( fromx, fromy )\r\n         .lineTo( tox, toy );\r\n\r\n      // calculate the angle of the line\r\n      var lineangle = Math.atan2( y2 - y1, x2 - x1 );\r\n      // h is the line length of a side of the arrow head\r\n      var h = Math.abs( d / Math.cos( angle ) );\r\n\r\n      if ( which & 1 ) { // handle far end arrow head\r\n        angle1 = lineangle + Math.PI + angle;\r\n        topx = x2 + Math.cos( angle1 ) * h;\r\n        topy = y2 + Math.sin( angle1 ) * h;\r\n        angle2 = lineangle + Math.PI - angle;\r\n        botx = x2 + Math.cos( angle2 ) * h;\r\n        boty = y2 + Math.sin( angle2 ) * h;\r\n        toDrawHead( graphics, topx, topy, x2, y2, botx, boty, style );\r\n      }\r\n      if ( which & 2 ) { // handle near end arrow head\r\n        angle1 = lineangle + angle;\r\n        topx = x1 + Math.cos( angle1 ) * h;\r\n        topy = y1 + Math.sin( angle1 ) * h;\r\n        angle2 = lineangle - angle;\r\n        botx = x1 + Math.cos( angle2 ) * h;\r\n        boty = y1 + Math.sin( angle2 ) * h;\r\n        toDrawHead( graphics, topx, topy, x1, y1, botx, boty, style );\r\n      }\r\n\r\n      return true;\r\n\r\n      function drawHead( graphics, x0, y0, x1, y1, x2, y2, style ) {\r\n        var backdist;\r\n        x0 = +x0, y0 = +y0, x1 = +x1, y1 = +y1, x2 = +x2, y2 = +y2;\r\n        // all cases do this.\r\n        graphics.beginStroke( \"#F00\" )\r\n           .moveTo( x0, y0 )\r\n           .lineTo( x1, y1 )\r\n           .lineTo( x2, y2 );\r\n        switch ( style ) {\r\n          case 0:\r\n            // curved filled, add the bottom as an arcTo curve and fill\r\n            backdist = Math.sqrt( ( ( x2 - x0 ) * ( x2 - x0 ) ) + ( ( y2 - y0 ) * ( y2 -\r\n               y0 ) ) );\r\n            graphics.arcTo( x1, y1, x0, y0, 0.55 * backdist );\r\n            graphics.fill();\r\n            break;\r\n          case 1:\r\n            // straight filled, add the bottom as a line and fill.\r\n            graphics.beginStroke( \"#F00\" )\r\n               .moveTo( x0, y0 )\r\n               .lineTo( x1, y1 )\r\n               .lineTo( x2, y2 )\r\n               .lineTo( x0, y0 )\r\n               .fill();\r\n            break;\r\n          case 2:\r\n            // unfilled head, just stroke.\r\n            break;\r\n          case 3:\r\n            //filled head, add the bottom as a quadraticCurveTo curve and fill\r\n            var cpx = ( x0 + x1 + x2 ) / 3;\r\n            var cpy = ( y0 + y1 + y2 ) / 3;\r\n            graphics.beginFill()\r\n               .quadraticCurveTo( cpx, cpy, x0, y0 );\r\n            break;\r\n          case 4:\r\n            //filled head, add the bottom as a bezierCurveTo curve and fill\r\n            var cp1x, cp1y, cp2x, cp2y;\r\n            var shiftamt = 5;\r\n            if ( x2 === x0 ) {\r\n              // Avoid a divide by zero if x2==x0\r\n              backdist = y2 - y0;\r\n              cp1x = ( x1 + x0 ) / 2;\r\n              cp2x = ( x1 + x0 ) / 2;\r\n              cp1y = y1 + backdist / shiftamt;\r\n              cp2y = y1 - backdist / shiftamt;\r\n            } else {\r\n              backdist = Math.sqrt( ( ( x2 - x0 ) * ( x2 - x0 ) ) + ( ( y2 - y0 ) * ( y2 -\r\n                 y0 ) ) );\r\n              var xback = ( x0 + x2 ) / 2;\r\n              var yback = ( y0 + y2 ) / 2;\r\n              var xmid = ( xback + x1 ) / 2;\r\n              var ymid = ( yback + y1 ) / 2;\r\n\r\n              var m = ( y2 - y0 ) / ( x2 - x0 );\r\n              var dx = ( backdist / ( 2 * Math.sqrt( m * m + 1 ) ) ) / shiftamt;\r\n              var dy = m * dx;\r\n              cp1x = xmid - dx;\r\n              cp1y = ymid - dy;\r\n              cp2x = xmid + dx;\r\n              cp2y = ymid + dy;\r\n            }\r\n\r\n            graphics.bezierCurveTo( cp1x, cp1y, cp2x, cp2y, x0, y0 );\r\n            graphics.fill();\r\n            break;\r\n        }\r\n      }\r\n    }\r\n    function drawArcedArrow( graphics, x, y, r, startangle, endangle, anticlockwise,\r\n       style, which, angle, d ) {\r\n      var sx, sy, lineangle, destx, desty;\r\n\r\n      style = typeof ( style ) != 'undefined' ? style : 3;\r\n      which = typeof ( which ) != 'undefined' ? which : 1; // end point gets arrow\r\n      angle = typeof ( angle ) != 'undefined' ? angle : Math.PI / 8;\r\n      d = typeof ( d ) != 'undefined' ? d : 10;\r\n      // Old: ctx.save();\r\n      graphics.beginPath();\r\n      graphics.arc( x, y, r, startangle, endangle, anticlockwise );\r\n      graphics.stroke();\r\n\r\n      graphics.strokeStyle = 'rgba(0,0,0,0)'; // don't show the shaft\r\n      if ( which & 1 ) { // draw the destination end\r\n        sx = Math.cos( startangle ) * r + x;\r\n        sy = Math.sin( startangle ) * r + y;\r\n        lineangle = Math.atan2( x - sx, sy - y );\r\n\r\n        if ( anticlockwise ) {\r\n          destx = sx + 10 * Math.cos( lineangle );\r\n          desty = sy + 10 * Math.sin( lineangle );\r\n        } else {\r\n          destx = sx - 10 * Math.cos( lineangle );\r\n          desty = sy - 10 * Math.sin( lineangle );\r\n        }\r\n        drawArrow( graphics, sx, sy, destx, desty, style, 2, angle, d );\r\n      }\r\n      if ( which & 2 ) { // draw the origination end\r\n        sx = Math.cos( endangle ) * r + x;\r\n        sy = Math.sin( endangle ) * r + y;\r\n        lineangle = Math.atan2( x - sx, sy - y );\r\n        if ( anticlockwise ) {\r\n          destx = sx - 10 * Math.cos( lineangle );\r\n          desty = sy - 10 * Math.sin( lineangle );\r\n        } else {\r\n          destx = sx + 10 * Math.cos( lineangle );\r\n          desty = sy + 10 * Math.sin( lineangle );\r\n        }\r\n        drawArrow( graphics, sx, sy, destx, desty, style, 2, angle, d );\r\n      }\r\n    }\r\n    /* =============================== */\r\n  })();\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var Handlebars = window.flatworld_libararies.Handlebars;\r\n\r\n  window.flatworld.UIs = window.flatworld.UIs || {};\r\n  window.flatworld.UIs.default = window.flatworld.UIs.default || {};\r\n  window.flatworld.UIs.default.templates = {\r\n    multiSelection: Handlebars.compile(`\r\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\r\n        {{title}}\r\n      </span>\r\n      <ul>\r\n        {{#each objects}}\r\n        <li>\r\n          {{this.data.typeData.name}}\r\n        </li>\r\n        {{/each}}\r\n      </ul>`),\r\n    singleSelection: Handlebars.compile(`\r\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\r\n        {{title}}\r\n      </span>\r\n      <ul>\r\n        <li>\r\n          {{object.name}}\r\n        </li>\r\n      </ul>`)\r\n  };\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  // This is only for testing, so we don't set it here... var $ = require('assets/lib/jquery/jquery-css-ajax-effects.min.js');\r\n  var templates = window.flatworld.UIs.default.templates;\r\n  var createVisibleHexagon = window.flatworld.extensions.hexagons.utils.createVisibleHexagon;\r\n  var UITemplateBase = window.flatworld.UITemplateBase;\r\n  var UI = window.flatworld.UI;\r\n  //import { drawShapes } from 'components/map/UIs/default/utils/arrows';\r\n\r\n  /*---------------------\r\n  ------ VARIABLES ------\r\n  ----------------------*/\r\n  const FADE_ANIMATION = \"slow\";\r\n  var cssClasses = {\r\n    select: \"#dialog_select\"\r\n  };\r\n  var $elements = {};\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  class UIDefault extends UITemplateBase {\r\n    /**\r\n     * The simplest default UI implementation. Implemented UI functionalities for: showSelections, highlightSelectedObject\r\n     *\r\n     * @class UIDefault\r\n     * @constructor\r\n     * @requires Handlebars\r\n     * @requires hexagon extension\r\n     * @requires jQuery\r\n     * @todo  should take jQuery away from this, as soon as we refactor the animations and graphics for selections\r\n     * @param  {HTMLElement} modal\r\n     * @param  {Map} map\r\n     * @param  {Object} options\r\n     */\r\n    constructor(modal, map, options = { styles: \"#F0F0F0\" }) {\r\n      super(cssClasses);\r\n      // Add a media (and/or media query) here if you'd like!\r\n      // style.setAttribute(\"media\", \"screen\")\r\n      // style.setAttribute(\"media\", \"only screen and (max-width : 1024px)\")\r\n\r\n      this.map = map;\r\n      this.modal = modal || document.getElementById(\"dialog_select\");\r\n      this.styles = options.styles;\r\n    }\r\n    /**\r\n     * @method getTemplates\r\n     * Required by the map/core/UI.js API\r\n     */\r\n    getTemplates() {\r\n      return templates;\r\n    }\r\n    /**\r\n     * Required by the map.UI API\r\n     *\r\n     * @method showSelections\r\n     * @param  {Object} objects     Objects that have been selected. See core.UI for more information\r\n     * @param {Object} getDatas       See explanation in core.UI\r\n     * @param {Object} options        Extra options\r\n     */\r\n    showSelections(objects, getDatas, options) {\r\n      var updateCB = this.map.drawOnNextTick.bind(this.map);\r\n      var UILayer = this.map.getMovableLayer();\r\n      var cb;\r\n\r\n      /* We add the objects to be highlighted to the correct UI layer */\r\n      //objectsToUI(UILayer, objects);\r\n\r\n      if (objects && objects.length > 1) {\r\n        cb = () => {\r\n          this.modal.innerHTML = templates.multiSelection({\r\n            title: \"Objects\",\r\n            objects\r\n          });\r\n\r\n          this.showModal(this.modal, cssClasses);\r\n\r\n          console.log(objects);\r\n\r\n          _get$Element(\"select\").fadeIn(FADE_ANIMATION);\r\n        };\r\n      } else if (objects.length === 1) {\r\n        cb = () => {\r\n          this.highlightSelectedObject(objects[0]);\r\n\r\n          console.log(objects);\r\n        };\r\n      } else {\r\n        cb = () => {\r\n          UILayer.emptyUIObjects();\r\n          updateCB();\r\n          console.log(\"Error occured selecting the objects on this coordinates! Nothing found\");\r\n        };\r\n      }\r\n\r\n      _get$Element(\"select\").fadeOut(FADE_ANIMATION, cb);\r\n    }\r\n    /**\r\n     * Required by the map.UI API\r\n     *\r\n     * @method highlightSelectedObject\r\n     * @param  {Object} object        Object that has been selected. See core.UI for more information\r\n     * @param {Object} getDatas       See explanation in core.UI\r\n     * @param {Object} options        Extra options. Like dropping a shadow etc.\r\n     */\r\n    highlightSelectedObject(object, getDatas, options = {shadow: { color: \"0x0000\", distance: 5, alpha: 0.55, angle: 45, blur: 5 }}) {\r\n      var { shadow } = options;\r\n      var highlightableObject, objectDatas;\r\n\r\n      objectDatas = getDatas.allData(object);\r\n\r\n      this.modal.innerHTML = templates.singleSelection({\r\n        title: \"Selected\",\r\n        object: {\r\n          name: objectDatas.name\r\n        }\r\n      });\r\n      this.showModal(this.modal, cssClasses);\r\n\r\n      highlightableObject = this._highlightSelectedObject(object, this.map.getRenderer());\r\n\r\n      highlightableObject.dropShadow({\r\n        color: shadow.color,\r\n        distance: shadow.distance,\r\n        alpha: shadow.alpha,\r\n        angle: shadow.angle,\r\n        blur: shadow.blur\r\n      });\r\n\r\n      this.map.drawOnNextTick();\r\n\r\n      _get$Element(\"select\").fadeIn(FADE_ANIMATION);\r\n\r\n      return highlightableObject;\r\n    }\r\n    /**\r\n     * @method showUnitMovement\r\n     */\r\n    showUnitMovement() {}\r\n    /**\r\n     * @method init\r\n     */\r\n    init() {}\r\n\r\n    /*----------------------\r\n    ------- PRIVATE --------\r\n    ----------------------*/\r\n    /**\r\n     * @private\r\n     * @static\r\n     * @method _highlightSelectedObject\r\n     * @param  {Object} object\r\n     * @param  {MapLayer} movableLayer\r\n     * @param  {PIXI.Renderer} renderer\r\n     */\r\n    _highlightSelectedObject(object, renderer) {\r\n      var movableLayer = this.map.getMovableLayer();\r\n      var clonedObject;\r\n\r\n      clonedObject = object.clone(renderer);\r\n      clonedObject.__proto__ = object.__proto__;\r\n\r\n      var coord = object.toGlobal(new PIXI.Point(0,0));\r\n      coord = movableLayer.toLocal(coord);\r\n\r\n      coord.x -= object.width * object.anchor.x;\r\n      coord.y -= object.height * object.anchor.y;\r\n\r\n      this.createHighlight(clonedObject, { coords: coord });\r\n\r\n      return clonedObject;\r\n    }\r\n    /**\r\n     * @private\r\n     * @static\r\n     * @method createHighlight\r\n     */\r\n    createHighlight(object, options = { coords: new PIXI.Point(0, 0) }) {\r\n      var radius = 47;\r\n      var movableLayer = this.map.getMovableLayer();\r\n      var container = new this.map.createSpecialLayer(\"UILayer\", { toLayer: movableLayer});\r\n      var objCoords = {\r\n        x: Number(object.x),\r\n        y: Number(object.y)\r\n      };\r\n      var highlighterObject;\r\n\r\n      highlighterObject = createVisibleHexagon(radius, { color: \"#F0F0F0\" });\r\n      highlighterObject.x = objCoords.x + 32;\r\n      highlighterObject.y = objCoords.y + 27;\r\n\r\n      highlighterObject.alpha = 0.5;\r\n\r\n      /* We add the children first to subcontainer, since it's much easier to handle the x and y in it, rather than\r\n       * handle graphics x and y */\r\n      container.addChild(highlighterObject);\r\n      container.addChild(object);\r\n\r\n      container.position = options.coords;\r\n\r\n      this.map.removeUIObject(this.map.layerTypes.movableType.id, [container])\r\n      this.map.addUIObjects(this.map.layerTypes.movableType.id, [container]);\r\n    }\r\n\r\n  }\r\n\r\n  /*----------------------\r\n  ------- PRIVATE --------\r\n  ----------------------*/\r\n  /**\r\n   * @private\r\n   * @static\r\n   * @method _get$Element\r\n   * @param  {[type]} which [description]\r\n   * @return {[type]}       [description]\r\n   */\r\n  function _get$Element(which) {\r\n    /* Set the jQuery element to collection only once */\r\n    if (!$elements[which]) {\r\n      let $element = $(cssClasses[which]);\r\n      $elements[which] = $element;\r\n    }\r\n\r\n    return $elements[which];\r\n  }\r\n\r\n  window.flatworld.UIs.default.init = UIDefault;\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var Q = window.flatworld_libararies.Q;\r\n  var mapLayers = window.flatworld.mapLayers;\r\n  var Objects = window.flatworld.Objects;\r\n  var ObjectManager = window.flatworld.ObjectManager;\r\n  var mapEvents = window.flatworld.mapEvents;\r\n  var utils = window.flatworld.utils;\r\n  var MapDataManipulator = window.flatworld.MapDataManipulator;\r\n\r\n  /*---------------------\r\n  ------ VARIABLES ------\r\n  ----------------------*/\r\n  const LAYER_TYPE_STATIC = 0;\r\n  const LAYER_TYPE_MOVABLE = 1;\r\n  const VERSION = \"0.0.1\";\r\n  var _drawMapOnNextTick = false;\r\n  var isMapReadyPromises = [];\r\n  var _staticLayer, _movableLayer, _renderer, ParentLayerConstructor;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  class Flatworld {\r\n    /**\r\n     * #Main class for the engine\r\n     *\r\n     * Initializes the whole structure and plugins and is used as primary API for all operations. This class is e.g. passed to every plugin that get initialized with their init-method.\r\n     *\r\n     * You use the class by instantiating it (new) and then finishing initialization with init-method. Please see examples below.\r\n     *\r\n     * The biggest part of creating the map, is the data structure. There is a clear data structure that you can see from the tests/data-folder, but the factory is responsible for creating the objects, so you can use your own factory implementation. So to understand more, please see e.g. factories.horizontalHexaFactory.\r\n     *\r\n     * The map consists of layer on top of each other. The example is best understood when thinking typical war strategy game. The structure is this:\r\n     * 1. StaticLayer: Handles things like scaling / zooming the map\r\n     * 2. MovableLayer: Obviously handles movement of the map. Also is a good place to get map coordinates. Since getting global coordinates won't help you much, half of the time.\r\n     * 3. Different layers: like units, terrain, fog of war, UIs etc. Can also contains special layers like dynamically changed UIlayers.\r\n     * 4. possible subcontainers (used for optimized object selection and map movement). Can also contains special layers like dynamically changed UIlayers.\r\n     * 5. Individual objects, like units, terrains, cities etc...\r\n     *\r\n     * Plugins can be added with activatePlugins-method by sending them to the class. Plugins must always implement init-method, which receives Map instance. Plugins are not yet restricted what they can do and can add functionality without touching map or can modify objects or their prototypes through access to Map instance.\r\n     *\r\n     * @example\r\n     *     var map = new Map(divContainer, mapOptions );\r\n     *     promises = map.init( gameData.pluginsToActivate, mapData.startPoint );\r\n     *\r\n     * @class Map\r\n     * @constructor\r\n     * @requires PIXI.JS framework in global namespace\r\n     * @requires Canvas (webGL support recommended) HTML5-element supported.\r\n     * @requires Q for promises\r\n     * @requires Hammer for touch events\r\n     * @requires Hamster for mouse scroll events\r\n     *\r\n     * @param {HTMLElement} canvasContainer                 HTML element which will be container for the created canvas element. REQUIRED\r\n     * @param {Object} props                                Extra properties\r\n     * @param {Object} props.bounds                         Bounds of the map / mapSize\r\n     * @param {Integer} props.bounds.width                  Bound width\r\n     * @param {Integer} props.bounds.height                 Bound height\r\n     * @param {Object} props.rendererOptions                Renderer options passed to PIXI.autoDetectRenderer\r\n     * @param {Object} props.subcontainers                  Subcontainers size in pixels. If given, will activate subcontainers. If not given or false, subcontainers are not used.area.\r\n     * @param {Integer} props.subcontainers.width           Subcontainer width\r\n     * @param {Integer} props.subcontainers.height          Subcontainer height\r\n     * @param {FPSCallback} trackFPSCB                      Callback function for tracking FPS in renderer. So this is used for debugging and optimizing.\r\n     *\r\n     * @return {Object}                                      New Map instance\r\n     */\r\n    constructor(canvasContainer = null,\r\n        props = {\r\n          bounds: { width: 0, height: 0 },\r\n          rendererOptions: { refreshEventListeners: true },\r\n          subcontainers: false,\r\n          cache: false,\r\n          trackFPSCB: false }) {\r\n      var { bounds, rendererOptions, subcontainers, trackFPSCB, cache } = props;\r\n\r\n      /* Check for the required parameters! */\r\n      if (!canvasContainer) {\r\n        throw new Error(this.constructor.name + \" needs canvasContainer!\");\r\n      }\r\n      /* If the constructor was passed canvasContainer as a string and not as an Element, we get the element */\r\n      if (typeof canvasContainer === \"string\") {\r\n        canvasContainer = document.querySelector(canvasContainer);\r\n      }\r\n\r\n      /* Create PIXI renderer. Practically PIXI creates its own canvas and does its magic to it */\r\n      _renderer = PIXI.autoDetectRenderer(bounds.width, bounds.height, rendererOptions);\r\n      /* We handle all the events ourselves through addEventListeners-method on canvas, so destroy pixi native method */\r\n      _renderer.plugins.interaction.destroy();\r\n      /* Make sure the canvasContainer is empty. So there are no nasty surprises */\r\n      canvasContainer.innerHTML = \"\";\r\n      /* Add the canvas Element PIXI created inside the given canvasContainer */\r\n      canvasContainer.appendChild(_renderer.view, canvasContainer);\r\n      /* This defines which MapLayer class we use to generate layers on the map. Under movableLayer. These are layers like: Units, terrain, fog of war, UIs etc. */\r\n      ParentLayerConstructor = subcontainers ? mapLayers.MapLayerParent : mapLayers.MapLayer;\r\n\r\n      /* These are the 2 topmost layers on the map:\r\n       * - staticLayer: Keeps at the same coordinates always and is responsible for holding map scale value and possible\r\n       * objects that do not move with the map. StaticLayer has only one child: _movableLayer\r\n       * - movableLayer: Moves the map, when the user commands. Can hold e.g. UI objects that move with the map. Like\r\n       * graphics that show which area or object is currently selected. */\r\n      _staticLayer = new mapLayers.MapLayer({ name:\"staticLayer\", coord: { x: 0, y: 0 } });\r\n      _movableLayer = new mapLayers.MapLayer({ name:\"movableLayer\", coord: { x: 0, y: 0 } });\r\n      _staticLayer.addChild(_movableLayer);\r\n\r\n      /* needed to make the canvas fullsize canvas with PIXI */\r\n      _renderer.view.style.position = \"absolute\";\r\n      _renderer.view.style.display = \"block\";\r\n      _renderer.view.style.left = \"0px\";\r\n      _renderer.view.style.top = \"0px\";\r\n      /* stop scrollbars of showing */\r\n      document.getElementsByTagName(\"body\")[0].style.overflow = \"hidden\";\r\n      /* For html5 canvas. I guess it doesn't apply for webgl */\r\n      _renderer.roundPixels = true;\r\n\r\n      /**\r\n       * canvas element that was generated and is being used by this new generated Map instance.\r\n       *\r\n       * @attribute canvas\r\n       * @type {HTMLElement}\r\n       * @required\r\n       **/\r\n      this.canvas = _renderer.view;\r\n      /**\r\n       * list of plugins that the map uses and are initialized\r\n       * @see Map.activatePlugins\r\n       *\r\n       * @attribute plugins\r\n       * @type {Set}\r\n       **/\r\n      this.plugins = new Set();\r\n      /**\r\n       * Subcontainers size that we want to generate, when layers use subcontainers\r\n       *\r\n       * @attribute subcontainersConfig\r\n       * @type {{width: Integer, height: Int}}\r\n       **/\r\n      this.subcontainersConfig = subcontainers;\r\n      /**\r\n       * Callback function that gets the current FPS on the map and shows it in DOM\r\n       *\r\n       * @attribute trackFPSCB\r\n       * @type {Function}\r\n       **/\r\n      this.trackFPSCB = trackFPSCB;\r\n      /**\r\n       * ObjectManager instance. Responsible for retrieving the objects from the map, on desired occasions. Like when the player clicks the map to select some object. This uses subcontainers when present.\r\n       *\r\n       * @attribute objectManager\r\n       * @type {ObjectManager}\r\n       **/\r\n      this.objectManager = new ObjectManager(new PIXI.interaction.InteractionManager(_renderer));\r\n      /**\r\n       * Is cache activated for this map at all. This is set for individual layers with a property, but without activating the cache for the whole map, the layers cache property is ignored.\r\n       *\r\n       * @attribute objectManager\r\n       * @type {ObjectManager}\r\n       **/\r\n      this.cache = cache;\r\n      /**\r\n       * Layer types. Can be extended, but the already defined types are supposed to be constants and not to be changed.\r\n       *\r\n       * @attribute layerTypes\r\n       * @type {Object}\r\n       */\r\n      this.layerTypes = {\r\n        staticType: {\r\n          id: LAYER_TYPE_STATIC,\r\n          layer: _staticLayer\r\n        },\r\n        movableType: {\r\n          id: LAYER_TYPE_MOVABLE,\r\n          layer: _movableLayer\r\n        }\r\n      };\r\n      /**\r\n       * Self explanatory\r\n       * @type {SEMVER}     http://semver.org/\r\n       */\r\n      this.VERSION = VERSION;\r\n    }\r\n    /**\r\n     * This initializes the map and makes everything appear on the map and actually work. Also initializes the given plugins since normally the plugins have to be activated before the map is shown.\r\n     *\r\n     * @method init\r\n     * @param {String[]|Object[]} plugins                  Plugins to be activated for the map. Normally you should give the plugins here\r\n     * instead of separately passing them to activatePlugins method. You can provide the module strings or module objects.\r\n     * @param  {Object} coord                     Starting coordinates for the map.\r\n     * @param  {Integer} coord.x                  X coordinate.\r\n     * @param  {Integer} coord.y                  Y coordinate.\r\n     * @param {Function} tickCB                   callback function for tick. Tick callback is initiated in every frame. So map draws happen during ticks.\r\n     * @param {Object} options                    Extra options.\r\n     * @param {Boolean} options.fullsize          Do we set fullsize canvas or not at the beginning. Default: true\r\n     * @return {Array}                            Returns an array of Promises. If this is empty / zero. Then there is nothing to wait for, if it contains promises, you have to wait for them to finish for the plugins to work and map be ready.\r\n     **/\r\n    init(plugins = [], coord = { x: 0, y: 0 }, tickCB = null, options = { fullsize: true }) {\r\n      var allPromises = [];\r\n\r\n      options.fullsize && this.toggleFullsize();\r\n\r\n      if (plugins.length) {\r\n        allPromises = this.activatePlugins(plugins);\r\n      }\r\n\r\n      /* Sets the correct Map starting coordinates */\r\n      coord && Object.assign(_movableLayer, coord);\r\n\r\n      /* We activate the default tick for the map, but if custom tick callback has been given, we activate it too */\r\n      this._defaultTick();\r\n      tickCB && this.customTickOn(tickCB);\r\n      isMapReadyPromises = allPromises;\r\n\r\n      if (this.cache) {\r\n        this.cacheMap();\r\n      }\r\n\r\n      this.drawOnNextTick();\r\n\r\n      return allPromises || Promise.resolve();\r\n    }\r\n    /**\r\n     * Returns a promise that resolves after the map is fully initialized\r\n     *\r\n     * @method whenReady\r\n     * @return {Promise}        Promise that holds all the individual plugin loading promises\r\n     **/\r\n    whenReady() {\r\n      return Q.all(isMapReadyPromises);\r\n    }\r\n    /**\r\n     * The correct way to update / redraw the map. Check happens at every tick and thus in every frame.\r\n     *\r\n     * @method drawOnNextTick\r\n     **/\r\n    drawOnNextTick() {\r\n      _drawMapOnNextTick = true;\r\n    }\r\n    /**\r\n     * Add an UI object to the wanted layer.\r\n     *\r\n     * @method addUIObject\r\n     * @param {Integer} layer   Type of the layer. layerTypes.STATIC of layerTypes.MOVABLE.\r\n     * @param {Object} object   The object to be attached as UI object.\r\n     */\r\n    addUIObject(layerType, object) {\r\n      switch (layerType) {\r\n        case LAYER_TYPE_STATIC:\r\n          this.getStaticLayer().addUIObject(object);\r\n          break;\r\n        case LAYER_TYPE_MOVABLE:\r\n          this.getMovableLayer().addUIObject(object);\r\n          break;\r\n      }\r\n    }\r\n    /**\r\n     * Remove an UI object to the wanted layer.\r\n     *\r\n     * @method removeUIObject\r\n     * @param {Integer} layer   Type of the layer. layerTypes.STATIC of layerTypes.MOVABLE.\r\n     * @param {Object} object   The object to be attached as UI object.\r\n     */\r\n    removeUIObject(layerType, object) {\r\n      switch (layerType) {\r\n        case LAYER_TYPE_STATIC:\r\n          this.getStaticLayer().emptyUIObjects();\r\n          break;\r\n        case LAYER_TYPE_MOVABLE:\r\n          this.getMovableLayer().emptyUIObjects();\r\n          break;\r\n      }\r\n    }\r\n    /**\r\n     * Adds an UI object to the map. This method adds it to the given layer and removes it with removeUIObject-method.\r\n     *\r\n     * @method addUIObjects\r\n     * @param {Integer} layerType     map.layerTypes holds the constants used in this.\r\n     * @param {Array} objects         Object that are added as UI objects\r\n     */\r\n    addUIObjects(layerType, objects) {\r\n      objects.forEach(object => {\r\n        this.addUIObject(layerType, object);\r\n      });\r\n    }\r\n    /**\r\n     * Create a special layer, that can holds e.g. UI effects in it.\r\n     *\r\n     * @method createSpecialLayer\r\n     * @param {String} name               name of the layer\r\n     * @param {Object} options            Optional options.\r\n     * @param {Object} options.coord      Coordinates of the layer\r\n     * @param {Integer} options.coord.x   X coordinate\r\n     * @param {Integer} options.coord.y   Y coordinate\r\n     * @param {Object} options.toLayer    To which layer will this layer be added to as UILayer\r\n     * @return {MapLayer}            The created UI layer\r\n     **/\r\n    createSpecialLayer(name = \"default special layer\", options = { coord: { x: 0, y: 0 }, toLayer }) {\r\n      var coord = options.coord || { x: 0, y: 0 };\r\n      var layer = new mapLayers.MapLayer(name, coord);\r\n\r\n      layer.specialLayer = true;\r\n      options.toLayer && options.toLayer.addChild(layer);\r\n\r\n      return layer;\r\n    }\r\n    /**\r\n     * All parameters are passed to ParentLayerConstructor (normally constructor of MapLayer).\r\n     *\r\n     * @method addLayer\r\n     * @uses MapLayer\r\n     * @return {MapLayer}          created MapLayer instance\r\n     **/\r\n    addLayer(layerOptions) {\r\n      var newLayer;\r\n\r\n      if (this.getSubcontainerConfigs () && layerOptions.subcontainers !== false) {\r\n        layerOptions.subcontainers = this.getSubcontainerConfigs ();\r\n      }\r\n\r\n      newLayer = new ParentLayerConstructor(layerOptions);\r\n      this.getMovableLayer().addChild(newLayer);\r\n\r\n      return newLayer;\r\n    }\r\n    /**\r\n     * Just a convenience function (for usability and readability), for checking if the map uses subcontainers.\r\n     *\r\n     * @method usesSubcontainers\r\n     **/\r\n    usesSubcontainers() {\r\n      return this.getSubcontainerConfigs () ? true : false;\r\n    }\r\n    /**\r\n     * Returns current subcontainers configurations (like subcontainers size).\r\n     *\r\n     * @method getSubcontainerConfigs\r\n     **/\r\n    getSubcontainerConfigs () {\r\n      return this.subcontainersConfig;\r\n    }\r\n    /**\r\n     * Get the size of the area that is shown to the player. More or less the area of the browser window.\r\n     *\r\n     * @method getViewportArea\r\n     * @param  {Boolean} isLocal                                                  Do we want to use Map coordinates or global / canvas coordinates. Default = false\r\n     * @return {{x: Integer, y: Integer, width: Integer, height: Integer}}        x- and y-coordinates and the width and height of the viewport\r\n     **/\r\n    getViewportArea(isLocal = false) {\r\n      var layer = isLocal ? this.getMovableLayer() : this.getStaticLayer();\r\n\r\n      return {\r\n        x: layer.x,\r\n        y: layer.y,\r\n        width: Math.round(window.innerWidth),\r\n        height: Math.round(window.innerHeight)\r\n      };\r\n    }\r\n    /**\r\n     * Remove a primary layer from the map\r\n     *\r\n     * @method removeLayer\r\n     * @param {MapLayer|PIXI.Container|PIXI.ParticleContainer} layer       The layer object to be removed\r\n     **/\r\n    removeLayer(layer) {\r\n      _movableLayer.removeChild(layer);\r\n\r\n      return layer;\r\n    }\r\n    /**\r\n     * Moves the map the amount of given x and y pixels. Note that this is not the destination coordinate, but the amount of movement that the map should move. Internally it moves the movableLayer, taking into account necessary properties (like scale). Draws map after movement.\r\n     *\r\n     * @method moveMap\r\n     * @param {Object} coord                 The amount of x and y coordinates we want the map to move. I.e. { x: 5, y: 0 }. With this we want the map to move horizontally 5 pixels and vertically stay at the same position.\r\n     * @param {Integer} coord.x              X coordinate\r\n     * @param {Integer} coord.y              Y coordinate\r\n     * @param {Object} informCoordinates     THIS IS EXPERIMENTAL, TO FIX THE INCORRECT EVENT COORDINATES THIS SEND TO mapEvents, WHEN SCALING\r\n     * @param {Integer} informCoordinates.x  X coordinate\r\n     * @param {Integer} informCoordinates.y  Y coordinate\r\n     **/\r\n    moveMap(coord = { x: 0, y: 0 }, informCoordinates = coord) {\r\n      var realCoordinates = {\r\n        x: Math.round(coord.x / this.getStaticLayer().getZoom()),\r\n        y: Math.round(coord.y / this.getStaticLayer().getZoom())\r\n      };\r\n      _movableLayer.move(realCoordinates);\r\n      mapEvents.publish(\"mapMoved\", informCoordinates || realCoordinates);\r\n      this.drawOnNextTick();\r\n    }\r\n    /**\r\n     * Is cache on\r\n     *\r\n     * @method isCacheActivated\r\n     * @return {Boolean}\r\n     **/\r\n    isCacheActivated() {\r\n      return this.cache;\r\n    }\r\n    /**\r\n     * Cache the map. This provides performance boost when used correctly. CacheMap iterates through all the layers on the map and caches the ones that return true from isCached-method. NOT WORKING YET. CACHING IMPLEMENTED SOON.\r\n     *\r\n     * @method cacheMap\r\n     * @param {Object} filters          filters from MapDataManipulator.js\r\n     **/\r\n    cacheMap(filters) {\r\n      cacheLayers(true, this.usesSubcontainers());\r\n    }\r\n    /**\r\n     * unCache the map. NOT WORKING ATM. IMPLEMENTED SOON!\r\n     *\r\n     * @method unCacheMap\r\n     * @return {Map}        this map instance\r\n     * */\r\n    unCacheMap() {\r\n      cacheLayers(false, this.usesSubcontainers());\r\n    }\r\n    /**\r\n     * Activate all plugins for the map. Iterates through the given plugins we wish to activate and does the actual work in activatePlugin-method.\r\n     *\r\n     * @method pluginsArray\r\n     * @param {Object[]} pluginsArray   Array that consists the plugin modules to be activated\r\n     * @return {Promise}                Promise. If string are provided resolved those with System.import, otherwise resolves immediately.\r\n     * */\r\n    activatePlugins(pluginsArray = []) {\r\n      var allPromises = [];\r\n\r\n      /* Iterates over given plugins Array and calls their init-method, depeding if it is String or Object */\r\n      pluginsArray.forEach(plugin => {\r\n        if (typeof plugin === \"object\") {\r\n          this.activatePlugin(plugin);\r\n        } else {\r\n          throw new Error(\"problem with initializing a plugin\");\r\n        }\r\n      });\r\n\r\n      return allPromises;\r\n    }\r\n    /**\r\n     * Activate plugin for the map. Plugins need .pluginName property and .init-method. Plugins init-method activates the plugins and we call them in Map. Plugins init-metho receivse this (Map instance) as their only parameter.\r\n     *\r\n     * @method activatePlugin\r\n     * @param {Object} plugin        Plugin module\r\n     * */\r\n    activatePlugin(plugin) {\r\n      try {\r\n        if (!plugin || !plugin.pluginName || !plugin.init) {\r\n          throw new Error(\"plugin, plugin.pluginName or plugin.init import is missing!\");\r\n        }\r\n\r\n        if (this.plugins.add(plugin[plugin.pluginName])) {\r\n          plugin.init(this);\r\n        }\r\n      } catch (e) {\r\n        console.log(\"An error initializing plugin. JSON.stringify: '\" + JSON.stringify(plugin) + \"' \", e);\r\n      }\r\n    }\r\n    /**\r\n     * Setting new prototype methods for the Map instance\r\n     *\r\n     * @method setPrototype\r\n     * @param {String} property         The property you want to set\r\n     * @param {*} value                 Value for the property\r\n     */\r\n    setPrototype(property, value) {\r\n      var thisPrototype = Object.getPrototypeOf(this);\r\n\r\n      thisPrototype[property] = value;\r\n    }\r\n    /**\r\n     * Gets object under specific map coordinates. Uses the ObjectManagers retrieve method. Using subcontainers if they exist, other methods if not. If you provide type parameter, the method returns only object types that match it.\r\n     *\r\n     * @method getObjectsUnderArea\r\n     * @param  {Object} globalCoords            Event coordinates on the staticLayer / canvas.\r\n     * @param  {Integer} globalCoords.x         X coordinate\r\n     * @param  {Integer} globalCoords.y         Y coordinate\r\n     * @param  {Object} options                 Optional options\r\n     * @param  {Object} options.filter          The filter to apply to subcontainers\r\n     * @return {Array}                          Array of object found on the map.\r\n     */\r\n    getObjectsUnderArea(globalCoords = { x: 0, y: 0, width: 0, height: 0 }, options = { filter: undefined }) {\r\n      var { filter } = options;\r\n      /* We need both coordinates later on and it's logical to do the work here */\r\n      var allCoords = {\r\n        globalCoords: globalCoords,\r\n        localCoords: this.getMovableLayer().toLocal(new PIXI.Point(globalCoords.x, globalCoords.y))\r\n      };\r\n      var objects = {};\r\n\r\n      allCoords.localCoords.width = globalCoords.width;\r\n      allCoords.localCoords.height = globalCoords.height;\r\n      if (filter) {\r\n        let selectableContainerfilter = new MapDataManipulator({\r\n            type: \"filter\",\r\n            object: \"container\",\r\n            property: \"selectable\",\r\n            value: true\r\n          });\r\n        filter.addRule(selectableContainerfilter);\r\n      }\r\n\r\n      if (this.usesSubcontainers()) {\r\n        let allMatchingSubcontainers = this._getSubcontainersUnderArea(allCoords, { filter } );\r\n\r\n        objects = this._retrieveObjects(allCoords, {\r\n          subcontainers: allMatchingSubcontainers\r\n        });\r\n      }\r\n\r\n      return objects;\r\n    }\r\n    /**\r\n     * This returns the normal parent layers that we mostly use for manipulation everything. MovableLayer and staticLayer are built-in layers designed to provide the basic functionalities like zooming and moving the map. These layers provide everything that extends the map more.\r\n     *\r\n     * @method getPrimaryLayers\r\n     * @return {Object} Basically anything in the map that is used as a layer (not really counting subcontainers).\r\n     */\r\n    getPrimaryLayers () {\r\n      return this.getMovableLayer().getPrimaryLayers();\r\n    }\r\n    /**\r\n     * Get current map coordinates. Basically the same as movable layers position.\r\n     *\r\n     * @method getMapCoordinates\r\n     * @return {{x: Integer, y: Integer}}          current coordinates for the moved map\r\n     * */\r\n    getMapCoordinates() {\r\n      return {\r\n        x: this.getMovableLayer().x,\r\n        y: this.getMovableLayer().y\r\n      };\r\n    }\r\n    /**\r\n     * This returns the layer that is responsible for map zoom\r\n     *\r\n     * @method getZoomLayer\r\n     * @return {MapLayer|PIXI.Container|PIXI.ParticleContainer}\r\n     */\r\n    getZoomLayer() {\r\n      return this.getStaticLayer();\r\n    }\r\n    /**\r\n     * Set map zoom. 1 = no zoom. <1 zoom out, >1 zoom in.\r\n     *\r\n     * @method setZoom\r\n     * @param {Number} scale    The amount of zoom you want to set\r\n     * @return {Number}         The amount of zoom applied\r\n     */\r\n    setZoom(newScale) {\r\n      mapEvents.publish(\"mapZoomed\", { previousScale: this.getZoom(), newScale });\r\n\r\n      return this.getZoomLayer().setZoom(newScale);\r\n    }\r\n    /**\r\n     * Get map zoom. 1 = no zoom. <1 zoom out, >1 zoom in.\r\n     *\r\n     * @method getZoom\r\n     * @return {MapLayer|PIXI.Container|PIXI.ParticleContainer}\r\n     */\r\n    getZoom() {\r\n      return this.getZoomLayer().getZoom();\r\n    }\r\n    /**\r\n     * Returns movable layer. This layer is the one that moves when the player moves the map. So this is used for things that are relative to the current map position the player is seeing. This can be used e.g. when you want to display some objects on the map or UI elements, like effects that happen on certain point on the map.\r\n     *\r\n     * @method getMovableLayer\r\n     * @return {MapLayer|PIXI.Container|PIXI.ParticleContainer}\r\n     */\r\n    getMovableLayer() {\r\n      return _movableLayer;\r\n    }\r\n    /**\r\n     * Returns the PIXI renderer. Some situations might need this. For more advanced or PIXI specific cases.\r\n     *\r\n     * @method getRenderer\r\n     * @return {PIXI.Renderer}\r\n     */\r\n    getRenderer() {\r\n      return _renderer;\r\n    }\r\n    /**\r\n     * Return static layer. The static layer is the topmost of all layers. It handles zooming and other non-movable operations.\r\n     *\r\n     * @method getStaticLayer\r\n     */\r\n    getStaticLayer() {\r\n      return _staticLayer;\r\n    }\r\n    /*---------------------------------------------\r\n     ------- ABSTRACT APIS THROUGH PLUGINS --------\r\n     --------------------------------------------*/\r\n     /**\r\n      * This is abstract method and needs to be implemented with a plugin. Core module has an implementation for this and if you don't implement your own, I suggest you use it.\r\n      *\r\n      * @method zoomIn\r\n      */\r\n    zoomIn() { return \"notImplementedYet. Activate with plugin\"; }\r\n     /**\r\n      * This is abstract method and needs to be implemented with a plugin. Core module has an implementation for this and if you don't implement your own, I suggest you use it.\r\n      *\r\n      * @method zoomOut\r\n      */\r\n    zoomOut() { return \"notImplementedYet. Activate with plugin\"; }\r\n    /**\r\n     * Resize the canvas to fill the whole browser content area. Defined by the baseEventlisteners-module (core modules plugin)\r\n     *\r\n     * @method toggleFullsize\r\n     **/\r\n    toggleFullsize() { return \"notImplementedYet. Activate with plugin\"; }\r\n    /**\r\n     * Toggles fullscreen mode. Defined by the baseEventlisteners-module (core modules plugin)\r\n     *\r\n     * @method toggleFullScreen\r\n     **/\r\n    toggleFullScreen () { return \"notImplementedYet. Activate with plugin\"; }\r\n\r\n    /*-------------------------\r\n    --------- PRIVATE ---------\r\n    -------------------------*/\r\n    /**\r\n     * Retrieves the objects from ObjectManager, with the given parameters. Mostly helper functionality for getObjectsUnderArea\r\n     *\r\n     * @private\r\n     * @method _retrieveObjects\r\n     * @param {Object} allCoords                        REQUIRED\r\n     * @param {Object} allCoords.globalCoords           REQUIRED\r\n     * @param {Integer} allCoords.globalCoords.x        REQUIRED\r\n     * @param {Integer} allCoords.globalCoords.y        REQUIRED\r\n     * @param {Integer} allCoords.globalCoords.width    REQUIRED\r\n     * @param {Integer} allCoords.globalCoords.height   REQUIRED\r\n     * @param {Object} allCoords.localCoords            REQUIRED\r\n     * @param {Integer} allCoords.localCoords.x         REQUIRED\r\n     * @param {Integer} allCoords.localCoords.y         REQUIRED\r\n     * @param {Object} options                          Optional options\r\n     * @param {String} options.type                     The type of objects we want\r\n     * @param {Array} options.subcontainers             Array of the subcontainers we will search\r\n     * @return {Array}                                  Found objects\r\n     */\r\n    _retrieveObjects(allCoords, options = { type: \"\", subcontainers: [] }) {\r\n      return this.objectManager.retrieve(allCoords, {\r\n        type: options.type,\r\n        subcontainers: options.subcontainers,\r\n        size: {\r\n          width: allCoords.globalCoords.width,\r\n          height: allCoords.globalCoords.height\r\n        }\r\n      });\r\n    }\r\n    /**\r\n     * This returns layers by filtering them based on certain attribute. Can be used with more higher order filtering\r\n     *\r\n     * @private\r\n     * @method _getLayersWithAttributes\r\n     * @param {String} attribute\r\n     * @param {*} value\r\n     * @return the current map instance\r\n     **/\r\n    _getLayersWithAttributes(attribute, value) {\r\n      return this.getMovableLayer().children[0].children.filter(layer => {\r\n        return layer[attribute] === value;\r\n      });\r\n    }\r\n    /**\r\n     * Get subcontainers under certain point or rectangle\r\n     *\r\n     * @private\r\n     * @method _getSubcontainersUnderPoint\r\n     * @param  {[type]} globalCoords\r\n     * @param {Object} options              Optional options.\r\n     * @return {Array}                        All subcontainers that matched the critea\r\n     */\r\n    _getSubcontainersUnderArea(allCoords, options = { filter: undefined } ) {\r\n      var primaryLayers = this.getMovableLayer().getPrimaryLayers();\r\n      var allMatchingSubcontainers = [];\r\n      var { filter } = options;\r\n      var thisLayersSubcontainers;\r\n\r\n      primaryLayers.forEach(layer => {\r\n        thisLayersSubcontainers = layer.getSubcontainersByCoordinates(allCoords.globalCoords, { filter: filter });\r\n        allMatchingSubcontainers = allMatchingSubcontainers.concat(thisLayersSubcontainers);\r\n      });\r\n\r\n      return allMatchingSubcontainers;\r\n    }\r\n    /**\r\n     * Activate the browsers fullScreen mode and expand the canvas to fullsize\r\n     *\r\n     * @private\r\n     * @method setFullScreen\r\n     */\r\n    _setFullScreen() {\r\n      utils.resize.toggleFullScreen();\r\n      mapEvents.publish(\"mapResized\");\r\n      this._resizeCanvas();\r\n    }\r\n    /**\r\n     * Resizes the canvas to the current most wide and high element status. Basically canvas size === window size.\r\n     *\r\n     * @private\r\n     * @method _resizeCanvas\r\n     */\r\n    _resizeCanvas() {\r\n      let windowSize = utils.resize.getWindowSize();\r\n\r\n      _renderer.autoResize = true;\r\n      _renderer.resize(windowSize.x, windowSize.y);\r\n      mapEvents.publish(\"mapResized\");\r\n      this.drawOnNextTick();\r\n    }\r\n    /**\r\n     * This handles the default drawing of the map, so that map always updates when drawOnNextTick === true. This tick\r\n     * callback is always set and should not be removed or overruled\r\n     *\r\n     * @private\r\n     * @method _defaultTick\r\n     */\r\n    _defaultTick() {\r\n      const ONE_SECOND = 1000;\r\n      var FPSCount = 0;\r\n      var fpsTimer = new Date().getTime();\r\n      var renderStart, totalRenderTime;\r\n\r\n      PIXI.ticker.shared.add(function () {\r\n        if (_drawMapOnNextTick === true) {\r\n          if (this.trackFPSCB) {\r\n            renderStart = new Date().getTime();\r\n          }\r\n\r\n          _renderer.render(_staticLayer);\r\n          _drawMapOnNextTick = false;\r\n\r\n          if (this.trackFPSCB) {\r\n            totalRenderTime += Math.round( Math.abs( renderStart - new Date().getTime() ) );\r\n          }\r\n        }\r\n        if (this.trackFPSCB) {\r\n          FPSCount++;\r\n\r\n          if (fpsTimer + ONE_SECOND < new Date().getTime()) {\r\n            this.trackFPSCB( {\r\n              FPS: FPSCount,\r\n              FPStime: fpsTimer,\r\n              renderTime: totalRenderTime,\r\n              drawCount: _renderer.drawCount\r\n            });\r\n\r\n            FPSCount = 0;\r\n            totalRenderTime = 0;\r\n            fpsTimer = new Date().getTime();\r\n          }\r\n        }\r\n      }.bind(this));\r\n    }\r\n  }\r\n\r\n  /*---------------------\r\n  ------- PRIVATE -------\r\n  ----------------------*/\r\n  /**\r\n   * cacheLayers\r\n   *\r\n   * @method cacheLayers\r\n   * @private\r\n   * @static\r\n   * @param  {Boolean}  cacheOrNot        Do you want to cache or uncache?\r\n   * @param  {Boolean} hasSubcontainers   Does the map have subcontainers activated?\r\n   */\r\n  function cacheLayers(cacheOrNot, hasSubcontainers) {\r\n    if (hasSubcontainers) {\r\n      _movableLayer.children.forEach(child => {\r\n        if (!child.isCached()) {\r\n          return false;\r\n        }\r\n        var subcontainers = child.getSubcontainers();\r\n\r\n        subcontainers.forEach(subcontainer => {\r\n          subcontainer.setCache(cacheOrNot);\r\n        })\r\n      });\r\n    } else {\r\n      _movableLayer.children.forEach(child => {\r\n        if (!child.isCached()) {\r\n          return false;\r\n        }\r\n\r\n        child.setCache(cacheOrNot);\r\n      });\r\n    }\r\n  }\r\n\r\n  window.flatworld.Flatworld = Flatworld;\r\n})();","(function () {\r\n  'use strict';\r\n\r\n  /*---------------------\r\n  ------- IMPORT --------\r\n  ----------------------*/\r\n  var PIXI = window.flatworld_libararies.PIXI;\r\n  var UIDefault = window.flatworld.UIs.default.init;\r\n  var hexagonPlugin = window.flatworld.extensions.hexagons;\r\n  var Flatworld = window.flatworld.Flatworld;\r\n  var UI = window.flatworld.UI;\r\n  var utils = window.flatworld.utils;\r\n\r\n  /*---------------------\r\n  --------- API ---------\r\n  ----------------------*/\r\n  window.flatworld.factories.hexaFactory = hexaFactory;\r\n\r\n  /*---------------------\r\n  ------- PUBLIC --------\r\n  ----------------------*/\r\n  /**\r\n   * This constructs a whole horizontally aligned hexagonal map. Some polyfills are needed and added for IE11 ( http://babeljs.io/docs/usage/polyfill/ ). These are found in utils\r\n   *\r\n   * @class factories.horizontalHexaFactory\r\n   * @requires PIXI in global space\r\n   * @param {HTMLElement} canvasContainerElement  HTML Element. Container which will hold the generated canvas element\r\n   * @param {Object} datas                        Object with mapDatas to construct the map structure\r\n   * @param {Object} datas.map                    Holds all the stage, layer and object data needed to construct a full map\r\n   * @param {Object} datas.game                   More general game data (like turn number, map size etc.)\r\n   * @param {Object} datas.type                   Type data such as different unit types and their graphics (tank, soldier etc.)\r\n   * @param {Object} options                      Optional options\r\n   * @param {Object} options.isHiddenByDefault    When we use mapMovement plugin, it is best to keep all the obejcts hidden at the beginnig.\r\n   * @param {Function} options.trackFPSCB         Callback to track FPS\r\n   **/\r\n  function hexaFactory(canvasContainerElement, datas, options = { trackFPSCB: false, isHiddenByDefault: true, cache: false }) {\r\n    console.log(\"============== Horizontal hexagonal Map factory started =============\");\r\n    const pixelRatio = utils.environmentDetection.getPixelRatio();\r\n    const DATA_MAP = (typeof datas.map === \"string\") ? JSON.parse(datas.map) : datas.map;\r\n    const DATA_TYPE = (typeof datas.type === \"string\") ? JSON.parse(datas.type) : datas.type;\r\n    const DATA_GAME = (typeof datas.game === \"string\") ? JSON.parse(datas.game) : datas.game;\r\n    const WINDOW_SIZE = utils.resize.getWindowSize();\r\n    const MAP_SIZE = DATA_GAME.mapSize;\r\n    const mapOptions = {\r\n      refreshEventListeners: true\r\n    };\r\n    /*---------------------\r\n    ------ VARIABLES ------\r\n    ----------------------*/\r\n    const functionsInObj = {\r\n      ObjectTerrain: hexagonPlugin.objects.ObjectHexaTerrain,\r\n      ObjectUnit: hexagonPlugin.objects.ObjectHexaUnit\r\n    };\r\n    var mapProperties = {\r\n      bounds: {\r\n        x: 0,\r\n        y: 0,\r\n        width: WINDOW_SIZE.x,\r\n        height: WINDOW_SIZE.y\r\n      },\r\n      rendererOptions: {\r\n        resolution: pixelRatio, // We might need this later on, when doing mobile optimizations, for different pizel density devices\r\n        autoResize: true,\r\n        transparent: true,\r\n        antialias: false // TEST. Only should work in chrome atm.?\r\n      },\r\n      subcontainers: {\r\n        width: 500,\r\n        height: 500,\r\n        maxDetectionOffset: 100,\r\n        isHiddenByDefault: options.isHiddenByDefault\r\n      },\r\n      trackFPSCB: options.trackFPSCB,\r\n      cache: options.cache\r\n    };\r\n    var map, dialog_selection, defaultUI;\r\n\r\n    map = new Flatworld(canvasContainerElement, mapProperties, mapOptions );\r\n    dialog_selection = document.getElementById(\"selectionDialog\");\r\n    defaultUI = new UIDefault(dialog_selection, map);\r\n\r\n    /* Initialize UI as singleton */\r\n    UI(defaultUI, map);\r\n\r\n    DATA_MAP.layers.forEach( layerData => {\r\n      if (typeof layerData !== \"object\") {\r\n        console.log(\"Problem in horizontalHexaFactory, with layerData:\", layerData);\r\n        throw new Error(\"Problem in horizontalHexaFactory, with layerData:\", layerData);\r\n      }\r\n\r\n      var layerGroup = layerData.group;\r\n      var objManager = map.objectManager;\r\n      var renderer = map.getRenderer();\r\n      var layerOptions = {\r\n        name: layerData.name,\r\n        coord: layerData.coord,\r\n        drawOutsideViewport: {\r\n          x: renderer.width,\r\n          y: renderer.height\r\n        },\r\n        selectable: layerData.name === \"unitLayer\" ? true : false\r\n      };\r\n      var thisLayer;\r\n\r\n      try {\r\n        thisLayer = map.addLayer(layerOptions);\r\n\r\n        layerData.objectGroups.forEach( objectGroup => {\r\n          let spritesheetType = objectGroup.typeImageData;\r\n\r\n          if (!spritesheetType) {\r\n            console.log(\"Error with spritesheetType-data\");\r\n            return;\r\n          }\r\n\r\n          objectGroup.objects.forEach( object => {\r\n            var objTypeData, objData, objectOptions, currentFrame, newObject;\r\n\r\n            try {\r\n              objTypeData = DATA_TYPE.objectData[spritesheetType][object.objType];\r\n              if (!objTypeData) {\r\n                console.debug(\"Bad mapData for type:\", spritesheetType, object.objType, object.name);\r\n                throw new Error(\"Bad mapData for type:\", spritesheetType, object.objType, object.name);\r\n              }\r\n\r\n              objData = {\r\n                typeData: objTypeData,\r\n                activeData: object.data\r\n              };\r\n              currentFrame = PIXI.Texture.fromFrame(objTypeData.image);\r\n              objectOptions = {\r\n                currentFrame,\r\n                radius: DATA_GAME.hexagonRadius\r\n              };\r\n\r\n              newObject = new functionsInObj[objectGroup.type]( object.coord, objData, objectOptions );\r\n\r\n              thisLayer.addChild(newObject);\r\n            } catch (e) {\r\n              console.log(e);\r\n            }\r\n          });\r\n        });\r\n      } catch (e) {\r\n        console.log(\"Problem:\", layerData.type, e.stack);\r\n      }\r\n    });\r\n\r\n    map.moveMap(DATA_MAP.startPoint);\r\n\r\n    return map;\r\n  }\r\n})();"],"sourceRoot":"/source/"}