<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">core/Map_layers.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/Map.js~Map.html">Map</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/Map_layers.js~Map_layer.html">Map_layer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/Map_layers.js~Map_parentLayer.html">Map_parentLayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/ObjectManager.js~ObjectManager.html">ObjectManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/Objects.js~Object_sprite.html">Object_sprite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/Objects.js~Object_sprite_terrain.html">Object_sprite_terrain</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/Objects.js~Object_sprite_unit.html">Object_sprite_unit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/UI_themeBase.js~UI_templateBase.html">UI_templateBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UI">UI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mapEvents">mapEvents</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">move</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-map_drag">map_drag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pluginName">pluginName</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/core/utils/Quadtree.js~Quadtree.html">Quadtree</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dataManipulation">dataManipulation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-effects">effects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-utils">utils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-environmentDetection">environmentDetection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-general">general</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mouse">mouse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-resize">resize</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">zoom</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-map_zoom">map_zoom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pluginName">pluginName</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">core/Map_layers.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

/***********************
****** VARIABLES *******
***********************/
var _UIObjects = [];

/***********************
******** EXPORT ********
***********************/
export class Map_layer extends PIXI.Container {
  /**
   * Creates a basic layer for the Map. This type of layer can not hold subcontainers. Note that different devices and graphic cards can only have specific size of bitmap drawn, and PIXI cache always draws a bitmap thus the default is: 4096, based on this site: http://webglstats.com/ and MAX_TEXTURE_SIZE. This is important also when caching.
   *
   * @param {Object} options                            optional options
   * @param {String} options.name                       Layers name, used for identifying the layer. Useful in debugging, but can be used for finding correct layers too
   * @param {{x: Integer, y: Integer}} options.coord    coord starting coords of layer. Relative to parent map layer.
   * @param {Boolean} options.specialLayer              Is this layer special (e.g. UILayer not included in normal operations)
   **/
  constructor(options = {
      name: &quot;&quot;,
      coord: { x: 0, y: 0 },
      specialLayer: false } ) {
    var { name, coord, specialLayer } = options;

    super();
    Object.assign(this, coord);

    /**
     * Layers name, used for identifying the layer. Useful in debugging, but can be used for finding correct layers too
     *
     * @attribute
     * @type {String}
     */
    this.name = &quot;&quot; + name;
    /**
     * Is this layer special (e.g. UILayer not included in normal operations)
     *
     * @attribute
     * @type {Boolean}
     */
    this.specialLayer = !!specialLayer;
  }
  /**
   * Does this layer use subcontainers.
   *
   * @return {Boolean} true = uses subcontainers.
   */
  hasSubContainers() {
    return this.subContainersConfig ? true : false;
  }
  /**
   * Is this layer cached at the moment or not.
   *
   * @return {Boolean} true = is cached
   */
  getCurrentCache() {
    return this.cacheAsBitmap;
  }
  /**
   * Move layer based on given amounts
   *
   * @param {{x: Integer, y: Integer}} coord        The amount of x and y coordinates we want the layer to move. I.e. { x: 5, y: 0 }. This would move the map 5 pixels horizontally and 0 pixels vertically
   **/
  move(coord) {
    this.x += coord.x;
    this.y += coord.y;
    this.drawThisChild = true;
  }
  /**
   * set layer scale
   *
   * @param {Number} amount The amount that you want the layer to scale.
   * @return {Number} The same amount that was given, except after transform to 2 decimals and type cast to Number
   * */
  setScale(amount) {
    this.scale.x = this.scale.y = +amount.toFixed(2);

    return this.scale.x;
  }
  /**
   * get layer scale
   *
   * @return {Boolean} current amount of scale
   * */
  getScale() {
    return this.scale.x;
  }
    /**
   * get UIObjects on this layer, if there are any, or defaulty empty array if no UIObjects are active
   *
   * @return {Array} current UIObjects
   * */
  getUIObjects() {
    return _UIObjects;
  }
  /**
   * Remove all the UIObjects from this layer
   *
   * @return {Array} empty UIObjects array
   * */
  emptyUIObjects() {
    _UIObjects.map(obj =&gt; {
      this.removeChild(obj);
      obj = null;
    });

    return _UIObjects;
  }
  /**
   * Add UIObjects to this layer
   *
   * @param {Object || Array} objects           Objects can be an object containing one object to add or an Array of objects to add.
   * @return {Array}                            All the UIObjects currently on this layer
   * */
  addUIObjects(objects) {
    _UIObjects = _UIObjects || [];
    if (Array.isArray(objects)) {
      objects.forEach( (/*thisObj*/) =&gt; {
        /* We want to make a copy of the object, since if add existing child from another container to UI,
         * it will get removed from the original container and messes up the hierarchy. Probably making a deep copy
         * directly isn&apos;t the best way, but it&apos;s the easiest atm. */
        //let newObj = utils.general.deepCopy(thisObj);

        //this.addChild(newObj);
      });
    } else {
      //let newObj = utils.general.deepCopy(objects);
      let newObj = objects;

      newObj.specialLayer = true;
      this.addChild( newObj );
    }
    _UIObjects.push( objects );

    return _UIObjects;
  }
  /**
   * Get primary layers, that this layer holds as children. So basically all children that are not special layers (such as UI layers etc.)
   *
   * @return {Array}                            Primary children layers under this layer
   * */
  getPrimaryLayers() {
    return this.children.filter(thisChild =&gt; {
      return !thisChild.specialLayer;
    });
  }
  /**
   * Get all objects that are this layers children or subcontainers children. Does not return layers, but the objects.
   *
   * @return {Array}                            All the objects (not layers) found under this layer
   * */
  getObjects() {
    var allObjects = [];

    if (this.hasSubContainers()) {
      this.subContainerList.forEach(subcontainer =&gt; {
        allObjects.concat(subcontainer.children);
      });
    }

    return allObjects;
  }
  /**
   * @method setCache
   *
   * @param {Boolean} status      true = activate cache, false = disable cache
   */
  setCache(status) {
    var toCacheStatus = status ? true : false;

    this.cacheAsBitmap = toCacheStatus;

    return toCacheStatus;
  }
}

export class Map_parentLayer extends Map_layer {
  /**
   * Layer designed to hold subcontainers. But can handle objects too.
   *
   * @param {String}        name layer property name, used for identifiying the layer, usefull in debugging, but used also
   * otherwise too!
   * @param {x: Number, y: Number}  coord starting coords of layer. Relative to parent map layer.
   *
   * Different devices graphic cards can only have specific size of bitmap drawn, and PIXI cache always draws a bitmap
   * thus the default is: 4096, based on this site: http://webglstats.com/ and MAX_TEXTURE_SIZE
   */
  constructor(options = { name: &quot;&quot;, coord: { x: 0, y: 0 }, subContainers: false, specialLayer: false } ) {
    var { subContainers } = options;

    super(options);

    this.oldAddChild = super.addChild.bind(this);
    this.subContainersConfig = subContainers;
    this.subContainerList = [];
  }
  addChild(displayObject) {
    if (this.hasSubContainers()) {
      let correctContainer;
      correctContainer = setCorrectSubContainer(displayObject, this);
      this.oldAddChild(correctContainer);
    } else {
      this.oldAddChild(displayObject);
    }

    return displayObject;
  }
  getSubContainerConfigs() {
    return this.subContainersConfig;
  }
  getSubContainersByCoordinates(coordinates) {
    if (!this.hasSubContainers()) {
      throw new Error(&quot;tried to retrieve subContainers, when they are not present&quot;);
    }

    var foundSubcontainers, tempCoordinates;

    tempCoordinates = this.toLocal(new PIXI.Point(coordinates.x, coordinates.y));
    tempCoordinates.width = coordinates.width;
    tempCoordinates.height = coordinates.height;

    foundSubcontainers = getClosestSubcontainers(this, tempCoordinates);

    return foundSubcontainers;
  }
  getSubcontainers() {
    return this.subContainerList;
  }
}

class Map_subContainer extends PIXI.ParticleContainer {
  /**
   * Subcontainers are containers that hold objects like units and terrain etc. under them. They have some restrictions atm. since they are PIXI.ParticleContainers. But when needed we can extend Map_layers with another class which is subcontainer, but not ParticleContainer at the present there is no need, so we won&apos;t extend yet. Subcontainers help the layers to make better movement of the map, by making subcontainers visible or invisible and even helping with selecting objects on the map. Thus we don&apos;t need to use our inefficient Quadtree.
   *
   * NOTICE! PIXI.ParticleContainer is much more strict than normal containers. When you encounter issues with it. Please check the restrictions on ParticleContainer.
   *
   * @param {{width: Integer, height: Integer}} size          Size of the subcontainer
   */
  constructor(size) {
    super();

    this.specialLayer = true;
    this.size = size;
  }
  /**
   * Gets this subcontainers coordinates and size
   *
   * @param {Number} scale                              The size of scale the map currently has
   * @param {{toGlobal: Boolean}} options.toGlobal      Do we get the global coordinates or local
   */
  getSubcontainerArea (scale, options = { toGlobal: true } ) {
    var coordinates;

    coordinates = options.toGlobal ? this.toGlobal(new PIXI.Point(0, 0)) : this;
    if (scale) {
      coordinates.x /= scale;
      coordinates.y /= scale;
    }

    return {
      x: Math.round( coordinates.x ),
      y: Math.round( coordinates.y ),
      width: Math.round( this.size.width ),
      height: Math.round( this.size.height )
    };
  }
  /**
   * Set cache on or off for this layer
   *
   * @param {Boolean} status      true = activate cache, false = disable cache
   */
  setCache(status) {
    var toCacheStatus = status ? true : false;

    this.cacheAsBitmap = toCacheStatus;

    return toCacheStatus;
  }
}
/***********************
******* PRIVATE ********
***********************/
/**
 * [setCorrectSubContainer description]
 *
 * @private
 * @param {[type]} displayObject [description]
 * @param {[type]} parentLayer   [description]
 */
function setCorrectSubContainer(displayObject, parentLayer) {
  var { subContainersConfig, subContainerList } = parentLayer;
  var xIndex = Math.floor( displayObject.x / subContainersConfig.width );
  var yIndex = Math.floor( displayObject.y / subContainersConfig.height );
  var thisSubcontainer;

  subContainerList[xIndex] = subContainerList[xIndex] || [];
  thisSubcontainer = subContainerList[xIndex][yIndex] = subContainerList[xIndex][yIndex] || [];

  if (subContainerList[xIndex][yIndex].length &lt;= 0) {
    thisSubcontainer = new Map_subContainer({
      x: xIndex * subContainersConfig.width,
      y: yIndex * subContainersConfig.height,
      width: subContainersConfig.width,
      height: subContainersConfig.height
    });

    subContainerList[xIndex][yIndex] = thisSubcontainer;
    thisSubcontainer.x = xIndex * subContainersConfig.width;
    thisSubcontainer.y = yIndex * subContainersConfig.height;
    thisSubcontainer.visible = subContainersConfig.isHiddenByDefault ? false : true;
  }

  displayObject.x -= thisSubcontainer.x;
  displayObject.y -= thisSubcontainer.y;
  subContainerList[xIndex][yIndex].addChild(displayObject);

  return subContainerList[xIndex][yIndex];
}
/**
 * Get the closest subcontainers of the given area.
 *
 * @private
 * @param  {PIXI.Container} layer     The layer being used
 * @param  {Number} xIndex            x / horizontal index.
 * @param  {Number} yIndex            y / vertical index.
 * @return {Array}                    Array of found subcontainers.
 */
function getClosestSubcontainers(layer, givenCoordinates) {
  var coordinates = {
    x: givenCoordinates.x &gt;= 0 ? givenCoordinates.x : 0,
    y: givenCoordinates.y &gt;= 0 ? givenCoordinates.y : 0,
    width: givenCoordinates.width,
    height: givenCoordinates.height
  };
  var { width, height } = layer.getSubContainerConfigs();
  var allFoundSubcontainers = [];
  var xIndex = Math.floor( coordinates.x / width );
  var yIndex = Math.floor( coordinates.y / height );
  var x2 = coordinates.width ? coordinates.x + coordinates.width :  + coordinates.x;
  var y2 = coordinates.height ? coordinates.y + coordinates.height :  + coordinates.y;
  var widthIndex = Math.floor( x2 / width );
  var heightIndex = Math.floor( y2 / height );
  var subContainerList = layer.subContainerList;

  for (let thisXIndex = xIndex; thisXIndex &lt;= widthIndex; thisXIndex++) {
    if (thisXIndex &gt;= 0 &amp;&amp; subContainerList &amp;&amp; subContainerList[thisXIndex]) {
      for (let thisYIndex = yIndex; thisYIndex &lt;= heightIndex; thisYIndex++) {
        if (thisYIndex &gt;= 0 &amp;&amp; subContainerList[thisXIndex][thisYIndex]) {
          allFoundSubcontainers.push(subContainerList[thisXIndex][thisYIndex]);
        }
      }
    }
  }

  return allFoundSubcontainers;
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
